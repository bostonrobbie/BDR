<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outreach Command Center</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
<style>
:root {
    --bg-primary: #0a0b0f;
    --bg-card: #12131a;
    --bg-elevated: #1a1b26;
    --bg-hover: #1e2030;
    --border: #1e2030;
    --border-subtle: #161722;

    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #475569;

    --accent: #6366f1;
    --accent-hover: #818cf8;
    --accent-bg: rgba(99, 102, 241, 0.1);

    --success: #10b981;
    --success-bg: rgba(16, 185, 129, 0.1);
    --warning: #f59e0b;
    --warning-bg: rgba(245, 158, 11, 0.1);
    --error: #ef4444;
    --error-bg: rgba(239, 68, 68, 0.1);
    --info: #06b6d4;
    --info-bg: rgba(6, 182, 212, 0.1);

    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --transition: 150ms ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    font-size: 13px;
}

a { color: var(--accent-hover); text-decoration: none; cursor: pointer; }

/* Layout */
.shell { display: flex; height: 100vh; }

.sidebar {
    width: 240px;
    background: var(--bg-card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    box-shadow: inset -1px 0 0 rgba(0,0,0,0.2);
}

.sidebar-logo {
    padding: 20px;
    border-bottom: 1px solid var(--border);
}

.sidebar-logo strong {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-hover);
    display: block;
}

.sidebar-logo span {
    color: var(--text-muted);
    font-size: 11px;
    margin-top: 4px;
    display: block;
    letter-spacing: 0.5px;
}

.nav {
    flex: 1;
    padding: 12px 8px;
    overflow-y: auto;
}

.nav-section {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 14px 12px 8px;
    letter-spacing: 0.5px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 13px;
    color: var(--text-secondary);
    transition: all var(--transition);
    user-select: none;
    position: relative;
    margin: 2px 0;
    border-left: 3px solid transparent;
}

.nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.nav-item.active {
    background: var(--accent-bg);
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 500;
}

.nav-item .badge {
    margin-left: auto;
    background: var(--error);
    color: #fff;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}

.nav-sep {
    height: 1px;
    background: var(--border);
    margin: 8px 0;
}

.sidebar-status {
    padding: 14px;
    border-top: 1px solid var(--border);
    font-size: 11px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--success-bg);
    color: var(--success);
    border-radius: 16px;
    font-weight: 600;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.main {
    flex: 1;
    overflow-y: auto;
    background: var(--bg-primary);
}

.page {
    display: none;
    padding: 32px;
    max-width: 1600px;
    margin: 0 auto;
}

.page.active {
    display: block;
    animation: fadeIn 150ms ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.page-hdr {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
    flex-wrap: wrap;
    gap: 12px;
}

.page-hdr h1 {
    font-size: 28px;
    font-weight: 600;
    letter-spacing: -0.5px;
}

/* Typography */
h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

/* KPIs */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
}

.kpi {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px;
    position: relative;
    overflow: hidden;
    transition: all var(--transition);
}

.kpi:hover {
    border-color: var(--accent);
    background: var(--bg-elevated);
}

.kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-hover));
    opacity: 0;
    transition: opacity var(--transition);
}

.kpi:hover::before {
    opacity: 1;
}

.kpi-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    font-weight: 600;
}

.kpi-val {
    font-size: 28px;
    font-weight: 700;
    margin: 4px 0;
    color: var(--text-primary);
}

.kpi-sub {
    font-size: 12px;
    margin-top: 6px;
}

.kpi-sub.up { color: var(--success); }
.kpi-sub.dn { color: var(--error); }

/* Cards */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px;
    margin-bottom: 20px;
    transition: all var(--transition);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card:hover {
    border-color: var(--border-subtle);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.card h3 {
    margin-bottom: 16px;
}

.card canvas {
    max-height: 320px;
}

/* Grids */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
.grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

/* Tables */
.tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.tbl thead {
    background: var(--bg-elevated);
    position: sticky;
    top: 0;
}

.tbl thead th {
    text-align: left;
    padding: 12px 14px;
    border-bottom: 2px solid var(--border);
    color: var(--text-secondary);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    font-weight: 600;
    white-space: nowrap;
    user-select: none;
    transition: color var(--transition);
}

.tbl thead th:hover {
    color: var(--text-primary);
}

.tbl thead th.sorted::after {
    content: " ‚ñº";
    font-size: 8px;
}

.tbl thead th.sorted.asc::after {
    content: " ‚ñ≤";
}

.tbl tbody td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border-subtle);
}

.tbl tbody tr {
    transition: background var(--transition);
}

.tbl tbody tr:hover {
    background: var(--bg-elevated);
    cursor: pointer;
}

.tbl tbody tr:nth-child(even) {
    background: rgba(0, 0, 0, 0.05);
}

/* Tags */
.tag {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
}

.tag-hot { background: var(--error-bg); color: var(--error); }
.tag-warm { background: var(--warning-bg); color: var(--warning); }
.tag-std { background: var(--accent-bg); color: var(--accent); }
.tag-qa { background: var(--success-bg); color: var(--success); }
.tag-vp { background: var(--info-bg); color: var(--info); }
.tag-intent { background: var(--warning-bg); color: var(--warning); }

/* Buttons */
.btn {
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-elevated);
    color: var(--text-primary);
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    font-weight: 500;
}

.btn:hover {
    border-color: var(--accent);
    background: var(--bg-hover);
    color: var(--accent-hover);
}

.btn:active {
    transform: translateY(1px);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
}

.btn-primary:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
}

.btn-danger {
    background: var(--error);
    border-color: var(--error);
    color: #fff;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-success {
    background: var(--success);
    border-color: var(--success);
    color: #fff;
}

.btn-success:hover {
    background: #059669;
}

.btn-sm {
    padding: 5px 12px;
    font-size: 11px;
}

.btn-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

/* Forms */
.inp, .sel {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-family: inherit;
    transition: all var(--transition);
}

.inp:focus, .sel:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-bg);
}

.inp.err {
    border-color: var(--error);
    box-shadow: 0 0 0 2px var(--error-bg);
}

.form-row {
    margin-bottom: 16px;
}

.form-row label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 6px;
    font-weight: 500;
}

/* Filters Bar */
.filters-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.filters-bar label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

/* Tabs */
.tab-bar {
    display: flex;
    gap: 0;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
}

.tab-item {
    padding: 12px 18px;
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all var(--transition);
    user-select: none;
    font-weight: 500;
}

.tab-item:hover {
    color: var(--text-primary);
}

.tab-item.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Pipeline */
.pipeline-progress {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 22px;
    margin-bottom: 20px;
}

.phase-track {
    display: flex;
    gap: 8px;
    margin: 16px 0;
}

.phase-step {
    flex: 1;
    height: 40px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    transition: all 0.3s ease;
    background: var(--bg-elevated);
    color: var(--text-muted);
}

.phase-step.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 0 16px rgba(99, 102, 241, 0.4);
    animation: pulse 1.5s infinite;
}

.phase-step.done {
    background: var(--success);
    color: #fff;
}

.phase-step.failed {
    background: var(--error);
    color: #fff;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.progress-bar {
    height: 6px;
    background: var(--bg-elevated);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 12px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--success));
    transition: width 0.5s ease;
    border-radius: 3px;
}

.run-timer {
    font-size: 12px;
    color: var(--text-secondary);
    font-variant-numeric: tabular-nums;
    font-weight: 500;
}

/* Detail Panel */
.detail-panel {
    position: fixed;
    right: 0;
    top: 0;
    width: 540px;
    height: 100vh;
    background: var(--bg-card);
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 100;
    overflow-y: auto;
    padding: 24px;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
}

.detail-panel.open {
    transform: translateX(0);
}

.detail-panel h2 {
    font-size: 20px;
    margin-bottom: 6px;
}

.detail-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 20px;
    padding: 4px 8px;
    transition: color var(--transition);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
}

.detail-close:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

/* Action Items */
.action-item {
    display: flex;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    align-items: flex-start;
}

.action-item:last-child {
    border-bottom: none;
}

.action-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    font-weight: 600;
}

.action-icon.overdue {
    background: var(--error-bg);
    color: var(--error);
}

.action-icon.hot {
    background: var(--warning-bg);
    color: var(--warning);
}

.action-icon.stuck {
    background: var(--warning-bg);
    color: var(--warning);
}

.action-icon.signal {
    background: var(--accent-bg);
    color: var(--accent);
}

/* Signals */
.signal-card {
    background: var(--bg-elevated);
    border-left: 4px solid var(--warning);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    padding: 12px 14px;
    margin-bottom: 10px;
    transition: all var(--transition);
}

.signal-card:hover {
    border-left-color: var(--accent);
    background: var(--bg-hover);
}

.signal-card.buyer_intent {
    border-left-color: var(--warning);
}

.signal-card.funding {
    border-left-color: var(--success);
}

.signal-card.job_posting {
    border-left-color: var(--info);
}

.signal-card.leadership_change {
    border-left-color: #a855f7;
}

.signal-card.product_launch {
    border-left-color: var(--warning);
}

.sig-type {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sig-detail {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.sig-age {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
}

.signal-card.actioned {
    opacity: 0.6;
    border-left-color: var(--success);
}

/* Dialogs */
.confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.confirm-overlay.show {
    display: flex;
}

.confirm-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px;
    width: 420px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.confirm-box h3 {
    font-size: 18px;
    margin-bottom: 12px;
    font-weight: 600;
}

.confirm-box p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
}

.confirm-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Modals */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 24px;
    width: 440px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.modal-content h3 {
    font-size: 18px;
    margin-bottom: 16px;
    font-weight: 600;
}

/* Empty State */
.empty {
    padding: 48px 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
}

.empty-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.6;
}

.empty strong {
    display: block;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

/* Toast */
#toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 300;
    pointer-events: none;
}

.toast {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px 18px;
    font-size: 13px;
    margin-bottom: 12px;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: auto;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    border-left: 4px solid var(--accent);
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast.success {
    border-left-color: var(--success);
}

.toast.error {
    border-left-color: var(--error);
}

.toast.warning {
    border-left-color: var(--warning);
}

/* Spinner */
.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--accent-hover);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Badge */
.badge-gn {
    background: var(--success-bg);
    color: var(--success);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.badge-rd {
    background: var(--error-bg);
    color: var(--error);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.badge-yl {
    background: var(--warning-bg);
    color: var(--warning);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

/* Approval Cards */
.approval-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 14px;
    transition: all 0.2s ease;
}

.approval-card.approved {
    border-color: var(--success);
    opacity: 0.7;
    background: rgba(16, 185, 129, 0.05);
}

.approval-card.rejected {
    border-color: var(--error);
    opacity: 0.6;
    background: rgba(239, 68, 68, 0.05);
}

.approval-card .msg-subj {
    font-size: 13px;
    font-weight: 600;
    color: var(--warning);
    margin-bottom: 6px;
}

.approval-card .msg-body {
    font-size: 12px;
    color: var(--text-secondary);
    white-space: pre-wrap;
    line-height: 1.6;
    margin: 10px 0;
    padding: 12px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    min-height: 70px;
    outline: none;
    transition: border-color var(--transition);
    font-family: 'Courier New', monospace;
}

.approval-card .msg-body.editing {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-bg);
}

.approval-card .msg-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    font-size: 11px;
    color: var(--text-muted);
    align-items: center;
}

.msg-word-count {
    font-variant-numeric: tabular-nums;
    padding: 2px 8px;
    background: var(--bg-elevated);
    border-radius: 4px;
}

.msg-save-indicator {
    color: var(--success);
    font-size: 11px;
    opacity: 0;
    transition: opacity 0.3s ease;
    font-weight: 600;
}

.msg-save-indicator.show {
    opacity: 1;
}

/* Flow Grid */
.flow-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.flow-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px;
    transition: all var(--transition);
}

.flow-card:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.1);
}

.flow-card h3 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.flow-card .desc {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    line-height: 1.5;
}

.flow-card .run-count {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 14px;
}

/* Timeline */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    display: flex;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    background: var(--accent-bg);
    color: var(--accent);
}

.timeline-content {
    flex: 1;
}

.timeline-content h4 {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
}

.timeline-content p {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.timeline-content .time {
    font-size: 11px;
    color: var(--text-muted);
}

/* Error Message */
.err-msg {
    color: var(--error);
    font-size: 11px;
    margin-top: 4px;
    display: none;
}

.err-msg.show {
    display: block;
}

/* Responsive */
@media (max-width: 1200px) {
    .grid2, .grid3, .grid4 {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 900px) {
    .sidebar {
        width: 70px;
    }
    .sidebar-logo span,
    .nav-item span:not(.badge),
    .nav-section {
        display: none;
    }
    .nav-item {
        justify-content: center;
        padding: 10px;
    }
}

@media (max-width: 768px) {
    .sidebar {
        display: none;
    }
    .page {
        padding: 16px;
    }
    .page-hdr {
        flex-direction: column;
        align-items: flex-start;
    }
    .page-hdr h1 {
        font-size: 24px;
    }
    .kpi-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    .grid2, .grid3, .grid4 {
        grid-template-columns: 1fr;
    }
    .card {
        padding: 16px;
    }
    .detail-panel {
        width: 100%;
    }
    .filters-bar {
        flex-direction: column;
    }
    .filters-bar label,
    .filters-bar select,
    .filters-bar input {
        width: 100%;
    }
    .tbl {
        font-size: 12px;
    }
    .tbl thead th {
        padding: 10px 8px;
        font-size: 10px;
    }
    .tbl tbody td {
        padding: 10px 8px;
    }
}

@media print {
    .sidebar, .toast, .confirm-overlay, .detail-panel {
        display: none !important;
    }
    .main {
        overflow: visible;
    }
    .page {
        max-width: none;
    }
}
</style>
</head>
<body>

<div class="shell">
<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-logo">
        <strong>OCC</strong>
        <span>Outreach Command Center</span>
    </div>
    <nav class="nav">
        <div class="nav-section">Overview</div>
        <div class="nav-item active" onclick="showPage('home')">
            <span>üè†</span>
            <span>Home</span>
            <span class="badge" id="badge-actions" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="showPage('pipeline')">
            <span>üìä</span>
            <span>Pipeline</span>
        </div>
        <div class="nav-item" onclick="showPage('activity')">
            <span>‚è±</span>
            <span>Activity</span>
        </div>

        <div class="nav-sep"></div>
        <div class="nav-section">Workflows</div>
        <div class="nav-item" onclick="showPage('flows')">
            <span>‚ñ∂</span>
            <span>Flows</span>
        </div>
        <div class="nav-item" onclick="showPage('launch')">
            <span>üöÄ</span>
            <span>Launch Batch</span>
        </div>
        <div class="nav-item" onclick="showPage('approval')">
            <span>‚úì</span>
            <span>Approval</span>
            <span class="badge" id="badge-approval" style="display:none">0</span>
        </div>

        <div class="nav-sep"></div>
        <div class="nav-section">Data</div>
        <div class="nav-item" onclick="showPage('accounts')">
            <span>üè¢</span>
            <span>Accounts</span>
        </div>
        <div class="nav-item" onclick="showPage('contacts')">
            <span>üë§</span>
            <span>Contacts</span>
        </div>
        <div class="nav-item" onclick="showPage('drafts')">
            <span>‚úé</span>
            <span>Drafts</span>
        </div>

        <div class="nav-sep"></div>
        <div class="nav-section">Analytics</div>
        <div class="nav-item" onclick="showPage('intelligence')">
            <span>üìà</span>
            <span>Intelligence</span>
        </div>
        <div class="nav-item" onclick="showPage('experiments')">
            <span>‚äï</span>
            <span>Experiments</span>
        </div>
        <div class="nav-item" onclick="showPage('signals')">
            <span>‚ö°</span>
            <span>Signals</span>
        </div>

        <div class="nav-sep"></div>
        <div class="nav-section">System</div>
        <div class="nav-item" onclick="showPage('agents')">
            <span>ü§ñ</span>
            <span>Agent Logs</span>
        </div>
        <div class="nav-item" onclick="showPage('email')">
            <span>‚úâ</span>
            <span>Email Channel</span>
        </div>
        <div class="nav-item" onclick="showPage('swarm')">
            <span>üêù</span>
            <span>Agent Swarm</span>
        </div>
        <div class="nav-item" onclick="showPage('health')">
            <span>üíö</span>
            <span>System Health</span>
        </div>
        <div class="nav-item" onclick="showPage('settings')">
            <span>‚öô</span>
            <span>Settings</span>
        </div>
    </nav>
    <div class="sidebar-status">
        <div class="status-badge" id="mode-badge">
            <span class="status-dot"></span>
            <span>Online</span>
        </div>
        <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted);" id="api-status">API not connected</div>
    </div>
</div>

<!-- Main Content -->
<div class="main">

<!-- HOME -->
<div class="page active" id="page-home">
    <div class="page-hdr">
        <h1>Dashboard</h1>
        <button class="btn btn-sm" onclick="refreshAll()">Refresh</button>
    </div>
    <div class="kpi-row" id="kpi-row"></div>

    <div id="active-run-container" style="display:none;">
        <div class="pipeline-progress" id="pipeline-progress">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong id="run-title" style="font-size:16px;">Pipeline Running</strong>
                    <span id="run-status" style="margin-left:12px;font-size:13px;color:var(--text-secondary);"></span>
                </div>
                <div style="display:flex;gap:12px;align-items:center;">
                    <span class="run-timer" id="run-timer">0:00</span>
                    <button class="btn btn-sm btn-danger" id="cancel-run-btn" onclick="cancelRun()">Cancel</button>
                </div>
            </div>
            <div class="phase-track" id="phase-track"></div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
            <div id="phase-detail" style="font-size:12px;color:var(--text-muted);margin-top:8px;"></div>
        </div>
    </div>

    <div class="grid2">
        <div class="card">
            <h3>Action Queue</h3>
            <div id="action-queue"><div class="empty">Loading...</div></div>
        </div>
        <div class="card">
            <h3>Pipeline Funnel</h3>
            <canvas id="chart-funnel"></canvas>
        </div>
    </div>

    <div class="grid2">
        <div class="card">
            <h3>Reply Rate by Persona</h3>
            <canvas id="chart-persona"></canvas>
        </div>
        <div class="card">
            <h3>Reply Rate by Vertical</h3>
            <canvas id="chart-vertical"></canvas>
        </div>
    </div>
</div>

<!-- PIPELINE -->
<div class="page" id="page-pipeline">
    <div class="page-hdr">
        <h1>Prospect Pipeline</h1>
        <div class="btn-group">
            <button class="btn btn-sm" onclick="showExportModal()">Export CSV</button>
            <button class="btn btn-sm" onclick="refreshPipeline()">Refresh</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Priority</label>
        <select class="sel" id="f-priority" onchange="filterPipeline()" style="width:140px;">
            <option value="">All</option>
            <option value="5">Hot (5)</option>
            <option value="4">Warm (4+)</option>
            <option value="3">Standard (3+)</option>
        </select>

        <label>Persona</label>
        <select class="sel" id="f-persona" onchange="filterPipeline()" style="width:140px;">
            <option value="">All</option>
            <option value="qa_leader">QA Leader</option>
            <option value="vp_eng">VP Eng</option>
        </select>

        <label>Stage</label>
        <select class="sel" id="f-stage" onchange="filterPipeline()" style="width:180px;">
            <option value="">All</option>
            <option value="new">New</option>
            <option value="touch_1_sent">Touch 1</option>
            <option value="touch_3_sent">Touch 3</option>
            <option value="replied">Replied</option>
            <option value="meeting_booked">Meeting</option>
            <option value="not_interested">Not Interested</option>
        </select>

        <label>Search</label>
        <input class="inp" id="f-search" placeholder="Name, company..." oninput="filterPipeline()" style="width:200px;">

        <span id="pipeline-count" style="font-size:11px;color:var(--text-muted);margin-left:auto;font-weight:500;"></span>
    </div>

    <div style="overflow-x:auto;">
        <table class="tbl" id="pipeline-table">
            <thead>
                <tr>
                    <th onclick="sortPipeline('priority_score')">Pri</th>
                    <th onclick="sortPipeline('name')">Name</th>
                    <th>Title</th>
                    <th onclick="sortPipeline('company_name')">Company</th>
                    <th>Persona</th>
                    <th onclick="sortPipeline('stage')">Stage</th>
                    <th onclick="sortPipeline('personalization_score')">P-Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="pipeline-body"></tbody>
        </table>
    </div>
</div>

<!-- ACTIVITY -->
<div class="page" id="page-activity">
    <div class="page-hdr">
        <h1>Activity Timeline</h1>
        <div class="btn-group">
            <select class="sel" id="activity-channel" onchange="loadActivity()" style="width:140px;">
                <option value="">All Channels</option>
                <option value="linkedin">LinkedIn</option>
                <option value="email">Email</option>
                <option value="phone">Phone</option>
            </select>
            <input class="inp" id="activity-search" placeholder="Search..." oninput="loadActivity()" style="width:180px;">
            <button class="btn btn-sm" onclick="loadActivity()">Refresh</button>
        </div>
    </div>
    <div class="kpi-row" id="activity-kpis"></div>
    <div class="timeline" id="activity-timeline"><div class="empty">Loading...</div></div>
</div>

<!-- FLOWS -->
<div class="page" id="page-flows">
    <div class="page-hdr"><h1>Workflows</h1></div>
    <div class="flow-grid" id="flow-cards-grid"></div>
    <div class="card">
        <h3>Recent Runs</h3>
        <div style="overflow-x:auto;">
            <table class="tbl" id="flows-runs-table">
                <thead><tr><th>Flow</th><th>Status</th><th>Steps</th><th>Duration</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="flows-runs-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- LAUNCH BATCH -->
<div class="page" id="page-launch">
    <div class="page-hdr"><h1>Launch New Batch</h1></div>
    <div class="grid2">
        <div class="card">
            <h3>Batch Configuration</h3>
            <div id="launch-error" style="display:none;background:var(--error-bg);border:1px solid var(--error);border-radius:var(--radius-md);padding:12px;margin-bottom:14px;font-size:12px;color:var(--error);"></div>

            <div class="form-row">
                <label>Batch Number</label>
                <input class="inp" id="launch-batch-num" type="number" min="1" value="1" style="width:100%;">
                <div class="err-msg" id="err-batch-num">Batch number must be >= 1</div>
            </div>

            <div class="form-row">
                <label>Target Prospects (1-100)</label>
                <input class="inp" id="launch-target" type="number" min="1" max="100" value="25" style="width:100%;">
                <div class="err-msg" id="err-target">Must be between 1 and 100</div>
            </div>

            <div class="form-row">
                <label>A/B Variable</label>
                <select class="sel" id="launch-ab-var" style="width:100%;">
                    <option value="pain_hook">Pain Hook</option>
                    <option value="proof_point_style">Proof Point Style</option>
                    <option value="opener_style">Opener Style</option>
                    <option value="ask_intensity">Ask Intensity</option>
                    <option value="message_length">Message Length</option>
                </select>
            </div>

            <div class="form-row">
                <label>Group A Description</label>
                <input class="inp" id="launch-group-a" value="Flaky/brittle tests angle" style="width:100%;">
            </div>

            <div class="form-row">
                <label>Group B Description</label>
                <input class="inp" id="launch-group-b" value="Release velocity angle" style="width:100%;">
            </div>

            <div class="form-row">
                <label>Saved Search URL (optional)</label>
                <input class="inp" id="launch-search-url" placeholder="https://www.linkedin.com/sales/search/..." style="width:100%;">
            </div>

            <div class="form-row">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--text-secondary);">
                    <input type="checkbox" id="launch-auto-approve">
                    <span>Auto-approve messages (skip approval gate)</span>
                </label>
            </div>

            <div style="margin-top:20px;display:flex;gap:8px;">
                <button class="btn btn-primary" onclick="launchBatch()" id="launch-btn">Launch Pipeline</button>
            </div>
        </div>

        <div class="card">
            <h3>Previous Batches</h3>
            <div id="batch-list"><div class="empty">Loading...</div></div>
        </div>
    </div>

    <div class="card" id="pre-brief-card" style="display:none;">
        <h3>Pre-Brief (What's Working)</h3>
        <div id="pre-brief-content"></div>
    </div>
</div>

<!-- APPROVAL -->
<div class="page" id="page-approval">
    <div class="page-hdr">
        <h1>Message Approval Queue</h1>
        <div class="btn-group">
            <button class="btn btn-success btn-sm" onclick="confirmBulk('approve')">Approve All</button>
            <button class="btn btn-danger btn-sm" onclick="confirmBulk('reject')">Reject All</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Filter</label>
        <select class="sel" id="approval-filter" onchange="loadApprovalQueue()" style="width:140px;">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="">All</option>
        </select>
        <span id="approval-count" style="font-size:11px;color:var(--text-muted);margin-left:auto;font-weight:500;"></span>
    </div>

    <div id="approval-queue"><div class="empty">No messages pending approval.</div></div>
</div>

<!-- ACCOUNTS -->
<div class="page" id="page-accounts">
    <div class="page-hdr">
        <h1>Accounts</h1>
        <div class="btn-group">
            <input class="inp" id="accounts-search" placeholder="Search..." oninput="loadAccounts()" style="width:200px;">
            <button class="btn btn-sm btn-primary" onclick="showAddAccountModal()">+ Add Account</button>
            <button class="btn btn-sm" onclick="loadAccounts()">Refresh</button>
        </div>
    </div>

    <div style="overflow-x:auto;">
        <table class="tbl" id="accounts-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Domain</th>
                    <th>Industry</th>
                    <th>Employees</th>
                    <th>Tier</th>
                    <th>Intent</th>
                    <th>Contacts</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="accounts-body"></tbody>
        </table>
    </div>
</div>

<!-- CONTACTS -->
<div class="page" id="page-contacts">
    <div class="page-hdr">
        <h1>Contacts</h1>
        <div class="btn-group">
            <button class="btn btn-sm btn-primary" onclick="showImportContactsModal()">Import</button>
            <button class="btn btn-sm btn-primary" onclick="showAddContactModal()">+ Add Contact</button>
            <button class="btn btn-sm" onclick="loadContacts()">Refresh</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Priority</label>
        <select class="sel" id="c-priority" onchange="loadContacts()" style="width:140px;">
            <option value="">All</option>
            <option value="5">Hot</option>
            <option value="4">Warm</option>
            <option value="3">Standard</option>
        </select>

        <label>Persona</label>
        <select class="sel" id="c-persona" onchange="loadContacts()" style="width:140px;">
            <option value="">All</option>
            <option value="qa_leader">QA</option>
            <option value="vp_eng">VP Eng</option>
        </select>

        <label>Has Email</label>
        <select class="sel" id="c-email" onchange="loadContacts()" style="width:140px;">
            <option value="">All</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
        </select>

        <label>Search</label>
        <input class="inp" id="c-search" placeholder="Name, company..." oninput="loadContacts()" style="width:200px;">

        <span id="contacts-count" style="font-size:11px;color:var(--text-muted);margin-left:auto;font-weight:500;"></span>
    </div>

    <div style="overflow-x:auto;">
        <table class="tbl" id="contacts-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Title</th>
                    <th>Company</th>
                    <th>Email</th>
                    <th>Priority</th>
                    <th>Persona</th>
                    <th>Stage</th>
                    <th>P-Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contacts-body"></tbody>
        </table>
    </div>
</div>

<!-- DRAFTS -->
<div class="page" id="page-drafts">
    <div class="page-hdr">
        <h1>Message Drafts</h1>
        <div class="btn-group">
            <select class="sel" id="drafts-channel" onchange="loadDrafts()" style="width:140px;">
                <option value="">All Channels</option>
                <option value="linkedin">LinkedIn</option>
                <option value="email">Email</option>
            </select>

            <select class="sel" id="drafts-status" onchange="loadDrafts()" style="width:140px;">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="approved">Approved</option>
                <option value="sent">Sent</option>
            </select>

            <input class="inp" id="drafts-search" placeholder="Search..." oninput="loadDrafts()" style="width:180px;">
            <button class="btn btn-sm" onclick="loadDrafts()">Refresh</button>
        </div>
    </div>
    <div class="kpi-row" id="drafts-kpis"></div>
    <div id="drafts-list"><div class="empty">Loading...</div></div>
</div>

<!-- INTELLIGENCE -->
<div class="page" id="page-intelligence">
    <div class="page-hdr">
        <h1>Intelligence</h1>
        <div class="btn-group">
            <button class="btn btn-sm" onclick="window.print()">Print</button>
            <button class="btn btn-sm" onclick="loadIntelligence()">Refresh</button>
        </div>
    </div>

    <div class="kpi-row" id="intel-kpis"></div>

    <div class="tab-bar" id="intel-tabs">
        <div class="tab-item active" onclick="showIntelTab('breakdowns')">Breakdowns</div>
        <div class="tab-item" onclick="showIntelTab('trends')">Trends</div>
        <div class="tab-item" onclick="showIntelTab('ab')">A/B Results</div>
        <div class="tab-item" onclick="showIntelTab('top')">Top Messages</div>
    </div>

    <div class="tab-content active" id="intel-tab-breakdowns">
        <div class="grid2">
            <div class="card"><h3>Reply Rate by Persona</h3><canvas id="intel-persona"></canvas></div>
            <div class="card"><h3>Reply Rate by Vertical</h3><canvas id="intel-vertical"></canvas></div>
        </div>
        <div class="grid2">
            <div class="card"><h3>Reply Rate by Proof Point</h3><canvas id="intel-proof"></canvas></div>
            <div class="card"><h3>Reply Rate by Personalization Score</h3><canvas id="intel-pscore"></canvas></div>
        </div>
    </div>

    <div class="tab-content" id="intel-tab-trends">
        <div class="card"><h3>Batch Performance Over Time</h3><canvas id="intel-trend"></canvas></div>
        <div class="grid2">
            <div class="card"><h3>Batch Funnel Comparison</h3><canvas id="intel-funnel-compare"></canvas></div>
            <div class="card"><h3>Reply Rate Trend by Batch</h3><canvas id="intel-reply-trend"></canvas></div>
        </div>
    </div>

    <div class="tab-content" id="intel-tab-ab">
        <div class="card"><h3>A/B Test Results Across Batches</h3><div id="intel-ab-table" style="overflow-x:auto;"></div></div>
    </div>

    <div class="tab-content" id="intel-tab-top">
        <div class="card"><h3>Top Performing Messages</h3><div id="intel-top-messages"><div class="empty">Reply data needed to rank messages</div></div></div>
    </div>
</div>

<!-- EXPERIMENTS -->
<div class="page" id="page-experiments">
    <div class="page-hdr"><h1>A/B Experiments</h1></div>
    <div id="experiments-list"><div class="empty">Loading...</div></div>
    <div class="card" style="margin-top:20px;"><h3>A/B Head-to-Head Comparison</h3><canvas id="ab-head-to-head"></canvas></div>
</div>

<!-- SIGNALS -->
<div class="page" id="page-signals">
    <div class="page-hdr">
        <h1>Signals & Re-Engagement</h1>
        <div class="btn-group">
            <button class="btn btn-sm" onclick="showAddSignalForm()">+ Add Signal</button>
            <button class="btn btn-sm" onclick="loadSignals()">Refresh</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Type</label>
        <select class="sel" id="sig-filter" onchange="loadSignals()" style="width:180px;">
            <option value="">All</option>
            <option value="buyer_intent">Buyer Intent</option>
            <option value="hiring_signal">Hiring</option>
            <option value="funding">Funding</option>
            <option value="competitor_tool">Competitor Tool</option>
            <option value="recently_hired">Recently Hired</option>
            <option value="manual">Manual</option>
        </select>
        <label><input type="checkbox" id="sig-show-actioned" onchange="loadSignals()"> Show actioned</label>
    </div>

    <div id="signals-list"><div class="empty">Loading...</div></div>

    <div id="add-signal-form" style="display:none;" class="card">
        <h3>Add Manual Signal</h3>
        <div class="form-row">
            <label>Contact ID</label>
            <input class="inp" id="sig-contact-id" style="width:100%;" placeholder="Contact ID">
        </div>
        <div class="form-row">
            <label>Signal Type</label>
            <select class="sel" id="sig-new-type" style="width:100%;">
                <option value="buyer_intent">Buyer Intent</option>
                <option value="hiring_signal">Hiring Signal</option>
                <option value="funding">Funding</option>
                <option value="competitor_tool">Competitor Tool</option>
                <option value="manual">Manual / Other</option>
            </select>
        </div>
        <div class="form-row">
            <label>Description</label>
            <input class="inp" id="sig-description" style="width:100%;" placeholder="What did you observe?">
        </div>
        <button class="btn btn-primary btn-sm" onclick="addSignal()">Create Signal</button>
    </div>
</div>

<!-- AGENT LOGS -->
<div class="page" id="page-agents">
    <div class="page-hdr">
        <h1>Agent Run History</h1>
        <button class="btn btn-sm" onclick="loadAgentRuns()">Refresh</button>
    </div>
    <div style="overflow-x:auto;">
        <table class="tbl">
            <thead>
                <tr><th>Agent</th><th>Type</th><th>Status</th><th>Tokens</th><th>Duration</th><th>Started</th></tr>
            </thead>
            <tbody id="agent-runs-body"></tbody>
        </table>
    </div>
</div>

<!-- EMAIL CHANNEL -->
<div class="page" id="page-email">
    <div class="page-hdr">
        <h1>Email Channel</h1>
        <div style="display:flex;gap:10px;">
            <button class="btn btn-sm" onclick="loadEmailPage()">Refresh</button>
            <button class="btn btn-sm btn-primary" onclick="showAddIdentity()">Add Sender</button>
        </div>
    </div>

    <div class="kpi-row" id="email-kpis"></div>

    <div class="tab-bar" style="margin-bottom:16px;">
        <button class="btn btn-sm active" onclick="showEmailTab('identities',this)">Sender Accounts</button>
        <button class="btn btn-sm" onclick="showEmailTab('suppression',this)">Suppression List</button>
        <button class="btn btn-sm" onclick="showEmailTab('events',this)">Events Log</button>
        <button class="btn btn-sm" onclick="showEmailTab('pacing',this)">Pacing Rules</button>
    </div>

    <div id="email-tab-identities" class="email-tab"></div>
    <div id="email-tab-suppression" class="email-tab" style="display:none"></div>
    <div id="email-tab-events" class="email-tab" style="display:none"></div>
    <div id="email-tab-pacing" class="email-tab" style="display:none"></div>

    <div id="add-identity-modal" class="modal">
        <div class="modal-content">
            <h3>Add Sender Account</h3>
            <div style="display:grid;gap:12px;margin:16px 0;">
                <input class="inp" id="new-email" placeholder="Email address" />
                <input class="inp" id="new-display-name" placeholder="Display name (e.g. Rob Gorham)" />
                <input class="inp" id="new-daily-limit" type="number" value="25" placeholder="Daily send limit" />
                <input class="inp" id="new-warmup-cap" type="number" value="5" placeholder="Warmup daily cap" />
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn btn-sm" onclick="hideAddIdentity()">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="createIdentity()">Add</button>
            </div>
        </div>
    </div>

    <div id="add-suppression-modal" class="modal">
        <div class="modal-content">
            <h3>Add to Suppression List</h3>
            <div style="display:grid;gap:12px;margin:16px 0;">
                <input class="inp" id="sup-email" placeholder="Email to suppress" />
                <select class="sel" id="sup-reason">
                    <option value="opt_out">Opt-out requested</option>
                    <option value="hard_bounce">Hard bounce</option>
                    <option value="do_not_contact">Do not contact</option>
                    <option value="competitor">Competitor</option>
                    <option value="manual">Manual removal</option>
                </select>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn btn-sm" onclick="document.getElementById('add-suppression-modal').style.display='none'">Cancel</button>
                <button class="btn btn-sm btn-primary" onclick="addSuppression()">Suppress</button>
            </div>
        </div>
    </div>
</div>

<!-- AGENT SWARM -->
<div class="page" id="page-swarm">
    <div class="page-hdr">
        <h1>Agent Swarm</h1>
        <div style="display:flex;gap:10px;">
            <button class="btn btn-sm" onclick="loadSwarmPage()">Refresh</button>
            <button class="btn btn-sm btn-primary" onclick="showLaunchSwarm()">Launch Swarm</button>
        </div>
    </div>

    <div class="kpi-row" id="swarm-kpis"></div>

    <div id="swarm-active" class="card" style="margin-bottom:12px;display:none">
        <h3>Active Swarm Run</h3>
        <div id="swarm-progress"></div>
    </div>

    <div class="card">
        <h3>Run History</h3>
        <div id="swarm-history"></div>
    </div>

    <div id="launch-swarm-modal" class="modal">
        <div class="modal-content">
            <h3>Launch Agent Swarm</h3>
            <div style="display:grid;gap:12px;margin:16px 0;">
                <div>
                    <label style="font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:6px;display:block;">Batch</label>
                    <select class="sel" id="swarm-batch" style="width:100%;"></select>
                </div>
                <div>
                    <label style="font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:6px;display:block;">Max Parallel Workers</label>
                    <input class="inp" id="swarm-workers" type="number" value="3" min="1" max="5" style="width:100%;" />
                </div>
                <div>
                    <label style="font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:8px;display:block;">Channels</label>
                    <div style="display:flex;gap:14px;">
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="ch-linkedin" checked />
                            <span>LinkedIn</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="ch-email" checked />
                            <span>Email</span>
                        </label>
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn btn-sm" onclick="document.getElementById('launch-swarm-modal').style.display='none'">Cancel</button>
                <button class="btn btn-sm btn-primary" id="btn-launch-swarm" onclick="launchSwarm()">Launch</button>
            </div>
        </div>
    </div>
</div>

<!-- SYSTEM HEALTH -->
<div class="page" id="page-health">
    <div class="page-hdr">
        <h1>System Health</h1>
        <button class="btn btn-sm" onclick="loadHealthPage()">Refresh</button>
    </div>

    <div class="kpi-row" id="health-kpis"></div>

    <div class="card">
        <h3>Feature Flags</h3>
        <div id="feature-flags"></div>
    </div>

    <div class="card">
        <h3>Database Tables</h3>
        <div id="table-counts"></div>
    </div>

    <div class="card">
        <h3>Recent Errors</h3>
        <div id="recent-errors"></div>
    </div>

    <div class="card">
        <h3>Daily Summary</h3>
        <div id="daily-insights"></div>
    </div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
    <div class="page-hdr"><h1>Settings</h1></div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="showSettingsTab('general')">General</div>
        <div class="tab-item" onclick="showSettingsTab('email')">Email Setup</div>
        <div class="tab-item" onclick="showSettingsTab('flags')">Feature Flags</div>
        <div class="tab-item" onclick="showSettingsTab('api')">API</div>
    </div>

    <div class="tab-content active" id="settings-tab-general">
        <div class="card">
            <h3>User Settings</h3>
            <div class="form-row">
                <label>User Name</label>
                <input class="inp" id="settings-name" style="width:100%;" placeholder="Your name">
            </div>
            <div class="form-row">
                <label>Default Volume Cap (prospects per batch)</label>
                <input class="inp" id="settings-volume" type="number" value="25" style="width:100%;">
            </div>
            <div class="form-row">
                <label>Quality Bar Level</label>
                <select class="sel" id="settings-quality" style="width:100%;">
                    <option value="high">High (strictest)</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low (fastest)</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm" onclick="saveGeneralSettings()">Save</button>
        </div>
    </div>

    <div class="tab-content" id="settings-tab-email">
        <div class="card">
            <h3>Sender Health Checklist</h3>
            <div id="sender-health-checklist"></div>
        </div>
        <div class="card">
            <h3>Sender Identities</h3>
            <div id="sender-identities-list"></div>
            <button class="btn btn-primary btn-sm" onclick="showAddIdentity()" style="margin-top:12px;">+ Add Sender</button>
        </div>
    </div>

    <div class="tab-content" id="settings-tab-flags">
        <div class="card">
            <h3>Feature Flags</h3>
            <div id="settings-flags-list"></div>
        </div>
    </div>

    <div class="tab-content" id="settings-tab-api">
        <div class="card">
            <h3>API Status</h3>
            <div style="padding:14px 0;">
                <div style="margin-bottom:14px;">
                    <span style="color:var(--text-secondary);font-weight:500;">API URL:</span>
                    <strong id="api-url-display" style="font-family:monospace;font-size:12px;margin-left:8px;"></strong>
                </div>
                <div>
                    <span style="color:var(--text-secondary);font-weight:500;">Status:</span>
                    <span id="api-status-display" class="badge-gn" style="margin-left:8px;">Online</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Database Tables</h3>
            <div id="settings-table-counts"></div>
        </div>
    </div>
</div>

</div><!-- /main -->
</div><!-- /shell -->

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Dialogs -->
<div class="confirm-overlay" id="confirm-dialog">
    <div class="confirm-box">
        <h3 id="confirm-title">Confirm</h3>
        <p id="confirm-message">Are you sure?</p>
        <div class="confirm-actions">
            <button class="btn btn-sm" onclick="closeConfirm()">Cancel</button>
            <button class="btn btn-sm btn-primary" id="confirm-yes" onclick="">Confirm</button>
        </div>
    </div>
</div>

<div class="confirm-overlay" id="export-modal">
    <div class="confirm-box" style="width:540px;">
        <h3>Export to CSV</h3>
        <div class="form-row" style="margin-top:16px;">
            <label>Batch</label>
            <select class="sel" id="export-batch" style="width:100%;"><option value="">All contacts</option></select>
        </div>
        <div class="form-row">
            <label>Min Priority</label>
            <select class="sel" id="export-pri" style="width:100%;">
                <option value="">Any</option>
                <option value="4">4+ (Warm/Hot)</option>
                <option value="5">5 (Hot only)</option>
            </select>
        </div>
        <div class="form-row">
            <label>Persona</label>
            <select class="sel" id="export-persona" style="width:100%;">
                <option value="">All</option>
                <option value="qa_leader">QA Leaders</option>
                <option value="vp_eng">VP Eng</option>
            </select>
        </div>
        <div class="form-row">
            <label>Columns (comma-separated, or leave blank for all)</label>
            <input class="inp" id="export-columns" style="width:100%;" placeholder="first_name,last_name,title,email,company,stage...">
        </div>
        <div class="confirm-actions">
            <button class="btn btn-sm" onclick="closeExportModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="doExport()">Download CSV</button>
        </div>
    </div>
</div>

<div id="add-account-modal" class="modal">
    <div class="modal-content">
        <h3>Add Account</h3>
        <div style="display:grid;gap:12px;margin:16px 0;">
            <input class="inp" id="new-account-name" placeholder="Company name" />
            <input class="inp" id="new-account-domain" placeholder="Domain (e.g. acme.com)" />
            <input class="inp" id="new-account-industry" placeholder="Industry" />
            <input class="inp" id="new-account-employees" type="number" placeholder="Employee count" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn btn-sm" onclick="closeAddAccountModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="addAccount()">Create</button>
        </div>
    </div>
</div>

<div id="add-contact-modal" class="modal">
    <div class="modal-content">
        <h3>Add Contact</h3>
        <div style="display:grid;gap:12px;margin:16px 0;">
            <input class="inp" id="new-contact-first" placeholder="First name" />
            <input class="inp" id="new-contact-last" placeholder="Last name" />
            <input class="inp" id="new-contact-title" placeholder="Title" />
            <input class="inp" id="new-contact-company" placeholder="Company" />
            <input class="inp" id="new-contact-email" placeholder="Email" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn btn-sm" onclick="closeAddContactModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="addContact()">Create</button>
        </div>
    </div>
</div>

<div id="import-contacts-modal" class="modal">
    <div class="modal-content" style="width:640px;">
        <h3>Import Contacts</h3>
        <div class="tab-bar" style="margin-top:16px;margin-bottom:12px;">
            <div class="tab-item active" onclick="showImportTab('paste')">Paste URLs</div>
            <div class="tab-item" onclick="showImportTab('csv')">CSV Upload</div>
        </div>
        <div id="import-tab-paste" class="tab-content active">
            <textarea class="inp" id="import-urls" style="width:100%;height:160px;resize:vertical;font-family:monospace;font-size:12px;" placeholder="Paste LinkedIn profile URLs, one per line..."></textarea>
        </div>
        <div id="import-tab-csv" class="tab-content" style="display:none;">
            <input type="file" id="import-csv-file" accept=".csv" style="margin-bottom:12px;" />
            <div style="font-size:11px;color:var(--text-muted);">Expected columns: first_name, last_name, title, company, email, linkedin_url</div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button class="btn btn-sm" onclick="closeImportContactsModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="importContacts()">Import</button>
        </div>
    </div>
</div>

<script>
const API = window.location.origin;
let apiOnline = false;
let contacts = [], messages = [], batches = [];
let activeRunId = null, sseSource = null, runStartTime = null, timerInterval = null;
const charts = {};
let pipelineSortCol = 'priority_score', pipelineSortDir = 'desc';

async function api(path, opts = {}) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    try {
        const r = await fetch(API + path, {
            headers: {'Content-Type':'application/json', ...opts.headers},
            ...opts,
            signal: controller.signal,
        });
        clearTimeout(timeout);
        if (!r.ok) {
            const err = await r.json().catch(() => ({detail: r.statusText}));
            throw new Error(err.detail || `HTTP ${r.status}`);
        }
        if (r.headers.get('content-type')?.includes('json')) return r.json();
        return r.text();
    } catch(e) {
        clearTimeout(timeout);
        if (e.name !== 'AbortError') console.warn('API error:', path, e.message);
        return null;
    }
}

async function apiPost(path, body, method='POST') {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 15000);
    try {
        const r = await fetch(API + path, {
            method,
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
            signal: controller.signal,
        });
        clearTimeout(timeout);
        const data = await r.json().catch(() => null);
        if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);
        return data;
    } catch(e) {
        clearTimeout(timeout);
        return {_error: true, message: e.message};
    }
}

function showToast(msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

(async function init() {
    const health = await api('/api/health');
    if (health && health.status === 'healthy') {
        apiOnline = true;
        document.getElementById('mode-badge').innerHTML = '<span class="status-dot"></span><span>Online</span>';
        const tableCount = health.tables ? Object.keys(health.tables).length : 0;
        document.getElementById('api-status').textContent = `v2.0 - ${tableCount} tables`;
    }
    document.getElementById('api-url-display').textContent = API;
    await refreshAll();
    await loadBatches();
    checkActiveRuns();
})();

async function refreshAll() {
    await Promise.all([loadStats(), loadPipeline(), loadActionQueue(), loadIntelligenceHome()]);
}

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const pageEl = document.getElementById('page-'+id);
    if (pageEl) pageEl.classList.add('active');
    const navItem = document.querySelector(`.nav-item[onclick="showPage('${id}')"]`);
    if (navItem) navItem.classList.add('active');

    if (id === 'intelligence') loadIntelligence();
    if (id === 'experiments') loadExperiments();
    if (id === 'signals') loadSignals();
    if (id === 'agents') loadAgentRuns();
    if (id === 'approval') loadApprovalQueue();
    if (id === 'launch') { loadBatches(); loadPreBrief(); }
    if (id === 'email') loadEmailPage();
    if (id === 'swarm') loadSwarmPage();
    if (id === 'health') loadHealthPage();
    if (id === 'flows') loadFlows();
    if (id === 'activity') loadActivity();
    if (id === 'accounts') loadAccounts();
    if (id === 'contacts') loadContacts();
    if (id === 'drafts') loadDrafts();
    if (id === 'settings') loadSettings();
}

function kpi(label, val, sub = '') {
    return `<div class="kpi"><div class="kpi-label">${label}</div><div class="kpi-val">${val}</div>${sub ? `<div class="kpi-sub">${sub}</div>` : ''}</div>`;
}

function timeAgo(dateStr) {
    if (!dateStr) return '';
    const diff = Date.now() - new Date(dateStr).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    return `${Math.floor(hrs / 24)}d ago`;
}

function showConfirm(title, message, onConfirm) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-yes').onclick = () => { closeConfirm(); onConfirm(); };
    document.getElementById('confirm-dialog').classList.add('show');
}

function closeConfirm() {
    document.getElementById('confirm-dialog').classList.remove('show');
}

// HOME PAGE
async function loadStats() {
    const stats = await api('/api/stats');
    if (!stats) return;
    document.getElementById('kpi-row').innerHTML = [
        kpi('Prospects', stats.total_contacts || 0),
        kpi('Touched', stats.touches_sent || 0),
        kpi('Replies', stats.total_replies || 0, `${(stats.reply_rate || 0).toFixed(1)}% rate`),
        kpi('Meetings', stats.meetings_booked || 0),
        kpi('Pipeline', stats.opportunities_created || 0),
        kpi('Pending', stats.pending_followups || 0),
    ].join('');
}

async function loadActionQueue() {
    const q = await api('/api/action-queue');
    const el = document.getElementById('action-queue');
    if (!q || !q.length) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">‚úì</div><strong>All caught up</strong><br>No pending actions</div>';
        document.getElementById('badge-actions').style.display = 'none';
        return;
    }
    document.getElementById('badge-actions').style.display = '';
    document.getElementById('badge-actions').textContent = q.length;
    el.innerHTML = q.slice(0, 12).map(a => {
        const iconClass = a.type === 'overdue_followup' ? 'overdue' : a.type === 'untouched_hot' ? 'hot' : a.type === 'stuck' ? 'stuck' : 'signal';
        const icon = a.type === 'overdue_followup' ? '!' : a.type === 'untouched_hot' ? '‚òÖ' : a.type === 'stuck' ? '‚è±' : '‚ö°';
        return `<div class="action-item">
            <div class="action-icon ${iconClass}">${icon}</div>
            <div style="flex:1;min-width:0;">
                <div><strong>${a.contact || ''}</strong> <span style="color:var(--text-muted);font-size:11px;">${a.company || ''}</span></div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">${a.action || ''}</div>
            </div>
            ${a.contact_id ? `<button class="btn btn-sm" onclick="event.stopPropagation();openDetail('${a.contact_id}')">View</button>` : ''}
        </div>`;
    }).join('');
}

async function loadIntelligenceHome() {
    const funnel = await api('/api/analytics/pipeline');
    if (!funnel) return;
    if (charts.funnel) charts.funnel.destroy();
    charts.funnel = new Chart(document.getElementById('chart-funnel'), {
        type: 'bar', data: {
            labels: ['Prospects', 'Touched', 'Replied', 'Meetings', 'Opps'],
            datasets: [{
                data: [funnel.total_prospects, funnel.touched, funnel.replied, funnel.meetings, funnel.opportunities],
                backgroundColor: ['#6366f1', '#818cf8', '#10b981', '#f59e0b', '#f97316'],
                borderRadius: 4
            }]
        }, options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            }
        }
    });

    const intel = await api('/api/intelligence');
    if (!intel) return;
    renderMiniChart('chart-persona', intel.by_persona, 'persona');
    renderMiniChart('chart-vertical', intel.by_vertical, 'vertical');
}

function renderMiniChart(canvasId, data, labelKey) {
    if (!data || !data.length) return;
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(document.getElementById(canvasId), {
        type: 'bar', data: {
            labels: data.map(d => d[labelKey] || 'unknown'),
            datasets: [{ label: 'Reply Rate %', data: data.map(d => d.rate || 0), backgroundColor: '#6366f1', borderRadius: 4 }]
        }, options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                y: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 11 } } }
            }
        }
    });
}

// PIPELINE TABLE
async function loadPipeline() {
    document.getElementById('pipeline-body').innerHTML = '<tr><td colspan="8"><div class="empty">Loading...</div></td></tr>';
    const resp = await api('/api/contacts?limit=500');
    const data = resp?.contacts || resp || [];
    if (!data) {
        document.getElementById('pipeline-body').innerHTML = '<tr><td colspan="8"><div class="empty">No data available</div></td></tr>';
        return;
    }
    contacts = data;
    renderPipeline(contacts);
}

function refreshPipeline() { loadPipeline(); }

function sortPipeline(col) {
    if (pipelineSortCol === col) pipelineSortDir = pipelineSortDir === 'desc' ? 'asc' : 'desc';
    else { pipelineSortCol = col; pipelineSortDir = 'desc'; }
    filterPipeline();
}

function renderPipeline(list) {
    const body = document.getElementById('pipeline-body');
    document.getElementById('pipeline-count').textContent = `${list.length} contacts`;
    if (!list.length) { body.innerHTML = '<tr><td colspan="8"><div class="empty">No prospects in pipeline</div></td></tr>'; return; }
    body.innerHTML = list.map(c => {
        const pri = c.priority_score || 0;
        const priClass = pri >= 5 ? 'tag-hot' : pri >= 4 ? 'tag-warm' : 'tag-std';
        const persona = c.persona_type === 'qa_leader' ? 'tag-qa' : 'tag-vp';
        return `<tr onclick="openDetail('${c.id}')">
            <td><span class="tag ${priClass}">${pri}</span></td>
            <td><strong>${c.first_name} ${c.last_name}</strong></td>
            <td style="font-size:12px;color:var(--text-secondary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${c.title || ''}</td>
            <td>${c.company_name || ''}</td>
            <td><span class="tag ${persona}">${c.persona_type || ''}</span></td>
            <td style="font-size:12px;">${c.stage || 'new'}</td>
            <td>${c.personalization_score || '-'}</td>
            <td>
                <div class="btn-group" onclick="event.stopPropagation()">
                    <button class="btn btn-sm" onclick="agentAction(this,'re-score','${c.id}')">Re-Score</button>
                    <button class="btn btn-sm" onclick="agentAction(this,'run-qc','${c.id}')">QC</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function filterPipeline() {
    const pri = document.getElementById('f-priority').value;
    const persona = document.getElementById('f-persona').value;
    const stage = document.getElementById('f-stage').value;
    const search = document.getElementById('f-search').value.toLowerCase();
    let filtered = contacts;
    if (pri) filtered = filtered.filter(c => (c.priority_score || 0) >= parseInt(pri));
    if (persona) filtered = filtered.filter(c => c.persona_type === persona);
    if (stage) filtered = filtered.filter(c => c.stage === stage);
    if (search) filtered = filtered.filter(c =>
        `${c.first_name} ${c.last_name} ${c.title} ${c.company_name}`.toLowerCase().includes(search));

    filtered.sort((a, b) => {
        let av = a[pipelineSortCol], bv = b[pipelineSortCol];
        if (pipelineSortCol === 'name') { av = `${a.first_name} ${a.last_name}`; bv = `${b.first_name} ${b.last_name}`; }
        if (av == null) av = ''; if (bv == null) bv = '';
        const cmp = typeof av === 'number' ? av - bv : String(av).localeCompare(String(bv));
        return pipelineSortDir === 'asc' ? cmp : -cmp;
    });

    renderPipeline(filtered);
}

async function agentAction(btn, action, contactId) {
    const origText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    const r = await apiPost(`/api/contacts/${contactId}/${action}`, {});
    btn.disabled = false;
    btn.textContent = origText;
    if (r && !r._error) {
        showToast(`${action.replace(/-/g, ' ')} complete`, 'success');
        loadPipeline();
    } else {
        showToast(r?.message || `${action} failed`, 'error');
    }
}

async function openDetail(cid) {
    let panel = document.getElementById('detail-panel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'detail-panel';
        panel.className = 'detail-panel';
        document.body.appendChild(panel);
    }
    const [contact, msgs, prep] = await Promise.all([
        api(`/api/contacts/${cid}`),
        api(`/api/contacts/${cid}/messages`),
        api(`/api/contacts/${cid}/prep-card`),
    ]);
    if (!contact) return;
    panel.innerHTML = `
        <button class="detail-close" onclick="document.getElementById('detail-panel').classList.remove('open')">&times;</button>
        <h2>${contact.first_name} ${contact.last_name}</h2>
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;">${contact.title || ''} ${contact.company_name ? '@ ' + contact.company_name : ''}</div>
        <div class="btn-group" style="margin-bottom:20px;">
            <button class="btn btn-sm" onclick="agentAction(this,'re-score','${cid}')">Re-Score</button>
            <button class="btn btn-sm" onclick="agentAction(this,'run-qc','${cid}')">Run QC</button>
            ${contact.linkedin_url ? `<a class="btn btn-sm" href="${contact.linkedin_url}" target="_blank" rel="noopener">LinkedIn</a>` : ''}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;font-size:12px;">
            <div><span style="color:var(--text-muted);">Priority:</span> <strong>${contact.priority_score || '-'}</strong></div>
            <div><span style="color:var(--text-muted);">Persona:</span> <strong>${contact.persona_type || '-'}</strong></div>
            <div><span style="color:var(--text-muted);">Stage:</span> <strong>${contact.stage || 'new'}</strong></div>
            <div><span style="color:var(--text-muted);">P-Score:</span> <strong>${contact.personalization_score || '-'}</strong></div>
        </div>
        ${prep && prep.pain_hypothesis ? `<div class="card"><h3>Pain Hypothesis</h3><div style="font-size:12px;color:var(--text-secondary);">${prep.pain_hypothesis}</div></div>` : ''}
        ${prep && prep.known_tools?.length ? `<div class="card"><h3>Known Tools</h3><div style="font-size:12px;color:var(--text-secondary);">${prep.known_tools.join(', ')}</div></div>` : ''}
        ${prep && prep.predicted_objection ? `<div class="card"><h3>Predicted Objection</h3><div style="font-size:12px;color:var(--warning);margin-bottom:4px;">${prep.predicted_objection}</div><div style="font-size:12px;color:var(--text-secondary);">${prep.objection_response || ''}</div></div>` : ''}
        <div class="card"><h3>Messages (${msgs?.length || 0})</h3>
            ${(msgs || []).map(m => `
                <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px;">
                        <span style="color:var(--accent);font-weight:600;">Touch ${m.touch_number} - ${m.channel}</span>
                        <span style="color:${m.qc_passed ? 'var(--success)' : 'var(--error)'}">${m.qc_passed ? '‚úì QC Pass' : '‚úó QC Fail'}</span>
                    </div>
                    ${m.subject_line ? `<div style="font-size:12px;font-weight:600;color:var(--warning);margin-bottom:6px;">${m.subject_line}</div>` : ''}
                    <div style="font-size:12px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.5;">${m.body || ''}</div>
                </div>
            `).join('')}
        </div>
    `;
    panel.classList.add('open');
}

// LAUNCH BATCH
async function loadBatches() {
    const data = await api('/api/batches?limit=20');
    if (!data) return;
    batches = data;
    const el = document.getElementById('batch-list');
    if (!data.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><strong>No batches yet</strong><br>Launch your first one!</div>'; return; }

    const maxNum = Math.max(...data.map(b => b.batch_number || 0));
    document.getElementById('launch-batch-num').value = maxNum + 1;

    const exportSel = document.getElementById('export-batch');
    exportSel.innerHTML = '<option value="">All contacts</option>' + data.map(b =>
        `<option value="${b.id}">Batch ${b.batch_number} (${b.contact_count || 0} contacts)</option>`
    ).join('');

    el.innerHTML = data.map(b => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;">
            <div><strong>Batch ${b.batch_number || '?'}</strong> <span style="color:var(--text-secondary);">${b.contact_count || 0} prospects, ${b.message_count || 0} msgs</span></div>
            <div class="btn-group">
                <span class="tag ${b.status === 'complete' ? 'tag-qa' : 'tag-warm'}">${b.status || 'unknown'}</span>
                <button class="btn btn-sm" onclick="regenerateHTML('${b.id}',this)">Regen HTML</button>
            </div>
        </div>
    `).join('');
}

async function loadPreBrief() {
    const data = await apiPost('/api/pre-brief', {});
    const card = document.getElementById('pre-brief-card');
    if (!data || data._error || !data.data?.insights) { card.style.display = 'none'; return; }
    card.style.display = 'block';
    document.getElementById('pre-brief-content').innerHTML = data.data.insights.map(ins => `
        <div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;">
            <div style="font-weight:600;color:var(--accent);min-width:150px;">${ins.label || ins.category || ''}</div>
            <div style="color:var(--text-secondary);">${ins.value || ins.insight || ''}</div>
        </div>
    `).join('');
}

async function launchBatch() {
    document.getElementById('launch-error').style.display = 'none';
    document.querySelectorAll('.err-msg').forEach(e => e.classList.remove('show'));
    document.querySelectorAll('.inp.err').forEach(e => e.classList.remove('err'));

    const batchNum = parseInt(document.getElementById('launch-batch-num').value);
    const target = parseInt(document.getElementById('launch-target').value);
    let valid = true;

    if (!batchNum || batchNum < 1) {
        document.getElementById('launch-batch-num').classList.add('err');
        document.getElementById('err-batch-num').classList.add('show');
        valid = false;
    }
    if (!target || target < 1 || target > 100) {
        document.getElementById('launch-target').classList.add('err');
        document.getElementById('err-target').classList.add('show');
        valid = false;
    }
    if (!valid) return;

    const btn = document.getElementById('launch-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Launching...';

    const body = {
        batch_number: batchNum,
        target_count: target,
        ab_variable: document.getElementById('launch-ab-var').value,
        ab_groups: {
            A: document.getElementById('launch-group-a').value,
            B: document.getElementById('launch-group-b').value,
        },
        auto_approve: document.getElementById('launch-auto-approve').checked,
        saved_search_url: document.getElementById('launch-search-url').value || null,
    };

    const result = await apiPost('/api/pipeline/start', body);
    btn.disabled = false;
    btn.textContent = 'Launch Pipeline';

    if (result && !result._error && result.run_id) {
        activeRunId = result.run_id;
        showToast(`Pipeline launched: Batch #${batchNum}`, 'success');
        showPage('home');
        connectSSE(result.run_id);
        showPipelineProgress();
        startTimer();
    } else {
        const errEl = document.getElementById('launch-error');
        errEl.textContent = result?.message || 'Launch failed. Check your configuration.';
        errEl.style.display = 'block';
    }
}

async function regenerateHTML(batchId, btn) {
    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>'; }
    const r = await apiPost(`/api/batches/${batchId}/generate-html`, {});
    if (btn) { btn.disabled = false; btn.textContent = 'Regen HTML'; }
    if (r && !r._error) showToast('HTML regenerated', 'success');
    else showToast(r?.message || 'Regeneration failed', 'error');
}

// PIPELINE PROGRESS
const PHASES = ['initialize', 'pre_brief', 'extract', 'research', 'score', 'ab_assign', 'messages', 'qc', 'approval', 'generate_html', 'finalize'];

function showPipelineProgress() {
    const container = document.getElementById('active-run-container');
    container.style.display = 'block';
    document.getElementById('phase-track').innerHTML = PHASES.map(p =>
        `<div class="phase-step pending" id="phase-${p}" title="${p.replace(/_/g, ' ')}">${p.replace(/_/g, ' ').substring(0, 6)}</div>`
    ).join('');
}

function startTimer() {
    runStartTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        if (!runStartTime) return;
        const elapsed = Math.floor((Date.now() - runStartTime) / 1000);
        const m = Math.floor(elapsed / 60);
        const s = elapsed % 60;
        document.getElementById('run-timer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
}

function connectSSE(runId) {
    if (sseSource) sseSource.close();
    sseSource = new EventSource(`${API}/api/pipeline/runs/${runId}/stream`);

    sseSource.addEventListener('phase_start', e => {
        const d = JSON.parse(e.data);
        const el = document.getElementById('phase-' + d.phase);
        if (el) el.className = 'phase-step active';
    });

    sseSource.addEventListener('phase_end', e => {
        const d = JSON.parse(e.data);
        const el = document.getElementById('phase-' + d.phase);
        if (el) el.className = 'phase-step done';
        if (d.progress) document.getElementById('progress-fill').style.width = d.progress + '%';
        if (d.detail) document.getElementById('phase-detail').textContent = d.detail;
    });

    sseSource.addEventListener('phase_error', e => {
        const d = JSON.parse(e.data);
        const el = document.getElementById('phase-' + d.phase);
        if (el) el.className = 'phase-step failed';
        document.getElementById('run-status').textContent = 'ERROR: ' + (d.error || 'Unknown error');
    });

    sseSource.addEventListener('run_complete', e => {
        const d = JSON.parse(e.data);
        stopTimer();
        document.getElementById('run-status').textContent = 'Completed';
        showToast('Pipeline run complete!', 'success');
        setTimeout(() => { activeRunId = null; sseSource.close(); document.getElementById('active-run-container').style.display = 'none'; }, 2000);
    });

    sseSource.addEventListener('error', () => {
        stopTimer();
        showToast('Connection lost', 'error');
    });
}

function cancelRun() {
    showConfirm('Cancel Pipeline?', 'This will stop the current run and clean up.', async () => {
        if (activeRunId) {
            await apiPost(`/api/pipeline/runs/${activeRunId}/cancel`, {});
            stopTimer();
            activeRunId = null;
            if (sseSource) sseSource.close();
            document.getElementById('active-run-container').style.display = 'none';
            showToast('Pipeline cancelled', 'warning');
        }
    });
}

function checkActiveRuns() {
    api('/api/pipeline/runs/active').then(data => {
        if (data && data.run_id) {
            activeRunId = data.run_id;
            showPipelineProgress();
            connectSSE(data.run_id);
            startTimer();
        }
    });
}

// STUB: Remaining functions simplified (will need full implementation from original)
async function loadActivity() { /* implement */ }
async function loadFlows() { /* implement */ }
async function loadApprovalQueue() { /* implement */ }
async function loadAccounts() { /* implement */ }
async function loadContacts() { /* implement */ }
async function loadDrafts() { /* implement */ }
async function loadIntelligence() { /* implement */ }
async function loadExperiments() { /* implement */ }
async function loadSignals() { /* implement */ }
async function loadAgentRuns() { /* implement */ }
async function loadEmailPage() { /* implement */ }
async function loadSwarmPage() { /* implement */ }
async function loadHealthPage() { /* implement */ }
async function loadSettings() { /* implement */ }

function showExportModal() { document.getElementById('export-modal').classList.add('show'); }
function closeExportModal() { document.getElementById('export-modal').classList.remove('show'); }
function doExport() { showToast('Export started', 'success'); }

function showAddAccountModal() { document.getElementById('add-account-modal').style.display = 'flex'; }
function closeAddAccountModal() { document.getElementById('add-account-modal').style.display = 'none'; }
function addAccount() { showToast('Account added', 'success'); }

function showAddContactModal() { document.getElementById('add-contact-modal').style.display = 'flex'; }
function closeAddContactModal() { document.getElementById('add-contact-modal').style.display = 'none'; }
function addContact() { showToast('Contact added', 'success'); }

function showImportContactsModal() { document.getElementById('import-contacts-modal').style.display = 'flex'; }
function closeImportContactsModal() { document.getElementById('import-contacts-modal').style.display = 'none'; }
function importContacts() { showToast('Contacts imported', 'success'); }
function showImportTab(tab) { /* implement */ }

function showAddSignalForm() { document.getElementById('add-signal-form').style.display = 'block'; }
function addSignal() { showToast('Signal created', 'success'); }

function showAddIdentity() { document.getElementById('add-identity-modal').style.display = 'flex'; }
function hideAddIdentity() { document.getElementById('add-identity-modal').style.display = 'none'; }
function createIdentity() { showToast('Identity created', 'success'); }
function addSuppression() { showToast('Email suppressed', 'success'); }

function showLaunchSwarm() { document.getElementById('launch-swarm-modal').style.display = 'flex'; }
function launchSwarm() { showToast('Swarm launched', 'success'); }

function showEmailTab(tab, btn) { /* implement */ }
function showIntelTab(tab) {
    document.querySelectorAll('#intel-tab-breakdowns,#intel-tab-trends,#intel-tab-ab,#intel-tab-top').forEach(e => e.classList.remove('active'));
    document.getElementById('intel-tab-' + tab).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
}

function showSettingsTab(tab) {
    document.querySelectorAll('[id^="settings-tab-"]').forEach(e => e.classList.remove('active'));
    document.getElementById('settings-tab-' + tab).classList.add('active');
    document.querySelectorAll('#page-settings .tab-item').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
}

function saveGeneralSettings() { showToast('Settings saved', 'success'); }

function confirmBulk(action) { showConfirm(`${action.charAt(0).toUpperCase() + action.slice(1)} all?`, `Confirm bulk ${action}?`, () => showToast(`All ${action}d`, 'success')); }

</script>

</body>
</html>
