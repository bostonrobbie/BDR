<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Outreach Command Center</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7"></script>
<style>
:root {
    --bg-primary: #0a0b0f;
    --bg-card: #12131a;
    --bg-elevated: #1a1b26;
    --bg-hover: #1e2030;
    --border: #1e2030;
    --border-subtle: #161722;

    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --text-muted: #475569;

    --accent: #6366f1;
    --accent-hover: #818cf8;
    --accent-bg: rgba(99, 102, 241, 0.1);

    --success: #10b981;
    --success-bg: rgba(16, 185, 129, 0.1);
    --warning: #f59e0b;
    --warning-bg: rgba(245, 158, 11, 0.1);
    --error: #ef4444;
    --error-bg: rgba(239, 68, 68, 0.1);
    --info: #06b6d4;
    --info-bg: rgba(6, 182, 212, 0.1);

    --radius-sm: 6px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --transition: 150ms ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.5;
    font-size: 13px;
}

a { color: var(--accent-hover); text-decoration: none; cursor: pointer; }

/* Layout */
.shell { display: flex; height: 100vh; }

.sidebar {
    width: 240px;
    background: var(--bg-card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    box-shadow: inset -1px 0 0 rgba(0,0,0,0.2);
}

.sidebar-logo {
    padding: 20px;
    border-bottom: 1px solid var(--border);
}

.sidebar-logo strong {
    font-size: 16px;
    font-weight: 700;
    color: var(--accent-hover);
    display: block;
}

.sidebar-logo span {
    color: var(--text-muted);
    font-size: 11px;
    margin-top: 4px;
    display: block;
    letter-spacing: 0.5px;
}

.nav {
    flex: 1;
    padding: 12px 8px;
    overflow-y: auto;
}

.nav-section {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    text-transform: uppercase;
    padding: 14px 12px 8px;
    letter-spacing: 0.5px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 13px;
    color: var(--text-secondary);
    transition: all var(--transition);
    user-select: none;
    position: relative;
    margin: 2px 0;
    border-left: 3px solid transparent;
}

.nav-item:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.nav-item.active {
    background: var(--accent-bg);
    color: var(--accent);
    border-left-color: var(--accent);
    font-weight: 500;
}

.nav-item .badge {
    margin-left: auto;
    background: var(--error);
    color: #fff;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}

.nav-sep {
    height: 1px;
    background: var(--border);
    margin: 8px 0;
}

.sidebar-status {
    padding: 14px;
    border-top: 1px solid var(--border);
    font-size: 11px;
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--success-bg);
    color: var(--success);
    border-radius: 16px;
    font-weight: 600;
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success);
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.main {
    flex: 1;
    overflow-y: auto;
    background: var(--bg-primary);
}

.page {
    display: none;
    padding: 32px;
    max-width: 1600px;
    margin: 0 auto;
}

.page.active {
    display: block;
    animation: fadeIn 150ms ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.page-hdr {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
    flex-wrap: wrap;
    gap: 12px;
}

.page-hdr h1 {
    font-size: 28px;
    font-weight: 600;
    letter-spacing: -0.5px;
}

/* Typography */
h2 { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
h3 { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

/* KPIs */
.kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 28px;
}

.kpi {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px;
    position: relative;
    overflow: hidden;
    transition: all var(--transition);
}

.kpi:hover {
    border-color: var(--accent);
    background: var(--bg-elevated);
}

.kpi::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent-hover));
    opacity: 0;
    transition: opacity var(--transition);
}

.kpi:hover::before {
    opacity: 1;
}

.kpi-label {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    font-weight: 600;
}

.kpi-val {
    font-size: 28px;
    font-weight: 700;
    margin: 4px 0;
    color: var(--text-primary);
}

.kpi-sub {
    font-size: 12px;
    margin-top: 6px;
}

.kpi-sub.up { color: var(--success); }
.kpi-sub.dn { color: var(--error); }

/* Cards */
.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 20px;
    margin-bottom: 20px;
    transition: all var(--transition);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.card:hover {
    border-color: var(--border-subtle);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.card h3 {
    margin-bottom: 16px;
}

.card canvas {
    max-height: 320px;
}

/* Draft Cards */
.draft-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    margin-bottom: 12px;
    transition: all var(--transition);
    overflow: hidden;
}

.draft-card:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.draft-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    cursor: pointer;
    transition: background var(--transition);
    user-select: none;
}

.draft-header:hover {
    background: var(--bg-hover);
}

.draft-header-left {
    flex: 1;
    min-width: 0;
}

.draft-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 6px;
    flex-wrap: wrap;
}

.draft-title strong {
    font-size: 14px;
    color: var(--text-primary);
}

.draft-company {
    font-size: 12px;
    color: var(--text-secondary);
}

.draft-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 11px;
}

.draft-touch {
    background: var(--bg-elevated);
    padding: 2px 6px;
    border-radius: 4px;
    color: var(--text-secondary);
    font-weight: 500;
}

.draft-wordcount {
    color: var(--text-muted);
}

.draft-toggle {
    flex-shrink: 0;
    margin-left: 12px;
    color: var(--text-secondary);
    font-size: 12px;
    transition: transform var(--transition);
}

.draft-body {
    background: var(--bg-primary);
}

/* Draft Tabs */
.draft-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--bg-elevated);
}
.draft-tab-btn {
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all var(--transition);
}
.draft-tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}
.draft-tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}
.draft-tab-content {
    display: none;
    padding: 16px;
}
.draft-tab-content.active {
    display: block;
}
.draft-message-body {
    background: var(--bg-primary);
    padding: 12px;
    border-radius: 4px;
    font-size: 13px;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.6;
    max-height: 500px;
    overflow-y: auto;
    min-height: 80px;
}
.draft-message-body.call-script {
    font-family: monospace;
    font-size: 12px;
}
.draft-edit-textarea {
    width: 100%;
    min-height: 200px;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 12px;
    font-size: 13px;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
}
.draft-subject-input {
    width: 100%;
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 13px;
    font-family: inherit;
}
.research-section {
    margin-bottom: 16px;
}
.research-section-title {
    font-size: 11px;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: bold;
    margin-bottom: 8px;
}
.research-bullet {
    padding: 6px 10px;
    margin-bottom: 4px;
    background: var(--bg-elevated);
    border-radius: 4px;
    font-size: 12px;
    line-height: 1.5;
    border-left: 3px solid var(--accent);
}
.confidence-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}
.confidence-badge.high {
    background: var(--success-bg);
    color: var(--success);
}
.confidence-badge.medium {
    background: var(--warning-bg);
    color: var(--warning);
}
.confidence-badge.low {
    background: var(--error-bg);
    color: var(--error);
}
.research-completeness {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}
.research-completeness.complete {
    background: var(--success-bg);
    color: var(--success);
}
.research-completeness.partial {
    background: var(--warning-bg);
    color: var(--warning);
}
.research-completeness.missing {
    background: var(--error-bg);
    color: var(--error);
}

/* Flow Steps */
.flow-step {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--transition);
}
.flow-step:hover {
    border-color: var(--accent);
    color: var(--text-primary);
}
.flow-step.active {
    background: var(--accent-bg);
    border-color: var(--accent);
    color: var(--accent);
}
.flow-step.completed {
    background: var(--success-bg);
    border-color: var(--success);
    color: var(--success);
}
.flow-step-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: var(--bg-elevated);
    font-weight: bold;
    font-size: 11px;
}
.flow-step.active .flow-step-num {
    background: var(--accent);
    color: #fff;
}
.flow-step.completed .flow-step-num {
    background: var(--success);
    color: #fff;
}

/* Channel Tabs */
.channel-tabs {
    display: flex;
    border-bottom: 2px solid var(--border);
    margin-bottom: 20px;
}
.channel-tab-btn {
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    cursor: pointer;
    transition: all var(--transition);
}
.channel-tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}
.channel-tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

/* Grids */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
.grid4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

/* Tables */
.tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.tbl thead {
    background: var(--bg-elevated);
    position: sticky;
    top: 0;
}

.tbl thead th {
    text-align: left;
    padding: 12px 14px;
    border-bottom: 2px solid var(--border);
    color: var(--text-secondary);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    font-weight: 600;
    white-space: nowrap;
    user-select: none;
    transition: color var(--transition);
}

.tbl thead th:hover {
    color: var(--text-primary);
}

.tbl thead th.sorted::after {
    content: " ‚ñº";
    font-size: 8px;
}

.tbl thead th.sorted.asc::after {
    content: " ‚ñ≤";
}

.tbl tbody td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border-subtle);
}

.tbl tbody tr {
    transition: background var(--transition);
}

.tbl tbody tr:hover {
    background: var(--bg-elevated);
    cursor: pointer;
}

.tbl tbody tr:nth-child(even) {
    background: rgba(0, 0, 0, 0.05);
}

/* Tags */
.tag {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
}

.tag-hot { background: var(--error-bg); color: var(--error); }
.tag-warm { background: var(--warning-bg); color: var(--warning); }
.tag-std { background: var(--accent-bg); color: var(--accent); }
.tag-qa { background: var(--success-bg); color: var(--success); }
.tag-vp { background: var(--info-bg); color: var(--info); }
.tag-intent { background: var(--warning-bg); color: var(--warning); }
.tag-warn { background: var(--warning-bg); color: var(--warning); }

/* Buttons */
.btn {
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-elevated);
    color: var(--text-primary);
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    font-weight: 500;
}

.btn:hover {
    border-color: var(--accent);
    background: var(--bg-hover);
    color: var(--accent-hover);
}

.btn:active {
    transform: translateY(1px);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.btn-primary {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
}

.btn-primary:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
}

.btn-danger {
    background: var(--error);
    border-color: var(--error);
    color: #fff;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-success {
    background: var(--success);
    border-color: var(--success);
    color: #fff;
}

.btn-success:hover {
    background: #059669;
}

.btn-sm {
    padding: 5px 12px;
    font-size: 11px;
}

.btn-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

/* Quick Actions Grid */
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 10px;
}

.quick-action-btn {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    padding: 16px;
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition);
    text-align: left;
    min-height: 80px;
    overflow: hidden;
}

.quick-action-btn:hover {
    background: var(--bg-hover);
    border-color: var(--accent);
}

.quick-action-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    display: block;
}

.quick-action-desc {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.4;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* Forms */
.inp, .sel {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-family: inherit;
    transition: all var(--transition);
}

.inp:focus, .sel:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-bg);
}

.inp.err {
    border-color: var(--error);
    box-shadow: 0 0 0 2px var(--error-bg);
}

.form-row {
    margin-bottom: 16px;
}

.form-row label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 6px;
    font-weight: 500;
}

/* Filters Bar */
.filters-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.filters-bar label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

/* Tabs */
.tab-bar {
    display: flex;
    gap: 0;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border);
}

.tab-item {
    padding: 12px 18px;
    font-size: 13px;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all var(--transition);
    user-select: none;
    font-weight: 500;
}

.tab-item:hover {
    color: var(--text-primary);
}

.tab-item.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Pipeline */
.pipeline-progress {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 22px;
    margin-bottom: 20px;
}

.phase-track {
    display: flex;
    gap: 8px;
    margin: 16px 0;
}

.phase-step {
    flex: 1;
    height: 40px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    transition: all 0.3s ease;
    background: var(--bg-elevated);
    color: var(--text-muted);
}

.phase-step.active {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 0 16px rgba(99, 102, 241, 0.4);
    animation: pulse 1.5s infinite;
}

.phase-step.done {
    background: var(--success);
    color: #fff;
}

.phase-step.failed {
    background: var(--error);
    color: #fff;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.progress-bar {
    height: 6px;
    background: var(--bg-elevated);
    border-radius: 3px;
    overflow: hidden;
    margin-top: 12px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--success));
    transition: width 0.5s ease;
    border-radius: 3px;
}

.run-timer {
    font-size: 12px;
    color: var(--text-secondary);
    font-variant-numeric: tabular-nums;
    font-weight: 500;
}

/* Detail Panel */
.detail-panel {
    position: fixed;
    right: 0;
    top: 0;
    width: 540px;
    height: 100vh;
    background: var(--bg-card);
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 100;
    overflow-y: auto;
    padding: 24px;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
}

.detail-panel.open {
    transform: translateX(0);
}

.detail-panel h2 {
    font-size: 20px;
    margin-bottom: 6px;
}

.detail-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 20px;
    padding: 4px 8px;
    transition: color var(--transition);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
}

.detail-close:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

/* Action Items */
.action-item {
    display: flex;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    align-items: flex-start;
}

.action-item:last-child {
    border-bottom: none;
}

.action-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
    font-weight: 600;
}

.action-icon.overdue {
    background: var(--error-bg);
    color: var(--error);
}

.action-icon.hot {
    background: var(--warning-bg);
    color: var(--warning);
}

.action-icon.stuck {
    background: var(--warning-bg);
    color: var(--warning);
}

.action-icon.signal {
    background: var(--accent-bg);
    color: var(--accent);
}

/* Signals */
.signal-card {
    background: var(--bg-elevated);
    border-left: 4px solid var(--warning);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    padding: 12px 14px;
    margin-bottom: 10px;
    transition: all var(--transition);
}

.signal-card:hover {
    border-left-color: var(--accent);
    background: var(--bg-hover);
}

.signal-card.buyer_intent {
    border-left-color: var(--warning);
}

.signal-card.funding {
    border-left-color: var(--success);
}

.signal-card.job_posting {
    border-left-color: var(--info);
}

.signal-card.leadership_change {
    border-left-color: #a855f7;
}

.signal-card.product_launch {
    border-left-color: var(--warning);
}

.sig-type {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sig-detail {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.sig-age {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
}

.signal-card.actioned {
    opacity: 0.6;
    border-left-color: var(--success);
}

/* Dialogs */
.confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.confirm-overlay.show {
    display: flex;
}

.confirm-box {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px;
    width: 420px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.confirm-box h3 {
    font-size: 18px;
    margin-bottom: 12px;
    font-weight: 600;
}

.confirm-box p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 20px;
}

.confirm-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Modals */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
}

.modal.show {
    display: flex;
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 24px;
    width: 440px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.modal-content h3 {
    font-size: 18px;
    margin-bottom: 16px;
    font-weight: 600;
}

/* Empty State */
.empty {
    padding: 48px 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 13px;
}

.empty-icon {
    font-size: 40px;
    margin-bottom: 12px;
    opacity: 0.6;
}

.empty strong {
    display: block;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

/* Toast */
#toast-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 300;
    pointer-events: none;
}

.toast {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px 18px;
    font-size: 13px;
    margin-bottom: 12px;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
    pointer-events: auto;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    border-left: 4px solid var(--accent);
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

.toast.success {
    border-left-color: var(--success);
}

.toast.error {
    border-left-color: var(--error);
}

.toast.warning {
    border-left-color: var(--warning);
}

/* Spinner */
.spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--border);
    border-top-color: var(--accent-hover);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Badge */
.badge-gn {
    background: var(--success-bg);
    color: var(--success);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.badge-rd {
    background: var(--error-bg);
    color: var(--error);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

.badge-yl {
    background: var(--warning-bg);
    color: var(--warning);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
}

/* Approval Cards */
.approval-card {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 14px;
    transition: all 0.2s ease;
}

.approval-card.approved {
    border-color: var(--success);
    opacity: 0.7;
    background: rgba(16, 185, 129, 0.05);
}

.approval-card.rejected {
    border-color: var(--error);
    opacity: 0.6;
    background: rgba(239, 68, 68, 0.05);
}

.approval-card .msg-subj {
    font-size: 13px;
    font-weight: 600;
    color: var(--warning);
    margin-bottom: 6px;
}

.approval-card .msg-body {
    font-size: 12px;
    color: var(--text-secondary);
    white-space: pre-wrap;
    line-height: 1.6;
    margin: 10px 0;
    padding: 12px;
    background: var(--bg-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    min-height: 70px;
    outline: none;
    transition: border-color var(--transition);
    font-family: 'Courier New', monospace;
}

.approval-card .msg-body.editing {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-bg);
}

.approval-card .msg-meta {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    font-size: 11px;
    color: var(--text-muted);
    align-items: center;
}

.msg-word-count {
    font-variant-numeric: tabular-nums;
    padding: 2px 8px;
    background: var(--bg-elevated);
    border-radius: 4px;
}

.msg-save-indicator {
    color: var(--success);
    font-size: 11px;
    opacity: 0;
    transition: opacity 0.3s ease;
    font-weight: 600;
}

.msg-save-indicator.show {
    opacity: 1;
}

/* Flow Grid */
.flow-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.flow-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 18px;
    transition: all var(--transition);
}

.flow-card:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.1);
}

.flow-card h3 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
}

.flow-card .desc {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 12px;
    line-height: 1.5;
}

.flow-card .run-count {
    font-size: 11px;
    color: var(--text-muted);
    margin-bottom: 14px;
}

/* Timeline */
.timeline {
    position: relative;
    padding: 20px 0;
}

.timeline-item {
    display: flex;
    gap: 16px;
    padding: 16px 0;
    border-bottom: 1px solid var(--border);
}

.timeline-item:last-child {
    border-bottom: none;
}

.timeline-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
    background: var(--accent-bg);
    color: var(--accent);
}

.timeline-content {
    flex: 1;
}

.timeline-content h4 {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
}

.timeline-content p {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

.timeline-content .time {
    font-size: 11px;
    color: var(--text-muted);
}

/* Error Message */
.err-msg {
    color: var(--error);
    font-size: 11px;
    margin-top: 4px;
    display: none;
}

.err-msg.show {
    display: block;
}

/* Responsive */
@media (max-width: 1200px) {
    .grid2, .grid3, .grid4 {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 900px) {
    .sidebar {
        width: 70px;
    }
    .sidebar-logo span,
    .nav-item span:not(.badge),
    .nav-section {
        display: none;
    }
    .nav-item {
        justify-content: center;
        padding: 10px;
    }
    .quick-actions-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .sidebar {
        display: none;
    }
    .page {
        padding: 16px;
    }
    .page-hdr {
        flex-direction: column;
        align-items: flex-start;
    }
    .page-hdr h1 {
        font-size: 24px;
    }
    .kpi-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    .grid2, .grid3, .grid4 {
        grid-template-columns: 1fr;
    }
    .card {
        padding: 16px;
    }
    .detail-panel {
        width: 100%;
    }
    .filters-bar {
        flex-direction: column;
    }
    .filters-bar label,
    .filters-bar select,
    .filters-bar input {
        width: 100%;
    }
    .tbl {
        font-size: 12px;
    }
    .tbl thead th {
        padding: 10px 8px;
        font-size: 10px;
    }
    .tbl tbody td {
        padding: 10px 8px;
    }
    .quick-actions-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 600px) {
    .quick-actions-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    .quick-action-btn {
        padding: 14px;
        min-height: 70px;
    }
}

@media print {
    .sidebar, .toast, .confirm-overlay, .detail-panel {
        display: none !important;
    }
    .main {
        overflow: visible;
    }
    .page {
        max-width: none;
    }
}
</style>
</head>
<body>

<div class="shell">
<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-logo">
        <strong>OCC</strong>
        <span>Outreach Command Center</span>
    </div>
    <nav class="nav">
        <div class="nav-section">HOME</div>
        <div class="nav-item active" onclick="showPage('home')">
            <span class="nav-icon">üè†</span> <span>Command Center</span>
            <span class="badge" id="badge-actions" style="display:none">0</span>
        </div>

        <div class="nav-section">CHANNELS</div>
        <div class="nav-item" onclick="showPage('accounts')">
            <span class="nav-icon">üè¢</span> <span>Accounts & Research</span>
        </div>
        <div class="nav-item" onclick="showPage('linkedin')">
            <span class="nav-icon">üîó</span> <span>LinkedIn</span>
            <span class="badge" id="badge-linkedin" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="showPage('email')">
            <span class="nav-icon">‚úâÔ∏è</span> <span>Email</span>
            <span class="badge" id="badge-email" style="display:none">0</span>
        </div>
        <div class="nav-item" onclick="showPage('prospects')">
            <span class="nav-icon">üë•</span> <span>All Prospects</span>
            <span class="badge" id="badge-prospects" style="display:none">0</span>
        </div>

        <div class="nav-section">ADMIN</div>
        <div class="nav-item" onclick="showPage('import')">
            <span class="nav-icon">üì¶</span> <span>Import</span>
        </div>
        <div class="nav-item" onclick="showPage('data')">
            <span class="nav-icon">üíæ</span> <span>Data</span>
        </div>
        <div class="nav-item" onclick="showPage('settings')">
            <span class="nav-icon">üîß</span> <span>Settings</span>
        </div>
    </nav>
    <div class="sidebar-status">
        <div style="padding:10px;background:var(--bg-elevated);border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all var(--transition)" onclick="showPage('quota')" id="quota-widget" title="Click to view full quota tracker">
            <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;font-weight:bold;margin-bottom:4px">Credits</div>
            <div style="font-size:18px;font-weight:bold;color:var(--accent)" id="quota-remaining">-</div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:2px" id="quota-info">Loading...</div>
        </div>
        <div class="status-badge" id="mode-badge">
            <span class="status-dot"></span>
            <span>Online</span>
        </div>
        <div style="margin-top: 8px; font-size: 11px; color: var(--text-muted);" id="api-status">API not connected</div>
    </div>
</div>

<!-- Main Content -->
<div class="main">

<!-- HOME -->
<div class="page active" id="page-home">
    <div class="page-hdr">
        <h1>Dashboard</h1>
        <button class="btn btn-sm" onclick="refreshAll()">Refresh</button>
    </div>
    <div class="kpi-row" id="kpi-row"></div>

    <div id="active-run-container" style="display:none;">
        <div class="pipeline-progress" id="pipeline-progress">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong id="run-title" style="font-size:16px;">Pipeline Running</strong>
                    <span id="run-status" style="margin-left:12px;font-size:13px;color:var(--text-secondary);"></span>
                </div>
                <div style="display:flex;gap:12px;align-items:center;">
                    <span class="run-timer" id="run-timer">0:00</span>
                    <button class="btn btn-sm btn-danger" id="cancel-run-btn" onclick="cancelRun()">Cancel</button>
                </div>
            </div>
            <div class="phase-track" id="phase-track"></div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
            <div id="phase-detail" style="font-size:12px;color:var(--text-muted);margin-top:8px;"></div>
        </div>
    </div>

    <div class="grid2">
        <div class="card">
            <h3>Action Queue</h3>
            <div id="action-queue"><div class="empty">Loading...</div></div>
        </div>
        <div class="card">
            <h3>Pipeline Funnel</h3>
            <canvas id="chart-funnel"></canvas>
        </div>
    </div>

    <div class="grid2">
        <div class="card">
            <h3>Reply Rate by Persona</h3>
            <canvas id="chart-persona"></canvas>
        </div>
        <div class="card">
            <h3>Reply Rate by Vertical</h3>
            <canvas id="chart-vertical"></canvas>
        </div>
    </div>
</div>

<!-- PIPELINE -->
<div class="page" id="page-pipeline">
    <div class="page-hdr">
        <h1>Prospect Pipeline</h1>
        <div class="btn-group">
            <button class="btn btn-sm" onclick="showExportModal()">Export CSV</button>
            <button class="btn btn-sm" onclick="refreshPipeline()">Refresh</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Priority</label>
        <select class="sel" id="f-priority" onchange="filterPipeline()" style="width:140px;">
            <option value="">All</option>
            <option value="5">Hot (5)</option>
            <option value="4">Warm (4+)</option>
            <option value="3">Standard (3+)</option>
        </select>

        <label>Persona</label>
        <select class="sel" id="f-persona" onchange="filterPipeline()" style="width:140px;">
            <option value="">All</option>
            <option value="qa_leader">QA Leader</option>
            <option value="vp_eng">VP Eng</option>
        </select>

        <label>Stage</label>
        <select class="sel" id="f-stage" onchange="filterPipeline()" style="width:180px;">
            <option value="">All</option>
            <option value="new">New</option>
            <option value="touch_1_sent">Touch 1</option>
            <option value="touch_3_sent">Touch 3</option>
            <option value="replied">Replied</option>
            <option value="meeting_booked">Meeting</option>
            <option value="not_interested">Not Interested</option>
        </select>

        <label>Search</label>
        <input class="inp" id="f-search" placeholder="Name, company..." oninput="filterPipeline()" style="width:200px;">

        <span id="pipeline-count" style="font-size:11px;color:var(--text-muted);margin-left:auto;font-weight:500;"></span>
    </div>

    <div style="overflow-x:auto;">
        <table class="tbl" id="pipeline-table">
            <thead>
                <tr>
                    <th onclick="sortPipeline('priority_score')">Pri</th>
                    <th onclick="sortPipeline('name')">Name</th>
                    <th>Title</th>
                    <th onclick="sortPipeline('company_name')">Company</th>
                    <th>Persona</th>
                    <th onclick="sortPipeline('stage')">Stage</th>
                    <th onclick="sortPipeline('personalization_score')">P-Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="pipeline-body"></tbody>
        </table>
    </div>
</div>

<!-- ACTIVITY -->
<div class="page" id="page-activity">
    <div class="page-hdr">
        <h1>Activity Timeline</h1>
        <div class="btn-group">
            <select class="sel" id="activity-channel" onchange="loadActivity()" style="width:140px;">
                <option value="">All Channels</option>
                <option value="linkedin">LinkedIn</option>
                <option value="email">Email</option>
                <option value="phone">Phone</option>
            </select>
            <input class="inp" id="activity-search" placeholder="Search..." oninput="loadActivity()" style="width:180px;">
            <button class="btn btn-sm" onclick="loadActivity()">Refresh</button>
        </div>
    </div>
    <div class="kpi-row" id="activity-kpis"></div>
    <div class="timeline" id="activity-timeline"><div class="empty">Loading...</div></div>
</div>

<!-- FLOWS -->
<div class="page" id="page-flows">
    <div class="page-hdr"><h1>Workflows</h1></div>
    <div class="flow-grid" id="flow-cards-grid"></div>
    <div class="card">
        <h3>Recent Runs</h3>
        <div style="overflow-x:auto;">
            <table class="tbl" id="flows-runs-table">
                <thead><tr><th>Flow</th><th>Status</th><th>Steps</th><th>Duration</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="flows-runs-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- LAUNCH BATCH -->
<div class="page" id="page-launch">
    <div class="page-hdr"><h1>Launch New Batch</h1></div>
    <div class="grid2">
        <div class="card">
            <h3>Batch Configuration</h3>
            <div id="launch-error" style="display:none;background:var(--error-bg);border:1px solid var(--error);border-radius:var(--radius-md);padding:12px;margin-bottom:14px;font-size:12px;color:var(--error);"></div>

            <div class="form-row">
                <label>Batch Number</label>
                <input class="inp" id="launch-batch-num" type="number" min="1" value="1" style="width:100%;">
                <div class="err-msg" id="err-batch-num">Batch number must be >= 1</div>
            </div>

            <div class="form-row">
                <label>Target Prospects (1-100)</label>
                <input class="inp" id="launch-target" type="number" min="1" max="100" value="25" style="width:100%;">
                <div class="err-msg" id="err-target">Must be between 1 and 100</div>
            </div>

            <div class="form-row">
                <label>A/B Variable</label>
                <select class="sel" id="launch-ab-var" style="width:100%;">
                    <option value="pain_hook">Pain Hook</option>
                    <option value="proof_point_style">Proof Point Style</option>
                    <option value="opener_style">Opener Style</option>
                    <option value="ask_intensity">Ask Intensity</option>
                    <option value="message_length">Message Length</option>
                </select>
            </div>

            <div class="form-row">
                <label>Group A Description</label>
                <input class="inp" id="launch-group-a" value="Flaky/brittle tests angle" style="width:100%;">
            </div>

            <div class="form-row">
                <label>Group B Description</label>
                <input class="inp" id="launch-group-b" value="Release velocity angle" style="width:100%;">
            </div>

            <div class="form-row">
                <label>Saved Search URL (optional)</label>
                <input class="inp" id="launch-search-url" placeholder="https://www.linkedin.com/sales/search/..." style="width:100%;">
            </div>

            <div class="form-row">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--text-secondary);">
                    <input type="checkbox" id="launch-auto-approve">
                    <span>Auto-approve messages (skip approval gate)</span>
                </label>
            </div>

            <div style="margin-top:20px;display:flex;gap:8px;">
                <button class="btn btn-primary" onclick="launchBatch()" id="launch-btn">Launch Pipeline</button>
            </div>
        </div>

        <div class="card">
            <h3>Previous Batches</h3>
            <div id="batch-list"><div class="empty">Loading...</div></div>
        </div>
    </div>

    <div class="card" id="pre-brief-card" style="display:none;">
        <h3>Pre-Brief (What's Working)</h3>
        <div id="pre-brief-content"></div>
    </div>
</div>

<!-- APPROVAL -->
<div class="page" id="page-approval">
    <div class="page-hdr">
        <h1>Message Approval Queue</h1>
        <div class="btn-group">
            <button class="btn btn-success btn-sm" onclick="confirmBulk('approve')">Approve All</button>
            <button class="btn btn-danger btn-sm" onclick="confirmBulk('reject')">Reject All</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Filter</label>
        <select class="sel" id="approval-filter" onchange="loadApprovalQueue()" style="width:140px;">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="">All</option>
        </select>
        <span id="approval-count" style="font-size:11px;color:var(--text-muted);margin-left:auto;font-weight:500;"></span>
    </div>

    <div id="approval-queue"><div class="empty">No messages pending approval.</div></div>
</div>

<!-- ACCOUNTS -->
<div class="page" id="page-accounts">
    <div class="page-hdr" style="margin-bottom:0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2>Accounts & Research</h2>
            <div style="display:flex;gap:8px">
                <button class="btn btn-sm btn-primary" onclick="showPage('flow-account-research')">Run Research Flow</button>
            </div>
        </div>
        <div class="channel-tabs" id="accounts-tabs">
            <button class="channel-tab-btn active" onclick="switchChannelTab('accounts','list')">Accounts</button>
            <button class="channel-tab-btn" onclick="switchChannelTab('accounts','research')">Research Runs</button>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:16px;">
        <input class="inp" id="accounts-search" placeholder="Search..." oninput="loadAccounts()" style="width:200px;flex:0;">
        <button class="btn btn-sm btn-primary" onclick="showAddAccountModal()">+ Add Account</button>
        <button class="btn btn-sm" onclick="loadAccounts()">Refresh</button>
    </div>

    <div style="overflow-x:auto;">
        <table class="tbl" id="accounts-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Domain</th>
                    <th>Industry</th>
                    <th>Employees</th>
                    <th>Tier</th>
                    <th>Intent</th>
                    <th>Contacts</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="accounts-body"></tbody>
        </table>
    </div>
</div>

<!-- CONTACTS -->
<div class="page" id="page-contacts">
    <div class="page-hdr">
        <h1>Contacts</h1>
        <div class="btn-group">
            <button class="btn btn-sm btn-primary" onclick="showImportContactsModal()">Import</button>
            <button class="btn btn-sm btn-primary" onclick="showAddContactModal()">+ Add Contact</button>
            <button class="btn btn-sm" onclick="loadContacts()">Refresh</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Priority</label>
        <select class="sel" id="c-priority" onchange="loadContacts()" style="width:140px;">
            <option value="">All</option>
            <option value="5">Hot</option>
            <option value="4">Warm</option>
            <option value="3">Standard</option>
        </select>

        <label>Persona</label>
        <select class="sel" id="c-persona" onchange="loadContacts()" style="width:140px;">
            <option value="">All</option>
            <option value="qa_leader">QA</option>
            <option value="vp_eng">VP Eng</option>
        </select>

        <label>Has Email</label>
        <select class="sel" id="c-email" onchange="loadContacts()" style="width:140px;">
            <option value="">All</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
        </select>

        <label>Search</label>
        <input class="inp" id="c-search" placeholder="Name, company..." oninput="loadContacts()" style="width:200px;">

        <span id="contacts-count" style="font-size:11px;color:var(--text-muted);margin-left:auto;font-weight:500;"></span>
    </div>

    <div style="overflow-x:auto;">
        <table class="tbl" id="contacts-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Title</th>
                    <th>Company</th>
                    <th>Email</th>
                    <th>Priority</th>
                    <th>Persona</th>
                    <th>Stage</th>
                    <th>P-Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contacts-body"></tbody>
        </table>
    </div>
</div>

<!-- DRAFTS -->
<div class="page" id="page-drafts">
    <div class="page-hdr">
        <h1>Message Drafts</h1>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select class="inp" id="drafts-touch-filter" onchange="loadDraftsFull()" style="width:140px">
                <option value="">All Touches</option>
                <option value="1">Touch 1 - InMail</option>
                <option value="2">Touch 2 - Call</option>
                <option value="3">Touch 3 - Follow-up</option>
                <option value="4">Touch 4 - Call #2</option>
                <option value="6">Touch 6 - Break-up</option>
            </select>
            <input class="inp" id="drafts-search-full" placeholder="Search name/company..." oninput="loadDraftsFull()" style="width:180px">
            <button class="btn btn-sm" onclick="loadDraftsFull()">Refresh</button>
        </div>
    </div>
    <div style="background:var(--info-bg);border-left:3px solid var(--info);border-radius:6px;padding:12px 16px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center">
        <div style="font-size:13px;color:var(--info)"><strong>Tip:</strong> Messages are copied as plain text. In LinkedIn, use Ctrl+Shift+V to paste without formatting.</div>
        <button style="background:none;border:none;color:var(--info);cursor:pointer;font-size:16px;padding:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center" onclick="this.parentElement.style.display='none'">√ó</button>
    </div>
    <div id="pacing-banner" style="background:var(--warning-bg);border-left:3px solid var(--warning);border-radius:6px;padding:12px 16px;margin-bottom:20px;display:none">
        <div style="font-size:13px;color:var(--warning);display:flex;justify-content:space-between;align-items:center">
            <div>
                <strong id="pacing-title">Daily pace</strong>: <span id="pacing-text"></span>
            </div>
            <button style="background:none;border:none;color:var(--warning);cursor:pointer;font-size:16px;padding:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center" onclick="this.parentElement.style.display='none'">√ó</button>
        </div>
    </div>
    <div class="kpi-row" id="drafts-kpis"></div>
    <div id="drafts-list"><div class="empty">Loading...</div></div>
</div>

<!-- QUOTA TRACKER PAGE -->
<div class="page" id="page-quota">
    <div class="page-hdr">
        <h1>Quota Tracker</h1>
    </div>
    <div id="quota-container"><div class="empty">Loading...</div></div>
</div>

<!-- IMPORT RUNBUNDLE PAGE -->
<div class="page" id="page-import">
    <div class="page-hdr"><h1>Import RunBundle</h1></div>
    <div class="card" style="margin-top:16px">
        <p style="color:var(--text-secondary);margin-bottom:16px">Upload a RunBundle v1 JSON file from your prospecting session. This will import prospects, research, and message drafts into the dashboard.</p>
        <div style="display:flex;gap:16px;margin-bottom:16px">
            <div style="flex:1">
                <h4 style="margin-bottom:8px">Upload JSON File</h4>
                <div id="rb-drop-zone" style="border:2px dashed var(--border);border-radius:8px;padding:40px;text-align:center;cursor:pointer" onclick="document.getElementById('rb-file-input').click()">
                    <div style="font-size:32px;margin-bottom:8px">üì¶</div>
                    <p>Drop RunBundle JSON here or click to browse</p>
                    <input type="file" id="rb-file-input" accept=".json" style="display:none" onchange="handleRunBundleFile(event)">
                </div>
            </div>
            <div style="flex:1">
                <h4 style="margin-bottom:8px">Or Paste JSON</h4>
                <textarea id="rb-paste-input" class="inp" rows="8" placeholder='Paste RunBundle JSON here...' style="width:100%;font-family:monospace;font-size:11px"></textarea>
                <button class="btn" style="margin-top:8px" onclick="handleRunBundlePaste()">Parse JSON</button>
            </div>
        </div>
        <div id="rb-preview" style="display:none">
            <h4 style="margin-bottom:8px">Import Preview</h4>
            <div id="rb-preview-stats" style="display:flex;gap:12px;margin-bottom:16px"></div>
            <div id="rb-preview-table" style="max-height:300px;overflow-y:auto;margin-bottom:16px"></div>
            <button class="btn btn-primary" id="rb-import-btn" onclick="executeRunBundleImport()">Import into Dashboard</button>
            <div id="rb-import-result" style="display:none;margin-top:16px"></div>
        </div>
    </div>
</div>

<!-- INTELLIGENCE -->
<div class="page" id="page-intelligence">
    <div class="page-hdr">
        <h1>Intelligence</h1>
        <div class="btn-group">
            <button class="btn btn-sm" onclick="window.print()">Print</button>
            <button class="btn btn-sm" onclick="loadIntelligence()">Refresh</button>
        </div>
    </div>

    <div class="kpi-row" id="intel-kpis"></div>

    <div class="tab-bar" id="intel-tabs">
        <div class="tab-item active" onclick="showIntelTab('breakdowns')">Breakdowns</div>
        <div class="tab-item" onclick="showIntelTab('trends')">Trends</div>
        <div class="tab-item" onclick="showIntelTab('ab')">A/B Results</div>
        <div class="tab-item" onclick="showIntelTab('top')">Top Messages</div>
    </div>

    <div class="tab-content active" id="intel-tab-breakdowns">
        <div class="grid2">
            <div class="card"><h3>Reply Rate by Persona</h3><canvas id="intel-persona"></canvas></div>
            <div class="card"><h3>Reply Rate by Vertical</h3><canvas id="intel-vertical"></canvas></div>
        </div>
        <div class="grid2">
            <div class="card"><h3>Reply Rate by Proof Point</h3><canvas id="intel-proof"></canvas></div>
            <div class="card"><h3>Reply Rate by Personalization Score</h3><canvas id="intel-pscore"></canvas></div>
        </div>
    </div>

    <div class="tab-content" id="intel-tab-trends">
        <div class="card"><h3>Batch Performance Over Time</h3><canvas id="intel-trend"></canvas></div>
        <div class="grid2">
            <div class="card"><h3>Batch Funnel Comparison</h3><canvas id="intel-funnel-compare"></canvas></div>
            <div class="card"><h3>Reply Rate Trend by Batch</h3><canvas id="intel-reply-trend"></canvas></div>
        </div>
    </div>

    <div class="tab-content" id="intel-tab-ab">
        <div class="card"><h3>A/B Test Results Across Batches</h3><div id="intel-ab-table" style="overflow-x:auto;"></div></div>
    </div>

    <div class="tab-content" id="intel-tab-top">
        <div class="card"><h3>Top Performing Messages</h3><div id="intel-top-messages"><div class="empty">Reply data needed to rank messages</div></div></div>
    </div>
</div>

<!-- EXPERIMENTS -->
<div class="page" id="page-experiments">
    <div class="page-hdr"><h1>A/B Experiments</h1></div>
    <div id="experiments-list"><div class="empty">Loading...</div></div>
    <div class="card" style="margin-top:20px;"><h3>A/B Head-to-Head Comparison</h3><canvas id="ab-head-to-head"></canvas></div>
</div>

<!-- SIGNALS -->
<div class="page" id="page-signals">
    <div class="page-hdr">
        <h1>Signals & Re-Engagement</h1>
        <div class="btn-group">
            <button class="btn btn-sm" onclick="showAddSignalForm()">+ Add Signal</button>
            <button class="btn btn-sm" onclick="loadSignals()">Refresh</button>
        </div>
    </div>

    <div class="filters-bar">
        <label>Type</label>
        <select class="sel" id="sig-filter" onchange="loadSignals()" style="width:180px;">
            <option value="">All</option>
            <option value="buyer_intent">Buyer Intent</option>
            <option value="hiring_signal">Hiring</option>
            <option value="funding">Funding</option>
            <option value="competitor_tool">Competitor Tool</option>
            <option value="recently_hired">Recently Hired</option>
            <option value="manual">Manual</option>
        </select>
        <label><input type="checkbox" id="sig-show-actioned" onchange="loadSignals()"> Show actioned</label>
    </div>

    <div id="signals-list"><div class="empty">Loading...</div></div>

    <div id="add-signal-form" style="display:none;" class="card">
        <h3>Add Manual Signal</h3>
        <div class="form-row">
            <label>Contact ID</label>
            <input class="inp" id="sig-contact-id" style="width:100%;" placeholder="Contact ID">
        </div>
        <div class="form-row">
            <label>Signal Type</label>
            <select class="sel" id="sig-new-type" style="width:100%;">
                <option value="buyer_intent">Buyer Intent</option>
                <option value="hiring_signal">Hiring Signal</option>
                <option value="funding">Funding</option>
                <option value="competitor_tool">Competitor Tool</option>
                <option value="manual">Manual / Other</option>
            </select>
        </div>
        <div class="form-row">
            <label>Description</label>
            <input class="inp" id="sig-description" style="width:100%;" placeholder="What did you observe?">
        </div>
        <button class="btn btn-primary btn-sm" onclick="addSignal()">Create Signal</button>
    </div>
</div>

<!-- AGENT LOGS -->
<div class="page" id="page-agents">
    <div class="page-hdr">
        <h1>Agent Run History</h1>
        <button class="btn btn-sm" onclick="loadAgentRuns()">Refresh</button>
    </div>
    <div style="overflow-x:auto;">
        <table class="tbl">
            <thead>
                <tr><th>Agent</th><th>Type</th><th>Status</th><th>Tokens</th><th>Duration</th><th>Started</th></tr>
            </thead>
            <tbody id="agent-runs-body"></tbody>
        </table>
    </div>
</div>

<!-- LINKEDIN CHANNEL -->
<div class="page" id="page-linkedin">
    <div class="page-hdr" style="margin-bottom:0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2>LinkedIn Channel</h2>
            <div style="display:flex;gap:8px;align-items:center;">
                <div id="li-quota-badge" style="font-size:11px;padding:4px 10px;border-radius:12px;background:var(--bg-elevated);border:1px solid var(--border);"></div>
                <span id="linkedin-dry-run-badge" class="tag tag-warn">DRY RUN ON</span>
            </div>
        </div>
        <div class="channel-tabs" id="linkedin-tabs">
            <button class="channel-tab-btn active" onclick="switchLITab('overview')">Overview</button>
            <button class="channel-tab-btn" onclick="switchLITab('drafts')">Drafts</button>
            <button class="channel-tab-btn" onclick="switchLITab('queue')">Queue</button>
            <button class="channel-tab-btn" onclick="switchLITab('analytics')">Analytics</button>
            <button class="channel-tab-btn" onclick="switchLITab('review')">Review</button>
            <button class="channel-tab-btn" onclick="switchLITab('replies')">Replies</button>
            <button class="channel-tab-btn" onclick="switchLITab('staging')">Staging</button>
            <button class="channel-tab-btn" onclick="switchLITab('memory')">Memory</button>
        </div>
    </div>

    <!-- OVERVIEW TAB -->
    <div class="li-tab-content" id="li-tab-overview">
        <div class="kpi-row" id="linkedin-kpis"></div>

        <!-- Quick Actions -->
        <div class="card" style="margin-bottom:16px;">
            <h3 style="margin-bottom:14px;">Quick Actions</h3>
            <div class="quick-actions-grid">
                <button class="quick-action-btn" onclick="showWorkflowModal('account_research')">
                    <div class="quick-action-title">üîç Account Research</div>
                    <div class="quick-action-desc">Research target companies and ICP fit</div>
                </button>
                <button class="quick-action-btn" onclick="showWorkflowModal('linkedin_message_draft')">
                    <div class="quick-action-title">‚úâÔ∏è Draft Messages</div>
                    <div class="quick-action-desc">Generate personalized InMail drafts</div>
                </button>
                <button class="quick-action-btn" onclick="enhanceBatchDrafts()">
                    <div class="quick-action-title">‚ú® Enhance Batch</div>
                    <div class="quick-action-desc">Second-pass enhancement on current drafts</div>
                </button>
                <button class="quick-action-btn" onclick="switchLITab('queue')">
                    <div class="quick-action-title">üì§ Review Queue</div>
                    <div class="quick-action-desc">Approved messages ready for sending</div>
                </button>
                <button class="quick-action-btn" onclick="showWorkflowModal('call_prep')">
                    <div class="quick-action-title">üìû Call Prep</div>
                    <div class="quick-action-desc">3-line call scripts for cold calls</div>
                </button>
                <button class="quick-action-btn" onclick="switchLITab('analytics')">
                    <div class="quick-action-title">üìä View Analytics</div>
                    <div class="quick-action-desc">Reply rates, conversion funnel, patterns</div>
                </button>
            </div>
        </div>

        <!-- Workflow Explainer -->
        <details class="card" style="margin-bottom:16px;">
            <summary style="cursor:pointer;font-weight:600;font-size:14px;">üí° How the LinkedIn workflow works</summary>
            <div style="margin-top:12px;font-size:12px;color:var(--text-secondary);line-height:1.7;">
                <strong>1. Import prospects</strong> - Upload from Sales Navigator CSV or paste profiles.<br>
                <strong>2. Research enrichment</strong> - Company details, pain indicators, proof points matched to vertical.<br>
                <strong>3. Draft generation</strong> - 5-touch sequences: InMail, Call Script, Follow-up, Call 2, Break-up.<br>
                <strong>4. Enhancement pass</strong> - AI-scored quality check + improvement suggestions per draft.<br>
                <strong>5. Review &amp; approve</strong> - Read each draft, edit if needed, then approve.<br>
                <strong>6. Queue for sending</strong> - Approved drafts move to the Queue tab for manual copy-paste.<br>
                <strong>7. Track &amp; learn</strong> - Log responses, tag what worked, feed insights back into next batch.
            </div>
        </details>

        <!-- Recent Workflow Runs -->
        <div class="card" style="margin-bottom:16px;">
            <h3 style="margin-bottom:14px;">Recent Workflow Runs</h3>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>Workflow</th><th>Status</th><th>Steps</th><th>Duration</th><th>Started</th><th>Actions</th></tr></thead>
                    <tbody id="linkedin-runs-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- DRAFTS TAB -->
    <div class="li-tab-content" id="li-tab-drafts" style="display:none">
        <div class="kpi-row" id="li-drafts-kpis"></div>

        <!-- Filters -->
        <div class="card" style="margin-bottom:16px;padding:12px;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <select class="inp" id="li-draft-filter-touch" onchange="loadLIDrafts()" style="width:auto;min-width:140px;">
                    <option value="">All Touches</option>
                    <option value="inmail">Touch 1 - InMail</option>
                    <option value="call">Call Scripts</option>
                    <option value="inmail_followup">Touch 3 - Follow-up</option>
                    <option value="breakup">Touch 6 - Break-up</option>
                </select>
                <select class="inp" id="li-draft-filter-status" onchange="loadLIDrafts()" style="width:auto;min-width:140px;">
                    <option value="">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="enhanced">Enhanced</option>
                    <option value="approved">Approved</option>
                    <option value="queued">Queued</option>
                </select>
                <input class="inp" id="li-draft-search" placeholder="Search by name or company..." oninput="filterLIDraftsLocal()" style="flex:1;min-width:200px;" />
                <button class="btn btn-sm btn-primary" onclick="approveAllVisible()">Approve All Visible</button>
            </div>
        </div>

        <!-- Draft List -->
        <div id="li-drafts-list"><div class="empty">Loading drafts...</div></div>
        <div id="li-drafts-pagination" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;"></div>
    </div>

    <!-- QUEUE TAB -->
    <div class="li-tab-content" id="li-tab-queue" style="display:none">
        <div class="kpi-row" id="li-queue-kpis"></div>

        <!-- Quota Widget -->
        <div class="card" style="margin-bottom:16px;" id="li-quota-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3>InMail Quota &amp; Pacing</h3>
                <button class="btn btn-sm" onclick="showQuotaSettings()">‚öôÔ∏è Settings</button>
            </div>
            <div id="li-quota-display" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;"></div>
            <div id="li-pacing-guidance" style="margin-top:12px;padding:10px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;color:var(--text-secondary);"></div>
        </div>

        <!-- Queue List -->
        <div id="li-queue-list"><div class="empty">No messages in queue yet. Approve drafts first.</div></div>
    </div>

    <!-- ANALYTICS TAB -->
    <div class="li-tab-content" id="li-tab-analytics" style="display:none">
        <div class="kpi-row" id="li-analytics-kpis"></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <!-- Status Funnel -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Draft Status Funnel</h3>
                <div id="li-status-funnel"></div>
            </div>

            <!-- Touch Type Breakdown -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Drafts by Touch Type</h3>
                <div id="li-touch-breakdown"></div>
            </div>

            <!-- Messaging Patterns -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Proof Points Used</h3>
                <div id="li-proof-points"></div>
            </div>

            <!-- Personalization Scores -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Quality Metrics</h3>
                <div id="li-quality-metrics"></div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="card" style="margin-top:16px;">
            <h3 style="margin-bottom:14px;">Activity Log</h3>
            <div id="li-activity-log" style="max-height:300px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- REVIEW TAB - Swipe-through draft review -->
    <div class="li-tab-content" id="li-tab-review" style="display:none">
        <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>Draft Review Mode</h3>
                <div id="review-progress" style="font-size:13px;color:var(--text-muted);"></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px;">
                <select class="inp" id="review-filter-touch" style="width:auto;min-width:140px;">
                    <option value="">All Touches</option>
                    <option value="inmail">InMail (Touch 1)</option>
                    <option value="call_script">Call Script</option>
                    <option value="follow_up">Follow-up (Touch 3)</option>
                    <option value="break_up">Break-up (Touch 6)</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="startReview()">Start Review</button>
            </div>
        </div>

        <!-- Review Stats -->
        <div class="kpi-row" id="review-stats-kpis" style="margin-bottom:16px;"></div>

        <!-- Current Draft Card -->
        <div id="review-card-container"></div>

        <!-- Keyboard shortcuts help -->
        <div class="card" style="margin-top:16px;padding:12px;">
            <div style="font-size:11px;color:var(--text-muted);display:flex;gap:16px;flex-wrap:wrap;">
                <span><kbd style="background:var(--bg-primary);padding:2px 6px;border-radius:3px;border:1px solid var(--border);">A</kbd> Approve</span>
                <span><kbd style="background:var(--bg-primary);padding:2px 6px;border-radius:3px;border:1px solid var(--border);">R</kbd> Reject</span>
                <span><kbd style="background:var(--bg-primary);padding:2px 6px;border-radius:3px;border:1px solid var(--border);">S</kbd> Skip</span>
                <span><kbd style="background:var(--bg-primary);padding:2px 6px;border-radius:3px;border:1px solid var(--border);">E</kbd> Edit</span>
                <span><kbd style="background:var(--bg-primary);padding:2px 6px;border-radius:3px;border:1px solid var(--border);">Q</kbd> Queue (if approved)</span>
                <span><kbd style="background:var(--bg-primary);padding:2px 6px;border-radius:3px;border:1px solid var(--border);">C</kbd> Copy</span>
            </div>
        </div>
    </div>

    <!-- REPLIES TAB - Reply tracking and feedback loop -->
    <div class="li-tab-content" id="li-tab-replies" style="display:none">
        <div class="kpi-row" id="replies-kpis"></div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <!-- Reply Tag Breakdown -->
            <div class="card">
                <h3 style="margin-bottom:14px;">What Triggered Replies</h3>
                <div id="reply-tag-breakdown"></div>
            </div>
            <!-- Reply Intent -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Reply Sentiment</h3>
                <div id="reply-intent-breakdown"></div>
            </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <!-- By Persona -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Replies by Persona</h3>
                <div id="reply-persona-breakdown"></div>
            </div>
            <!-- By Vertical -->
            <div class="card">
                <h3 style="margin-bottom:14px;">Replies by Vertical</h3>
                <div id="reply-vertical-breakdown"></div>
            </div>
        </div>

        <!-- Reply List -->
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <h3>Reply Log</h3>
                <button class="btn btn-sm btn-primary" onclick="showLogReplyModal()">+ Log Reply</button>
            </div>
            <div id="replies-list"></div>
        </div>
    </div>

    <!-- MEMORY TAB - Outreach learning and patterns -->
    <div class="li-tab-content" id="li-tab-memory" style="display:none">
        <!-- Pre-Brief / Insights -->
        <div class="card" style="margin-bottom:16px;border-left:3px solid var(--accent);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <h3>What's Working (Pre-Brief)</h3>
                <button class="btn btn-sm" onclick="refreshMemory()">Refresh from Data</button>
            </div>
            <div id="memory-insights" style="font-size:13px;line-height:1.8;"></div>
        </div>

        <!-- Memory Patterns by Category -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div class="card">
                <h3 style="margin-bottom:14px;">Proof Points</h3>
                <div id="memory-proof-points"></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:14px;">Opener Styles</h3>
                <div id="memory-openers"></div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div class="card">
                <h3 style="margin-bottom:14px;">Pain Hooks</h3>
                <div id="memory-pain-hooks"></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:14px;">Persona Patterns</h3>
                <div id="memory-personas"></div>
            </div>
        </div>

        <!-- Add Pattern -->
        <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <h3>Manual Observations</h3>
                <button class="btn btn-sm btn-primary" onclick="showAddMemoryModal()">+ Add Pattern</button>
            </div>
            <div id="memory-manual-list"></div>
        </div>
    </div>

    <!-- STAGING TAB - Pre-send preflight and manual sending -->
    <div class="li-tab-content" id="li-tab-staging" style="display:none">
        <div class="kpi-row" id="staging-kpis"></div>

        <div class="card" style="margin-bottom:16px;padding:12px;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:space-between;">
                <h3>Ready to Send</h3>
                <div style="display:flex;gap:8px;">
                    <select class="inp" id="staging-filter-touch" onchange="loadStagingTab()" style="width:auto;min-width:140px;">
                        <option value="">All Touches</option>
                        <option value="inmail">Touch 1 - InMail</option>
                        <option value="inmail_followup">Touch 3 - Follow-up</option>
                        <option value="breakup">Touch 6 - Break-up</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="staging-list"><div class="empty">No staged messages yet. Approve drafts first, then click "Move to Staging" on each.</div></div>
    </div>
</div>

<!-- EMAIL CHANNEL -->
<div class="page" id="page-email">
    <div class="page-hdr" style="margin-bottom:0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2>Email Channel</h2>
            <div style="display:flex;gap:8px;align-items:center;">
                <span id="email-send-badge" style="font-size:11px;padding:4px 10px;border-radius:12px;background:var(--error-bg);border:1px solid var(--error);color:var(--error);">üîí SENDING DISABLED</span>
                <span id="email-dry-run-badge" class="tag tag-warn">DRY RUN ON</span>
            </div>
        </div>
        <div class="channel-tabs" id="email-tabs">
            <button class="channel-tab-btn active" onclick="switchEmailTab('overview')">Overview</button>
            <button class="channel-tab-btn" onclick="switchEmailTab('drafts')">Drafts</button>
            <button class="channel-tab-btn" onclick="switchEmailTab('queue')">Send Queue</button>
            <button class="channel-tab-btn" onclick="switchEmailTab('analytics')">Analytics</button>
            <button class="channel-tab-btn" onclick="switchEmailTab('deliverability')">Deliverability</button>
        </div>
    </div>

    <!-- EMAIL OVERVIEW TAB -->
    <div class="email-tab-content" id="email-tab-overview">
        <div class="kpi-row" id="email-overview-kpis"></div>

        <div class="card" style="margin-bottom:16px;">
            <h3 style="margin-bottom:14px;">Quick Actions</h3>
            <div class="quick-actions-grid">
                <button class="quick-action-btn" onclick="showEmailDraftModal()">
                    <div class="quick-action-title">‚úâÔ∏è Create Email Draft</div>
                    <div class="quick-action-desc">Draft a personalized email for a prospect</div>
                </button>
                <button class="quick-action-btn" onclick="bulkEnhanceEmailDrafts()">
                    <div class="quick-action-title">‚ú® Enhance Drafts</div>
                    <div class="quick-action-desc">AI-powered second pass on email drafts</div>
                </button>
                <button class="quick-action-btn" onclick="switchEmailTab('deliverability')">
                    <div class="quick-action-title">üõ°Ô∏è Health Check</div>
                    <div class="quick-action-desc">Check deliverability and sender reputation</div>
                </button>
                <button class="quick-action-btn" onclick="switchEmailTab('analytics')">
                    <div class="quick-action-title">üìä Analytics</div>
                    <div class="quick-action-desc">Reply rates, bounce rates, performance</div>
                </button>
            </div>
        </div>

        <details class="card" style="margin-bottom:16px;">
            <summary style="cursor:pointer;font-weight:600;font-size:14px;">üí° How the Email workflow works</summary>
            <div style="margin-top:12px;font-size:12px;color:var(--text-secondary);line-height:1.7;">
                <strong>1. Research</strong> - Account and persona research feeds into draft creation.<br>
                <strong>2. Draft</strong> - Create personalized emails with subject, body, and rationale.<br>
                <strong>3. Review</strong> - Quality gates check greeting, personalization, CTA, opt-out.<br>
                <strong>4. Approve</strong> - Human approval required before any email can be queued.<br>
                <strong>5. Preflight</strong> - Automated checks: suppression, deliverability, compliance.<br>
                <strong>6. Send</strong> - Manual send through Gmail. Owner-only testing first.<br>
                <strong>7. Track</strong> - Log replies, bounces, meetings. Feed learnings back.
            </div>
        </details>
    </div>

    <!-- EMAIL DRAFTS TAB -->
    <div class="email-tab-content" id="email-tab-drafts" style="display:none">
        <div class="kpi-row" id="email-drafts-kpis"></div>
        <div class="card" style="margin-bottom:16px;padding:12px;">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <select class="inp" id="email-draft-filter-status" onchange="loadEmailDrafts()" style="width:auto;min-width:140px;">
                    <option value="">All Statuses</option>
                    <option value="needs_review">Needs Review</option>
                    <option value="enhanced">Enhanced</option>
                    <option value="approved">Approved</option>
                    <option value="queued">Queued</option>
                </select>
                <input class="inp" id="email-draft-search" placeholder="Search by name or company..." style="flex:1;min-width:200px;" />
            </div>
        </div>
        <div id="email-drafts-list"><div class="empty">No email drafts yet. Create drafts from the Overview tab.</div></div>
    </div>

    <!-- EMAIL SEND QUEUE TAB -->
    <div class="email-tab-content" id="email-tab-queue" style="display:none">
        <div class="kpi-row" id="email-queue-kpis"></div>
        <div class="card" style="margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <h3>Send Queue</h3>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm" onclick="runEmailTestSend()">üß™ Test Send (Owner Only)</button>
                </div>
            </div>
        </div>
        <div id="email-queue-list"><div class="empty">No emails in queue. Approve drafts and run preflight to add them.</div></div>
    </div>

    <!-- EMAIL ANALYTICS TAB -->
    <div class="email-tab-content" id="email-tab-analytics" style="display:none">
        <div class="kpi-row" id="email-analytics-kpis"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="card">
                <h3 style="margin-bottom:14px;">Top Subjects</h3>
                <div id="email-top-subjects"><div class="empty">No data yet</div></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:14px;">Best Angles</h3>
                <div id="email-best-angles"><div class="empty">No data yet</div></div>
            </div>
        </div>
    </div>

    <!-- EMAIL DELIVERABILITY TAB -->
    <div class="email-tab-content" id="email-tab-deliverability" style="display:none">
        <div class="card" style="margin-bottom:16px;">
            <h3 style="margin-bottom:14px;">Deliverability Health</h3>
            <div id="email-health-checklist"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="card">
                <h3 style="margin-bottom:14px;">Suppression List</h3>
                <div id="email-suppression-stats"><div class="empty">No suppressions</div></div>
            </div>
            <div class="card">
                <h3 style="margin-bottom:14px;">Daily Metrics</h3>
                <div id="email-daily-metrics"><div class="empty">No metrics yet</div></div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Execution Modal -->
<div id="workflow-modal" class="modal">
    <div class="modal-content" style="width:640px;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 id="wf-modal-title">Run Workflow</h3>
            <button class="btn btn-sm" onclick="closeWorkflowModal()">‚úï</button>
        </div>
        <p id="wf-modal-desc" style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;"></p>

        <div id="wf-modal-inputs"></div>

        <div id="wf-modal-result" style="display:none;margin-top:16px;">
            <h3 style="margin-bottom:12px;">Results</h3>
            <div id="wf-modal-result-content"></div>
        </div>

        <div id="wf-modal-steps" style="display:none;margin-top:16px;">
            <h3 style="margin-bottom:8px;">Execution Steps</h3>
            <div id="wf-steps-list"></div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
            <button class="btn btn-sm" onclick="closeWorkflowModal()">Close</button>
            <button class="btn btn-sm btn-primary" id="wf-run-btn" onclick="executeWorkflow()">Run Workflow</button>
        </div>
    </div>
</div>

<!-- Workflow Result Detail Modal -->
<div id="workflow-detail-modal" class="modal">
    <div class="modal-content" style="width:700px;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3>Workflow Run Details</h3>
            <button class="btn btn-sm" onclick="document.getElementById('workflow-detail-modal').style.display='none'">‚úï</button>
        </div>
        <div id="wf-detail-content"></div>
    </div>
</div>

<!-- Log Response Modal -->
<div id="log-response-modal" class="modal">
    <div class="modal-content" style="width:600px;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3>Log Response</h3>
            <button class="btn btn-sm" onclick="document.getElementById('log-response-modal').style.display='none'">‚úï</button>
        </div>
        <div style="display:grid;gap:12px;">
            <div class="form-row">
                <label>Response Type</label>
                <select class="sel" id="resp-type" style="width:100%;">
                    <option value="positive_reply">Positive Reply</option>
                    <option value="question">Question / More Info</option>
                    <option value="referral">Referral to Someone Else</option>
                    <option value="not_interested">Not Interested</option>
                    <option value="out_of_office">Out of Office</option>
                    <option value="bounced">Bounced / Undeliverable</option>
                </select>
            </div>
            <div class="form-row">
                <label>Their Response (paste actual text)</label>
                <textarea class="inp" id="resp-text" style="width:100%;height:100px;resize:vertical;" placeholder="Paste the reply text here..."></textarea>
            </div>
            <div class="form-row">
                <label>Sentiment</label>
                <select class="sel" id="resp-sentiment" style="width:100%;">
                    <option value="very_positive">Very Positive - Ready to meet</option>
                    <option value="positive">Positive - Interested</option>
                    <option value="neutral">Neutral - Asking questions</option>
                    <option value="negative">Negative - Not interested</option>
                </select>
            </div>
            <div class="form-row">
                <label>What Resonated? (what triggered the reply)</label>
                <select class="sel" id="resp-resonated" style="width:100%;">
                    <option value="">Unknown</option>
                    <option value="opener">Personalized Opener</option>
                    <option value="pain_hook">Pain Hook</option>
                    <option value="proof_point">Proof Point / Customer Story</option>
                    <option value="timing">Good Timing</option>
                    <option value="referral">Forwarded / Referral</option>
                </select>
            </div>
            <div class="form-row">
                <label>Interest Level</label>
                <select class="sel" id="resp-interest" style="width:100%;">
                    <option value="high">High - Wants meeting</option>
                    <option value="medium">Medium - Open but not urgent</option>
                    <option value="low">Low - Polite decline</option>
                    <option value="none">None - Hard no</option>
                </select>
            </div>
            <div class="form-row" id="resp-referral-fields" style="display:none;">
                <label>Referral Name</label>
                <input class="inp" id="resp-referral-name" style="width:100%;" placeholder="Name of person they referred to" />
                <label style="margin-top:8px;">Referral Title</label>
                <input class="inp" id="resp-referral-title" style="width:100%;" placeholder="Their title/role" />
            </div>
            <div class="form-row">
                <label>Objection Encountered</label>
                <input class="inp" id="resp-objection" style="width:100%;" placeholder="e.g. 'We already use Selenium'" />
            </div>
            <div class="form-row">
                <label>Notes / Learnings</label>
                <textarea class="inp" id="resp-notes" style="width:100%;height:60px;resize:vertical;" placeholder="Any additional notes or learnings..."></textarea>
            </div>
            <input type="hidden" id="resp-contact-id" />
            <input type="hidden" id="resp-touch-id" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
            <button class="btn btn-sm" onclick="document.getElementById('log-response-modal').style.display='none'">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="submitResponse()">Save Response</button>
        </div>
    </div>
</div>

<!-- Draft Enhancement Modal -->
<div id="enhance-modal" class="modal">
    <div class="modal-content" style="width:640px;max-height:85vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3>Draft Quality Analysis</h3>
            <button class="btn btn-sm" onclick="document.getElementById('enhance-modal').style.display='none'">‚úï</button>
        </div>
        <div id="enhance-loading" style="text-align:center;padding:20px;color:var(--text-secondary);">Analyzing draft...</div>
        <div id="enhance-content" style="display:none;"></div>
    </div>
</div>

<!-- AGENT SWARM -->
<div class="page" id="page-swarm">
    <div class="page-hdr">
        <h1>Agent Swarm</h1>
        <div style="display:flex;gap:10px;">
            <button class="btn btn-sm" onclick="loadSwarmPage()">Refresh</button>
            <button class="btn btn-sm btn-primary" onclick="showLaunchSwarm()">Launch Swarm</button>
        </div>
    </div>

    <div class="kpi-row" id="swarm-kpis"></div>

    <div id="swarm-active" class="card" style="margin-bottom:12px;display:none">
        <h3>Active Swarm Run</h3>
        <div id="swarm-progress"></div>
    </div>

    <div class="card">
        <h3>Run History</h3>
        <div id="swarm-history"></div>
    </div>

    <div id="launch-swarm-modal" class="modal">
        <div class="modal-content">
            <h3>Launch Agent Swarm</h3>
            <div style="display:grid;gap:12px;margin:16px 0;">
                <div>
                    <label style="font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:6px;display:block;">Batch</label>
                    <select class="sel" id="swarm-batch" style="width:100%;"></select>
                </div>
                <div>
                    <label style="font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:6px;display:block;">Max Parallel Workers</label>
                    <input class="inp" id="swarm-workers" type="number" value="3" min="1" max="5" style="width:100%;" />
                </div>
                <div>
                    <label style="font-size:12px;color:var(--text-secondary);font-weight:500;margin-bottom:8px;display:block;">Channels</label>
                    <div style="display:flex;gap:14px;">
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="ch-linkedin" checked />
                            <span>LinkedIn</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:6px;">
                            <input type="checkbox" id="ch-email" checked />
                            <span>Email</span>
                        </label>
                    </div>
                </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn btn-sm" onclick="document.getElementById('launch-swarm-modal').style.display='none'">Cancel</button>
                <button class="btn btn-sm btn-primary" id="btn-launch-swarm" onclick="launchSwarm()">Launch</button>
            </div>
        </div>
    </div>
</div>

<!-- SYSTEM HEALTH -->
<div class="page" id="page-health">
    <div class="page-hdr">
        <h1>System Health</h1>
        <button class="btn btn-sm" onclick="loadHealthPage()">Refresh</button>
    </div>

    <div class="kpi-row" id="health-kpis"></div>

    <div class="card">
        <h3>Feature Flags</h3>
        <div id="feature-flags"></div>
    </div>

    <div class="card">
        <h3>Database Tables</h3>
        <div id="table-counts"></div>
    </div>

    <div class="card">
        <h3>Recent Errors</h3>
        <div id="recent-errors"></div>
    </div>

    <div class="card">
        <h3>Daily Summary</h3>
        <div id="daily-insights"></div>
    </div>
</div>

<!-- SETTINGS -->
<div class="page" id="page-settings">
    <div class="page-hdr"><h1>Settings</h1></div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="showSettingsTab('general')">General</div>
        <div class="tab-item" onclick="showSettingsTab('email')">Email Setup</div>
        <div class="tab-item" onclick="showSettingsTab('flags')">Feature Flags</div>
        <div class="tab-item" onclick="showSettingsTab('api')">API</div>
    </div>

    <div class="tab-content active" id="settings-tab-general">
        <div class="card">
            <h3>User Settings</h3>
            <div class="form-row">
                <label>User Name</label>
                <input class="inp" id="settings-name" style="width:100%;" placeholder="Your name">
            </div>
            <div class="form-row">
                <label>Default Volume Cap (prospects per batch)</label>
                <input class="inp" id="settings-volume" type="number" value="25" style="width:100%;">
            </div>
            <div class="form-row">
                <label>Quality Bar Level</label>
                <select class="sel" id="settings-quality" style="width:100%;">
                    <option value="high">High (strictest)</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low (fastest)</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm" onclick="saveGeneralSettings()">Save</button>
        </div>
    </div>

    <div class="tab-content" id="settings-tab-email">
        <div class="card">
            <h3>Sender Health Checklist</h3>
            <div id="sender-health-checklist"></div>
        </div>
        <div class="card">
            <h3>Sender Identities</h3>
            <div id="sender-identities-list"></div>
            <button class="btn btn-primary btn-sm" onclick="showAddIdentity()" style="margin-top:12px;">+ Add Sender</button>
        </div>
    </div>

    <div class="tab-content" id="settings-tab-flags">
        <div class="card">
            <h3>Feature Flags</h3>
            <div id="settings-flags-list"></div>
        </div>
    </div>

    <div class="tab-content" id="settings-tab-api">
        <div class="card">
            <h3>API Status</h3>
            <div style="padding:14px 0;">
                <div style="margin-bottom:14px;">
                    <span style="color:var(--text-secondary);font-weight:500;">API URL:</span>
                    <strong id="api-url-display" style="font-family:monospace;font-size:12px;margin-left:8px;"></strong>
                </div>
                <div>
                    <span style="color:var(--text-secondary);font-weight:500;">Status:</span>
                    <span id="api-status-display" class="badge-gn" style="margin-left:8px;">Online</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3>Database Tables</h3>
            <div id="settings-table-counts"></div>
        </div>
    </div>
</div>

<!-- PROSPECTS -->
<div class="page" id="page-prospects">
    <div class="page-hdr"><h1>Prospects</h1>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="showPage('import')">+ Import RunBundle</button>
            <select class="inp" id="prospects-persona-filter" onchange="filterFullProspects()" style="width:140px">
                <option value="">All Personas</option>
                <option value="qa_leader">QA Leaders</option>
                <option value="vp_eng">VP Engineering</option>
            </select>
            <select class="inp" id="prospects-priority-filter" onchange="filterFullProspects()" style="width:130px">
                <option value="">All Priority</option>
                <option value="5">Hot (5)</option>
                <option value="4">Warm (4)</option>
                <option value="3">Standard (3)</option>
            </select>
            <input class="inp" id="prospects-search" placeholder="Search name/company..." oninput="filterFullProspects()" style="width:180px">
        </div>
    </div>
    <div class="kpi-row" id="prospects-kpis"></div>
    <div id="prospects-table-wrap" class="card" style="margin-top:16px">
        <div style="overflow-x:auto">
            <table class="tbl"><thead><tr>
                <th style="width:50px">Pri</th>
                <th>Name</th>
                <th>Title</th>
                <th>Company</th>
                <th>Persona</th>
                <th style="width:80px">LinkedIn</th>
                <th style="width:60px">Drafts</th>
                <th style="width:50px"></th>
            </tr></thead><tbody id="prospects-full-body"></tbody></table>
        </div>
    </div>
    <div id="prospect-detail-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;overflow-y:auto;padding:20px">
        <div style="max-width:800px;margin:20px auto;background:var(--bg-secondary);border-radius:12px;padding:24px;position:relative">
            <button onclick="closeProspectDetail()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer">&times;</button>
            <div id="prospect-detail-content"></div>
        </div>
    </div>
    <div id="prospects-empty" style="display:none;text-align:center;padding:60px 20px;color:var(--text-secondary)">
        <div style="font-size:48px;margin-bottom:16px">üë•</div>
        <h3 style="margin-bottom:8px">No prospects yet</h3>
        <p style="margin-bottom:16px">Import a RunBundle JSON from your prospecting session</p>
        <button class="btn btn-primary" onclick="showPage('import')">Import RunBundle</button>
    </div>
</div>

<!-- RESEARCH RUNS -->
<div class="page" id="page-runs">
    <div class="page-hdr"><h1>Research Runs</h1>
        <button class="btn btn-primary" onclick="showRunWizard()">+ New Research Run</button>
    </div>
    <div class="kpi-row" id="runs-kpis"></div>

    <!-- Run Wizard -->
    <div id="run-wizard" style="display:none">
        <div class="card" style="margin-top:16px">
            <div style="display:flex;gap:8px;margin-bottom:20px">
                <div class="phase-step active" id="wiz-step-upload">1. Upload</div>
                <div class="phase-step" id="wiz-step-validate">2. Validate</div>
                <div class="phase-step" id="wiz-step-config">3. Configure</div>
                <div class="phase-step" id="wiz-step-execute">4. Execute</div>
            </div>

            <!-- Step 1: Upload -->
            <div id="wiz-upload" class="wiz-panel">
                <h3 style="margin-bottom:12px">Upload Prospects</h3>
                <p style="color:var(--text-secondary);margin-bottom:16px">Export leads from Sales Navigator as CSV, or paste LinkedIn profile URLs</p>
                <div style="display:flex;gap:12px;margin-bottom:16px">
                    <div class="tab-item active" onclick="showWizUploadTab('csv')">CSV Upload</div>
                    <div class="tab-item" onclick="showWizUploadTab('paste')">Paste URLs/Data</div>
                </div>
                <div id="wiz-upload-csv" class="tab-content active">
                    <div style="border:2px dashed var(--border);border-radius:var(--radius-lg);padding:40px;text-align:center;margin-bottom:16px;cursor:pointer" onclick="document.getElementById('csv-file-input').click()">
                        <div style="font-size:32px;margin-bottom:8px">üìÅ</div>
                        <p>Drop CSV here or click to browse</p>
                        <p style="color:var(--text-muted);font-size:11px;margin-top:4px">Supports Sales Navigator export format</p>
                        <input type="file" id="csv-file-input" accept=".csv" style="display:none" onchange="handleCSVUpload(event)">
                    </div>
                </div>
                <div id="wiz-upload-paste" class="tab-content" style="display:none">
                    <textarea id="paste-data-input" class="inp" rows="8" placeholder="Paste prospect data here. Format: one per line&#10;Name, Title, Company, LinkedIn URL&#10;&#10;Example:&#10;Jane Smith, Director of QA, Stripe, https://linkedin.com/in/janesmith" style="width:100%;font-family:monospace;font-size:12px"></textarea>
                    <button class="btn" style="margin-top:8px" onclick="handlePasteUpload()">Parse Data</button>
                </div>
                <div id="csv-preview" style="display:none;margin-top:16px">
                    <h4 style="margin-bottom:8px">Preview (<span id="csv-row-count">0</span> rows)</h4>
                    <div style="overflow-x:auto;max-height:300px"><table class="tbl" id="csv-preview-table"></table></div>
                    <button class="btn btn-primary" style="margin-top:12px" onclick="wizGoToValidate()">Continue to Validation ‚Üí</button>
                </div>
            </div>

            <!-- Step 2: Validate -->
            <div id="wiz-validate" class="wiz-panel" style="display:none">
                <h3 style="margin-bottom:12px">Validation Results</h3>
                <div id="validation-summary" style="margin-bottom:16px"></div>
                <div style="overflow-x:auto;max-height:400px"><table class="tbl" id="validation-table"></table></div>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="btn" onclick="wizGoToUpload()">‚Üê Back</button>
                    <button class="btn btn-primary" id="btn-go-config" onclick="wizGoToConfig()">Continue to Configure ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Configure -->
            <div id="wiz-config" class="wiz-panel" style="display:none">
                <h3 style="margin-bottom:12px">Run Configuration</h3>
                <div class="grid2">
                    <div class="form-row">
                        <label>Run Name</label>
                        <input class="inp" id="run-name-input" placeholder="e.g., Batch 4 - FinTech QA Leaders">
                    </div>
                    <div class="form-row">
                        <label>A/B Test Variable</label>
                        <select class="inp" id="ab-variable-select">
                            <option value="pain_hook">Pain Hook (maintenance vs velocity)</option>
                            <option value="proof_point_style">Proof Point (named vs anonymous)</option>
                            <option value="opener_style">Opener (career vs company)</option>
                            <option value="ask_intensity">Ask (direct vs soft)</option>
                            <option value="message_length">Length (tight vs full)</option>
                        </select>
                    </div>
                </div>
                <div class="card" style="background:var(--bg-primary);margin-top:16px;padding:16px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                        <span style="color:var(--success);font-size:18px">üîí</span>
                        <strong>DRY RUN Mode Active</strong>
                    </div>
                    <p style="color:var(--text-secondary);font-size:12px">All outputs are drafts only. No messages will be sent. No LinkedIn actions will be taken.</p>
                </div>
                <div style="display:flex;gap:8px;margin-top:16px">
                    <button class="btn" onclick="wizGoToValidate()">‚Üê Back</button>
                    <button class="btn btn-primary" onclick="wizExecute()">üöÄ Launch Research Run</button>
                </div>
            </div>

            <!-- Step 4: Execute -->
            <div id="wiz-execute" class="wiz-panel" style="display:none">
                <h3 style="margin-bottom:12px">Pipeline Execution</h3>
                <div style="background:var(--bg-primary);border-radius:var(--radius-md);padding:16px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span>Progress</span>
                        <span id="exec-progress-pct">0%</span>
                    </div>
                    <div style="background:var(--bg-elevated);border-radius:4px;height:8px;overflow:hidden">
                        <div id="exec-progress-bar" style="background:var(--accent);height:100%;width:0%;transition:width 300ms ease"></div>
                    </div>
                </div>
                <div id="sop-checklist" style="margin-bottom:16px"></div>
                <div style="background:var(--bg-primary);border-radius:var(--radius-md);padding:12px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:11px;color:var(--text-secondary)" id="exec-logs"></div>
                <div id="exec-result" style="display:none;margin-top:16px"></div>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="btn btn-danger" id="btn-cancel-run" onclick="cancelRun()">Cancel</button>
                    <button class="btn btn-primary" id="btn-view-drafts" style="display:none" onclick="showPage('drafts')">View Drafts ‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Run History -->
    <div class="card" style="margin-top:16px" id="runs-history-card">
        <h3 style="margin-bottom:12px">Run History</h3>
        <div style="overflow-x:auto"><table class="tbl"><thead><tr>
            <th>Run</th><th>Date</th><th>Prospects</th><th>Status</th><th>Drafts</th><th>Progress</th><th>Actions</th>
        </tr></thead><tbody id="runs-history-body"></tbody></table></div>
        <div id="runs-empty" style="display:none;text-align:center;padding:40px;color:var(--text-secondary)">
            <div style="font-size:36px;margin-bottom:12px">üöÄ</div>
            <p>No research runs yet. Click "+ New Research Run" to get started.</p>
        </div>
    </div>
</div>

<!-- ANALYTICS -->
<div class="page" id="page-analytics">
    <div class="page-hdr"><h1>Analytics</h1></div>
    <div class="kpi-row" id="analytics-kpis"></div>
    <div class="card" style="margin-top:16px">
        <div style="display:flex;gap:12px;margin-bottom:16px">
            <div class="tab-item active" onclick="showAnalyticsTab('performance')">Performance</div>
            <div class="tab-item" onclick="showAnalyticsTab('experiments')">A/B Tests</div>
            <div class="tab-item" onclick="showAnalyticsTab('signals')">Signals</div>
        </div>
        <div class="tab-content active" id="analytics-tab-performance">
            <div class="grid2" id="analytics-charts"></div>
            <div id="analytics-breakdown"></div>
        </div>
        <div class="tab-content" id="analytics-tab-experiments">
            <div id="analytics-experiments"></div>
        </div>
        <div class="tab-content" id="analytics-tab-signals">
            <div id="analytics-signals"></div>
        </div>
    </div>
</div>

<!-- SYSTEM -->
<div class="page" id="page-system">
    <div class="page-hdr"><h1>System</h1></div>
    <div class="card" style="margin-top:16px">
        <div style="display:flex;gap:12px;margin-bottom:16px">
            <div class="tab-item active" onclick="showSystemTab('health')">Health</div>
            <div class="tab-item" onclick="showSystemTab('agents')">Agent Logs</div>
            <div class="tab-item" onclick="showSystemTab('email')">Email</div>
            <div class="tab-item" onclick="showSystemTab('linkedin')">LinkedIn</div>
        </div>
        <div class="tab-content active" id="system-tab-health">
            <div class="kpi-row" id="system-health-kpis"></div>
            <div id="system-health-content"></div>
        </div>
        <div class="tab-content" id="system-tab-agents">
            <div style="overflow-x:auto"><table class="tbl"><thead><tr>
                <th>Agent</th><th>Type</th><th>Status</th><th>Duration</th><th>Time</th>
            </tr></thead><tbody id="system-agents-body"></tbody></table></div>
        </div>
        <div class="tab-content" id="system-tab-email">
            <div id="system-email-content"></div>
        </div>
        <div class="tab-content" id="system-tab-linkedin">
            <div id="system-linkedin-content"></div>
        </div>
    </div>
</div>

<!-- DATA (Admin) -->
<div class="page" id="page-data">
    <div class="page-hdr"><h1>Data Management</h1></div>
    <div class="kpi-row" id="data-kpis"></div>
    <div class="grid2" style="margin-top:16px">
        <div class="card">
            <h3 style="margin-bottom:12px">Data Lineage</h3>
            <div id="data-lineage"></div>
        </div>
        <div class="card">
            <h3 style="margin-bottom:12px">Actions</h3>
            <div style="display:flex;flex-direction:column;gap:8px">
                <button class="btn" onclick="exportAllData()">üíæ Export All Data (JSON)</button>
                <button class="btn" onclick="document.getElementById('import-file-input').click()">üì• Import Backup</button>
                <input type="file" id="import-file-input" accept=".json" style="display:none" onchange="handleImportBackup(event)">
                <hr style="border-color:var(--border)">
                <button class="btn btn-danger" onclick="showCleanupPreview()">üóëÔ∏è Clear Seed Data</button>
            </div>
        </div>
    </div>
    <div id="cleanup-preview" style="display:none;margin-top:16px" class="card">
        <h3 style="margin-bottom:12px;color:var(--warning)">‚ö†Ô∏è Cleanup Preview</h3>
        <div id="cleanup-preview-content"></div>
        <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" onclick="document.getElementById('cleanup-preview').style.display='none'">Cancel</button>
            <button class="btn btn-danger" onclick="executeCleanup()">Confirm: Delete Seed Data</button>
        </div>
    </div>
    <div id="cleanup-success-message" style="display:none;margin-top:16px" class="card">
        <div style="display:flex;align-items:center;gap:12px;color:var(--success)">
            <div style="font-size:24px">‚úì</div>
            <div>
                <strong>All seed data cleared.</strong> Only your imported prospects and drafts remain.
            </div>
        </div>
    </div>
</div>

<!-- FLOW: Account Research -->
<div class="page" id="page-flow-account-research">
    <div class="page-hdr">
        <h2>Account Research Flow</h2>
        <p style="color:var(--text-secondary);font-size:12px;margin-top:4px">Guided workflow: Select accounts, generate research, tag and export</p>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:24px" id="flow-ar-steps">
        <div class="flow-step active" id="flow-ar-step-1" onclick="showFlowStep('ar',1)">
            <span class="flow-step-num">1</span> Select Accounts
        </div>
        <div class="flow-step" id="flow-ar-step-2" onclick="showFlowStep('ar',2)">
            <span class="flow-step-num">2</span> Generate Research
        </div>
        <div class="flow-step" id="flow-ar-step-3" onclick="showFlowStep('ar',3)">
            <span class="flow-step-num">3</span> Tag & Export
        </div>
    </div>
    <div id="flow-ar-content-1">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Select Accounts to Research</h3>
            <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                <select id="flow-ar-filter-vertical" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:12px">
                    <option value="">All Verticals</option>
                    <option value="SaaS">SaaS/Tech</option>
                    <option value="FinTech">FinTech</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Retail">Retail</option>
                    <option value="Telecom">Telecom</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="loadFlowAccounts()">Load Accounts</button>
            </div>
            <div id="flow-ar-accounts-list" style="color:var(--text-secondary);font-size:12px">Click "Load Accounts" to see available accounts.</div>
        </div>
    </div>
    <div id="flow-ar-content-2" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Generate Research</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Selected accounts will have company research generated including products, metrics, news, hiring signals, and tech stack.</p>
            <div id="flow-ar-selected-summary" style="margin-bottom:16px"></div>
            <button class="btn btn-primary" onclick="runFlowAccountResearch()" id="flow-ar-generate-btn">Generate Research for Selected Accounts</button>
            <div id="flow-ar-progress" style="margin-top:16px"></div>
        </div>
    </div>
    <div id="flow-ar-content-3" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Tag & Export</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Tag accounts with initiative labels and export to prospect lists.</p>
            <div id="flow-ar-results" style="margin-bottom:16px"></div>
            <div style="display:flex;gap:8px">
                <button class="btn btn-primary" onclick="exportFlowAccountResults()">Export Results</button>
                <button class="btn btn-sm" onclick="showPage('accounts')">View in Accounts</button>
            </div>
        </div>
    </div>
</div>

<!-- FLOW: LinkedIn Draft -->
<div class="page" id="page-flow-linkedin-draft">
    <div class="page-hdr">
        <h2>LinkedIn Draft Flow</h2>
        <p style="color:var(--text-secondary);font-size:12px;margin-top:4px">Guided workflow: Select prospects, verify research, generate drafts, review</p>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:24px" id="flow-li-steps">
        <div class="flow-step active" id="flow-li-step-1" onclick="showFlowStep('li',1)">
            <span class="flow-step-num">1</span> Select Prospects
        </div>
        <div class="flow-step" id="flow-li-step-2" onclick="showFlowStep('li',2)">
            <span class="flow-step-num">2</span> Verify Research
        </div>
        <div class="flow-step" id="flow-li-step-3" onclick="showFlowStep('li',3)">
            <span class="flow-step-num">3</span> Generate Drafts
        </div>
        <div class="flow-step" id="flow-li-step-4" onclick="showFlowStep('li',4)">
            <span class="flow-step-num">4</span> Review
        </div>
    </div>
    <div id="flow-li-content-1">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Select LinkedIn Prospects</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Filter by priority and research completeness to select prospects for LinkedIn outreach.</p>
            <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                <select id="flow-li-filter-priority" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:12px">
                    <option value="">All Priorities</option>
                    <option value="5">Hot (5)</option>
                    <option value="4">Warm (4)</option>
                    <option value="3">Standard (3)</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="loadFlowLinkedInProspects()">Load Prospects</button>
            </div>
            <div id="flow-li-prospects-list" style="color:var(--text-secondary);font-size:12px">Click "Load Prospects" to see available LinkedIn prospects.</div>
        </div>
    </div>
    <div id="flow-li-content-2" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Verify Research</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Review research completeness for each selected prospect. Flag any with incomplete research.</p>
            <div id="flow-li-research-checklist"></div>
        </div>
    </div>
    <div id="flow-li-content-3" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Generate LinkedIn Drafts</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Generate InMail, follow-up, and break-up drafts for selected prospects.</p>
            <div id="flow-li-generate-summary" style="margin-bottom:16px"></div>
            <button class="btn btn-primary" onclick="runFlowLinkedInDrafts()" id="flow-li-generate-btn">Generate Drafts</button>
            <div id="flow-li-progress" style="margin-top:16px"></div>
        </div>
    </div>
    <div id="flow-li-content-4" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Review Generated Drafts</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Review and edit the generated drafts before sending.</p>
            <div id="flow-li-review-drafts"></div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button class="btn btn-primary" onclick="showPage('drafts')">View All Drafts</button>
                <button class="btn btn-sm" onclick="showPage('linkedin')">View LinkedIn Page</button>
            </div>
        </div>
    </div>
</div>

<!-- FLOW: Email Draft -->
<div class="page" id="page-flow-email-draft">
    <div class="page-hdr">
        <h2>Email Draft Flow</h2>
        <p style="color:var(--text-secondary);font-size:12px;margin-top:4px">Guided workflow: Select prospects, verify research, generate email drafts, review</p>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:24px" id="flow-em-steps">
        <div class="flow-step active" id="flow-em-step-1" onclick="showFlowStep('em',1)">
            <span class="flow-step-num">1</span> Select Prospects
        </div>
        <div class="flow-step" id="flow-em-step-2" onclick="showFlowStep('em',2)">
            <span class="flow-step-num">2</span> Verify Research
        </div>
        <div class="flow-step" id="flow-em-step-3" onclick="showFlowStep('em',3)">
            <span class="flow-step-num">3</span> Generate Drafts
        </div>
        <div class="flow-step" id="flow-em-step-4" onclick="showFlowStep('em',4)">
            <span class="flow-step-num">4</span> Review
        </div>
    </div>
    <div id="flow-em-content-1">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Select Email Prospects</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Filter by priority and email verification status.</p>
            <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
                <select id="flow-em-filter-priority" style="background:var(--bg-elevated);color:var(--text-primary);border:1px solid var(--border);padding:6px 10px;border-radius:4px;font-size:12px">
                    <option value="">All Priorities</option>
                    <option value="5">Hot (5)</option>
                    <option value="4">Warm (4)</option>
                    <option value="3">Standard (3)</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="loadFlowEmailProspects()">Load Prospects</button>
            </div>
            <div id="flow-em-prospects-list" style="color:var(--text-secondary);font-size:12px">Click "Load Prospects" to see available email prospects.</div>
        </div>
    </div>
    <div id="flow-em-content-2" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Verify Research</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Verify research completeness and email availability for each prospect.</p>
            <div id="flow-em-research-checklist"></div>
        </div>
    </div>
    <div id="flow-em-content-3" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Generate Email Drafts</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Generate email subject + body for touches 1, 3, 5.</p>
            <div id="flow-em-generate-summary" style="margin-bottom:16px"></div>
            <button class="btn btn-primary" onclick="runFlowEmailDrafts()" id="flow-em-generate-btn">Generate Drafts</button>
            <div id="flow-em-progress" style="margin-top:16px"></div>
        </div>
    </div>
    <div id="flow-em-content-4" style="display:none">
        <div class="card" style="padding:20px">
            <h3 style="margin-bottom:12px">Review Generated Drafts</h3>
            <p style="color:var(--text-secondary);font-size:12px;margin-bottom:16px">Review and edit email drafts before sending.</p>
            <div id="flow-em-review-drafts"></div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button class="btn btn-primary" onclick="showPage('drafts')">View All Drafts</button>
                <button class="btn btn-sm" onclick="showPage('email')">View Email Page</button>
            </div>
        </div>
    </div>
</div>

</div><!-- /main -->
</div><!-- /shell -->

<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Dialogs -->
<div class="confirm-overlay" id="confirm-dialog">
    <div class="confirm-box">
        <h3 id="confirm-title">Confirm</h3>
        <p id="confirm-message">Are you sure?</p>
        <div class="confirm-actions">
            <button class="btn btn-sm" onclick="closeConfirm()">Cancel</button>
            <button class="btn btn-sm btn-primary" id="confirm-yes" onclick="">Confirm</button>
        </div>
    </div>
</div>

<div class="confirm-overlay" id="export-modal">
    <div class="confirm-box" style="width:540px;">
        <h3>Export to CSV</h3>
        <div class="form-row" style="margin-top:16px;">
            <label>Batch</label>
            <select class="sel" id="export-batch" style="width:100%;"><option value="">All contacts</option></select>
        </div>
        <div class="form-row">
            <label>Min Priority</label>
            <select class="sel" id="export-pri" style="width:100%;">
                <option value="">Any</option>
                <option value="4">4+ (Warm/Hot)</option>
                <option value="5">5 (Hot only)</option>
            </select>
        </div>
        <div class="form-row">
            <label>Persona</label>
            <select class="sel" id="export-persona" style="width:100%;">
                <option value="">All</option>
                <option value="qa_leader">QA Leaders</option>
                <option value="vp_eng">VP Eng</option>
            </select>
        </div>
        <div class="form-row">
            <label>Columns (comma-separated, or leave blank for all)</label>
            <input class="inp" id="export-columns" style="width:100%;" placeholder="first_name,last_name,title,email,company,stage...">
        </div>
        <div class="confirm-actions">
            <button class="btn btn-sm" onclick="closeExportModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="doExport()">Download CSV</button>
        </div>
    </div>
</div>

<div id="add-account-modal" class="modal">
    <div class="modal-content">
        <h3>Add Account</h3>
        <div style="display:grid;gap:12px;margin:16px 0;">
            <input class="inp" id="new-account-name" placeholder="Company name" />
            <input class="inp" id="new-account-domain" placeholder="Domain (e.g. acme.com)" />
            <input class="inp" id="new-account-industry" placeholder="Industry" />
            <input class="inp" id="new-account-employees" type="number" placeholder="Employee count" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn btn-sm" onclick="closeAddAccountModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="addAccount()">Create</button>
        </div>
    </div>
</div>

<div id="add-contact-modal" class="modal">
    <div class="modal-content">
        <h3>Add Contact</h3>
        <div style="display:grid;gap:12px;margin:16px 0;">
            <input class="inp" id="new-contact-first" placeholder="First name" />
            <input class="inp" id="new-contact-last" placeholder="Last name" />
            <input class="inp" id="new-contact-title" placeholder="Title" />
            <input class="inp" id="new-contact-company" placeholder="Company" />
            <input class="inp" id="new-contact-email" placeholder="Email" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn btn-sm" onclick="closeAddContactModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="addContact()">Create</button>
        </div>
    </div>
</div>

<div id="import-contacts-modal" class="modal">
    <div class="modal-content" style="width:640px;">
        <h3>Import Contacts</h3>
        <div class="tab-bar" style="margin-top:16px;margin-bottom:12px;">
            <div class="tab-item active" onclick="showImportTab('paste')">Paste URLs</div>
            <div class="tab-item" onclick="showImportTab('csv')">CSV Upload</div>
        </div>
        <div id="import-tab-paste" class="tab-content active">
            <textarea class="inp" id="import-urls" style="width:100%;height:160px;resize:vertical;font-family:monospace;font-size:12px;" placeholder="Paste LinkedIn profile URLs, one per line..."></textarea>
        </div>
        <div id="import-tab-csv" class="tab-content" style="display:none;">
            <input type="file" id="import-csv-file" accept=".csv" style="margin-bottom:12px;" />
            <div style="font-size:11px;color:var(--text-muted);">Expected columns: first_name, last_name, title, company, email, linkedin_url</div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
            <button class="btn btn-sm" onclick="closeImportContactsModal()">Cancel</button>
            <button class="btn btn-sm btn-primary" onclick="importContacts()">Import</button>
        </div>
    </div>
</div>

<script>
const API = window.location.origin;
let apiOnline = false;
let contacts = [], messages = [], batches = [];
let activeRunId = null, sseSource = null, runStartTime = null, timerInterval = null;
const charts = {};
let pipelineSortCol = 'priority_score', pipelineSortDir = 'desc';

async function api(path, opts = {}) {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    try {
        const r = await fetch(API + path, {
            headers: {'Content-Type':'application/json', ...opts.headers},
            ...opts,
            signal: controller.signal,
        });
        clearTimeout(timeout);
        if (!r.ok) {
            const err = await r.json().catch(() => ({detail: r.statusText}));
            throw new Error(err.detail || `HTTP ${r.status}`);
        }
        if (r.headers.get('content-type')?.includes('json')) return r.json();
        return r.text();
    } catch(e) {
        clearTimeout(timeout);
        if (e.name !== 'AbortError') console.warn('API error:', path, e.message);
        return null;
    }
}

async function apiPost(path, body, method='POST') {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 15000);
    try {
        const r = await fetch(API + path, {
            method,
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
            signal: controller.signal,
        });
        clearTimeout(timeout);
        const data = await r.json().catch(() => null);
        if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);
        return data;
    } catch(e) {
        clearTimeout(timeout);
        return {_error: true, message: e.message};
    }
}

function showToast(msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = msg;
    container.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

(async function init() {
    const health = await api('/api/health');
    if (health && health.status === 'healthy') {
        apiOnline = true;
        document.getElementById('mode-badge').innerHTML = '<span class="status-dot"></span><span>Online</span>';
        const tableCount = health.tables ? Object.keys(health.tables).length : 0;
        document.getElementById('api-status').textContent = `v2.0 - ${tableCount} tables`;
    }
    document.getElementById('api-url-display').textContent = API;
    await refreshAll();
    await loadBatches();
    await updateQuotaWidget();
    checkActiveRuns();
})();

async function refreshAll() {
    await Promise.all([loadStats(), loadPipeline(), loadActionQueue(), loadIntelligenceHome(), updateQuotaWidget()]);
}

function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const pageEl = document.getElementById('page-'+id);
    if (pageEl) pageEl.classList.add('active');
    const navItem = document.querySelector(`.nav-item[onclick="showPage('${id}')"]`);
    if (navItem) navItem.classList.add('active');

    if (id === 'prospects') loadProspectsPage();
    if (id === 'runs') loadRunsPage();
    if (id === 'analytics') loadAnalyticsPage();
    if (id === 'system') loadSystemPage();
    if (id === 'data') loadDataPage();
    if (id === 'intelligence') loadIntelligence();
    if (id === 'experiments') loadExperiments();
    if (id === 'signals') loadSignals();
    if (id === 'agents') loadAgentRuns();
    if (id === 'approval') loadApprovalQueue();
    if (id === 'launch') { loadBatches(); loadPreBrief(); }
    if (id === 'linkedin') loadLinkedInPage();
    if (id === 'email') loadEmailPage();
    if (id === 'swarm') loadSwarmPage();
    if (id === 'health') loadHealthPage();
    if (id === 'flows') loadFlows();
    if (id === 'activity') loadActivity();
    if (id === 'accounts') loadAccounts();
    if (id === 'contacts') loadContacts();
    if (id === 'drafts') loadDraftsFull();
    if (id === 'quota') loadQuota();
    if (id === 'import') {};
    if (id === 'settings') loadSettings();
    if (id === 'flow-account-research') loadFlowAccountResearchPage();
    if (id === 'flow-linkedin-draft') loadFlowLinkedInDraftPage();
    if (id === 'flow-email-draft') loadFlowEmailDraftPage();
}

function kpi(label, val, sub = '', onclick = '') {
    const clickStyle = onclick ? 'cursor:pointer;' : '';
    const clickAttr = onclick ? ` onclick="${onclick}" tabindex="0"` : '';
    return `<div class="kpi" style="${clickStyle}"${clickAttr}><div class="kpi-label">${label}</div><div class="kpi-val">${val}</div>${sub ? `<div class="kpi-sub">${sub}</div>` : ''}</div>`;
}

function timeAgo(dateStr) {
    if (!dateStr) return '';
    const diff = Date.now() - new Date(dateStr).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    return `${Math.floor(hrs / 24)}d ago`;
}

function showConfirm(title, message, onConfirm) {
    document.getElementById('confirm-title').textContent = title;
    document.getElementById('confirm-message').textContent = message;
    document.getElementById('confirm-yes').onclick = () => { closeConfirm(); onConfirm(); };
    document.getElementById('confirm-dialog').classList.add('show');
}

function closeConfirm() {
    document.getElementById('confirm-dialog').classList.remove('show');
}

// HOME PAGE
async function loadStats() {
    const stats = await api('/api/stats');
    if (!stats) return;

    // Real metrics only: total contacts, with drafts, touched, and quota remaining
    let realMetricsHtml = [
        kpi('Total Prospects', stats.total_contacts || 0),
        kpi('With Drafts', stats.with_drafts || 0),
        kpi('Touched', stats.touches_sent || 0),
    ].join('');

    document.getElementById('kpi-row').innerHTML = realMetricsHtml;
}

async function loadActionQueue() {
    const q = await api('/api/action-queue');
    const el = document.getElementById('action-queue');
    if (!q || !q.length) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">‚úì</div><strong>All caught up</strong><br>No pending actions</div>';
        document.getElementById('badge-actions').style.display = 'none';
        return;
    }
    document.getElementById('badge-actions').style.display = '';
    document.getElementById('badge-actions').textContent = q.length;
    el.innerHTML = q.slice(0, 12).map(a => {
        const iconClass = a.type === 'overdue_followup' ? 'overdue' : a.type === 'untouched_hot' ? 'hot' : a.type === 'stuck' ? 'stuck' : 'signal';
        const icon = a.type === 'overdue_followup' ? '!' : a.type === 'untouched_hot' ? '‚òÖ' : a.type === 'stuck' ? '‚è±' : '‚ö°';
        return `<div class="action-item">
            <div class="action-icon ${iconClass}">${icon}</div>
            <div style="flex:1;min-width:0;">
                <div><strong>${a.contact || ''}</strong> <span style="color:var(--text-muted);font-size:11px;">${a.company || ''}</span></div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:2px;">${a.action || ''}</div>
            </div>
            ${a.contact_id ? `<button class="btn btn-sm" onclick="event.stopPropagation();openDetail('${a.contact_id}')">View</button>` : ''}
        </div>`;
    }).join('');
}

async function loadIntelligenceHome() {
    const funnel = await api('/api/analytics/pipeline');
    if (!funnel) return;
    if (charts.funnel) charts.funnel.destroy();
    charts.funnel = new Chart(document.getElementById('chart-funnel'), {
        type: 'bar', data: {
            labels: ['Prospects', 'Touched', 'Replied', 'Meetings', 'Opps'],
            datasets: [{
                data: [funnel.total_prospects, funnel.touched, funnel.replied, funnel.meetings, funnel.opportunities],
                backgroundColor: ['#6366f1', '#818cf8', '#10b981', '#f59e0b', '#f97316'],
                borderRadius: 4
            }]
        }, options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            }
        }
    });

    const intel = await api('/api/intelligence');
    if (!intel) return;
    renderMiniChart('chart-persona', intel.by_persona, 'persona');
    renderMiniChart('chart-vertical', intel.by_vertical, 'vertical');
}

function renderMiniChart(canvasId, data, labelKey) {
    if (!data || !data.length) return;
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(document.getElementById(canvasId), {
        type: 'bar', data: {
            labels: data.map(d => d[labelKey] || 'unknown'),
            datasets: [{ label: 'Reply Rate %', data: data.map(d => d.rate || 0), backgroundColor: '#6366f1', borderRadius: 4 }]
        }, options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                y: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 11 } } }
            }
        }
    });
}

// PIPELINE TABLE
async function loadPipeline() {
    document.getElementById('pipeline-body').innerHTML = '<tr><td colspan="8"><div class="empty">Loading...</div></td></tr>';
    const resp = await api('/api/contacts?limit=500');
    const data = resp?.contacts || resp || [];
    if (!data) {
        document.getElementById('pipeline-body').innerHTML = '<tr><td colspan="8"><div class="empty">No data available</div></td></tr>';
        return;
    }
    contacts = data;
    renderPipeline(contacts);
}

function refreshPipeline() { loadPipeline(); }

function sortPipeline(col) {
    if (pipelineSortCol === col) pipelineSortDir = pipelineSortDir === 'desc' ? 'asc' : 'desc';
    else { pipelineSortCol = col; pipelineSortDir = 'desc'; }
    filterPipeline();
}

function renderPipeline(list) {
    const body = document.getElementById('pipeline-body');
    document.getElementById('pipeline-count').textContent = `${list.length} contacts`;
    if (!list.length) { body.innerHTML = '<tr><td colspan="8"><div class="empty">No prospects in pipeline</div></td></tr>'; return; }
    body.innerHTML = list.map(c => {
        const pri = c.priority_score || 0;
        const priClass = pri >= 5 ? 'tag-hot' : pri >= 4 ? 'tag-warm' : 'tag-std';
        const persona = c.persona_type === 'qa_leader' ? 'tag-qa' : 'tag-vp';
        return `<tr onclick="openDetail('${c.id}')">
            <td><span class="tag ${priClass}">${pri}</span></td>
            <td><strong>${c.first_name} ${c.last_name}</strong></td>
            <td style="font-size:12px;color:var(--text-secondary);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${c.title || ''}</td>
            <td>${c.company_name || ''}</td>
            <td><span class="tag ${persona}">${c.persona_type || ''}</span></td>
            <td style="font-size:12px;">${c.stage || 'new'}</td>
            <td>${c.personalization_score || '-'}</td>
            <td>
                <div class="btn-group" onclick="event.stopPropagation()">
                    <button class="btn btn-sm" onclick="agentAction(this,'re-score','${c.id}')">Re-Score</button>
                    <button class="btn btn-sm" onclick="agentAction(this,'run-qc','${c.id}')">QC</button>
                </div>
            </td>
        </tr>`;
    }).join('');
}

function filterPipeline() {
    const pri = document.getElementById('f-priority').value;
    const persona = document.getElementById('f-persona').value;
    const stage = document.getElementById('f-stage').value;
    const search = document.getElementById('f-search').value.toLowerCase();
    let filtered = contacts;
    if (pri) filtered = filtered.filter(c => (c.priority_score || 0) >= parseInt(pri));
    if (persona) filtered = filtered.filter(c => c.persona_type === persona);
    if (stage) filtered = filtered.filter(c => c.stage === stage);
    if (search) filtered = filtered.filter(c =>
        `${c.first_name} ${c.last_name} ${c.title} ${c.company_name}`.toLowerCase().includes(search));

    filtered.sort((a, b) => {
        let av = a[pipelineSortCol], bv = b[pipelineSortCol];
        if (pipelineSortCol === 'name') { av = `${a.first_name} ${a.last_name}`; bv = `${b.first_name} ${b.last_name}`; }
        if (av == null) av = ''; if (bv == null) bv = '';
        const cmp = typeof av === 'number' ? av - bv : String(av).localeCompare(String(bv));
        return pipelineSortDir === 'asc' ? cmp : -cmp;
    });

    renderPipeline(filtered);
}

async function agentAction(btn, action, contactId) {
    const origText = btn.textContent;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span>';
    const r = await apiPost(`/api/contacts/${contactId}/${action}`, {});
    btn.disabled = false;
    btn.textContent = origText;
    if (r && !r._error) {
        showToast(`${action.replace(/-/g, ' ')} complete`, 'success');
        loadPipeline();
    } else {
        showToast(r?.message || `${action} failed`, 'error');
    }
}

async function openDetail(cid) {
    let panel = document.getElementById('detail-panel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'detail-panel';
        panel.className = 'detail-panel';
        document.body.appendChild(panel);
    }
    const [contact, msgs, prep] = await Promise.all([
        api(`/api/contacts/${cid}`),
        api(`/api/contacts/${cid}/messages`),
        api(`/api/contacts/${cid}/prep-card`),
    ]);
    if (!contact) return;
    panel.innerHTML = `
        <button class="detail-close" onclick="document.getElementById('detail-panel').classList.remove('open')">&times;</button>
        <h2>${contact.first_name} ${contact.last_name}</h2>
        <div style="font-size:13px;color:var(--text-secondary);margin-bottom:20px;">${contact.title || ''} ${contact.company_name ? '@ ' + contact.company_name : ''}</div>
        <div class="btn-group" style="margin-bottom:20px;">
            <button class="btn btn-sm" onclick="agentAction(this,'re-score','${cid}')">Re-Score</button>
            <button class="btn btn-sm" onclick="agentAction(this,'run-qc','${cid}')">Run QC</button>
            ${contact.linkedin_url ? `<a class="btn btn-sm" href="${contact.linkedin_url}" target="_blank" rel="noopener">LinkedIn</a>` : ''}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;font-size:12px;">
            <div><span style="color:var(--text-muted);">Priority:</span> <strong>${contact.priority_score || '-'}</strong></div>
            <div><span style="color:var(--text-muted);">Persona:</span> <strong>${contact.persona_type || '-'}</strong></div>
            <div><span style="color:var(--text-muted);">Stage:</span> <strong>${contact.stage || 'new'}</strong></div>
            <div><span style="color:var(--text-muted);">P-Score:</span> <strong>${contact.personalization_score || '-'}</strong></div>
        </div>
        ${prep && prep.pain_hypothesis ? `<div class="card"><h3>Pain Hypothesis</h3><div style="font-size:12px;color:var(--text-secondary);">${prep.pain_hypothesis}</div></div>` : ''}
        ${prep && prep.known_tools?.length ? `<div class="card"><h3>Known Tools</h3><div style="font-size:12px;color:var(--text-secondary);">${prep.known_tools.join(', ')}</div></div>` : ''}
        ${prep && prep.predicted_objection ? `<div class="card"><h3>Predicted Objection</h3><div style="font-size:12px;color:var(--warning);margin-bottom:4px;">${prep.predicted_objection}</div><div style="font-size:12px;color:var(--text-secondary);">${prep.objection_response || ''}</div></div>` : ''}
        <div class="card"><h3>Messages (${msgs?.length || 0})</h3>
            ${(msgs || []).map(m => `
                <div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px;">
                        <span style="color:var(--accent);font-weight:600;">Touch ${m.touch_number} - ${m.channel}</span>
                        <span style="color:${m.qc_passed ? 'var(--success)' : 'var(--error)'}">${m.qc_passed ? '‚úì QC Pass' : '‚úó QC Fail'}</span>
                    </div>
                    ${m.subject_line ? `<div style="font-size:12px;font-weight:600;color:var(--warning);margin-bottom:6px;">${m.subject_line}</div>` : ''}
                    <div style="font-size:12px;color:var(--text-secondary);white-space:pre-wrap;line-height:1.5;">${m.body || ''}</div>
                </div>
            `).join('')}
        </div>
    `;
    panel.classList.add('open');
}

// LAUNCH BATCH
async function loadBatches() {
    const data = await api('/api/batches?limit=20');
    if (!data) return;
    batches = data;
    const el = document.getElementById('batch-list');
    if (!data.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><strong>No batches yet</strong><br>Launch your first one!</div>'; return; }

    const maxNum = Math.max(...data.map(b => b.batch_number || 0));
    document.getElementById('launch-batch-num').value = maxNum + 1;

    const exportSel = document.getElementById('export-batch');
    exportSel.innerHTML = '<option value="">All contacts</option>' + data.map(b =>
        `<option value="${b.id}">Batch ${b.batch_number} (${b.contact_count || 0} contacts)</option>`
    ).join('');

    el.innerHTML = data.map(b => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;">
            <div><strong>Batch ${b.batch_number || '?'}</strong> <span style="color:var(--text-secondary);">${b.contact_count || 0} prospects, ${b.message_count || 0} msgs</span></div>
            <div class="btn-group">
                <span class="tag ${b.status === 'complete' ? 'tag-qa' : 'tag-warm'}">${b.status || 'unknown'}</span>
                <button class="btn btn-sm" onclick="regenerateHTML('${b.id}',this)">Regen HTML</button>
            </div>
        </div>
    `).join('');
}

async function loadPreBrief() {
    const data = await apiPost('/api/pre-brief', {});
    const card = document.getElementById('pre-brief-card');
    if (!data || data._error || !data.data?.insights) { card.style.display = 'none'; return; }
    card.style.display = 'block';
    document.getElementById('pre-brief-content').innerHTML = data.data.insights.map(ins => `
        <div style="display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px;">
            <div style="font-weight:600;color:var(--accent);min-width:150px;">${ins.label || ins.category || ''}</div>
            <div style="color:var(--text-secondary);">${ins.value || ins.insight || ''}</div>
        </div>
    `).join('');
}

async function launchBatch() {
    document.getElementById('launch-error').style.display = 'none';
    document.querySelectorAll('.err-msg').forEach(e => e.classList.remove('show'));
    document.querySelectorAll('.inp.err').forEach(e => e.classList.remove('err'));

    const batchNum = parseInt(document.getElementById('launch-batch-num').value);
    const target = parseInt(document.getElementById('launch-target').value);
    let valid = true;

    if (!batchNum || batchNum < 1) {
        document.getElementById('launch-batch-num').classList.add('err');
        document.getElementById('err-batch-num').classList.add('show');
        valid = false;
    }
    if (!target || target < 1 || target > 100) {
        document.getElementById('launch-target').classList.add('err');
        document.getElementById('err-target').classList.add('show');
        valid = false;
    }
    if (!valid) return;

    const btn = document.getElementById('launch-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Launching...';

    const body = {
        batch_number: batchNum,
        target_count: target,
        ab_variable: document.getElementById('launch-ab-var').value,
        ab_groups: {
            A: document.getElementById('launch-group-a').value,
            B: document.getElementById('launch-group-b').value,
        },
        auto_approve: document.getElementById('launch-auto-approve').checked,
        saved_search_url: document.getElementById('launch-search-url').value || null,
    };

    const result = await apiPost('/api/pipeline/start', body);
    btn.disabled = false;
    btn.textContent = 'Launch Pipeline';

    if (result && !result._error && result.run_id) {
        activeRunId = result.run_id;
        showToast(`Pipeline launched: Batch #${batchNum}`, 'success');
        showPage('home');
        connectSSE(result.run_id);
        showPipelineProgress();
        startTimer();
    } else {
        const errEl = document.getElementById('launch-error');
        errEl.textContent = result?.message || 'Launch failed. Check your configuration.';
        errEl.style.display = 'block';
    }
}

async function regenerateHTML(batchId, btn) {
    if (btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>'; }
    const r = await apiPost(`/api/batches/${batchId}/generate-html`, {});
    if (btn) { btn.disabled = false; btn.textContent = 'Regen HTML'; }
    if (r && !r._error) showToast('HTML regenerated', 'success');
    else showToast(r?.message || 'Regeneration failed', 'error');
}

// PIPELINE PROGRESS
const PHASES = ['initialize', 'pre_brief', 'extract', 'research', 'score', 'ab_assign', 'messages', 'qc', 'approval', 'generate_html', 'finalize'];

function showPipelineProgress() {
    const container = document.getElementById('active-run-container');
    container.style.display = 'block';
    document.getElementById('phase-track').innerHTML = PHASES.map(p =>
        `<div class="phase-step pending" id="phase-${p}" title="${p.replace(/_/g, ' ')}">${p.replace(/_/g, ' ').substring(0, 6)}</div>`
    ).join('');
}

function startTimer() {
    runStartTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        if (!runStartTime) return;
        const elapsed = Math.floor((Date.now() - runStartTime) / 1000);
        const m = Math.floor(elapsed / 60);
        const s = elapsed % 60;
        document.getElementById('run-timer').textContent = `${m}:${s.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
}

function connectSSE(runId) {
    if (sseSource) sseSource.close();
    sseSource = new EventSource(`${API}/api/pipeline/runs/${runId}/stream`);

    sseSource.addEventListener('phase_start', e => {
        const d = JSON.parse(e.data);
        const el = document.getElementById('phase-' + d.phase);
        if (el) el.className = 'phase-step active';
    });

    sseSource.addEventListener('phase_end', e => {
        const d = JSON.parse(e.data);
        const el = document.getElementById('phase-' + d.phase);
        if (el) el.className = 'phase-step done';
        if (d.progress) document.getElementById('progress-fill').style.width = d.progress + '%';
        if (d.detail) document.getElementById('phase-detail').textContent = d.detail;
    });

    sseSource.addEventListener('phase_error', e => {
        const d = JSON.parse(e.data);
        const el = document.getElementById('phase-' + d.phase);
        if (el) el.className = 'phase-step failed';
        document.getElementById('run-status').textContent = 'ERROR: ' + (d.error || 'Unknown error');
    });

    sseSource.addEventListener('run_complete', e => {
        const d = JSON.parse(e.data);
        stopTimer();
        document.getElementById('run-status').textContent = 'Completed';
        showToast('Pipeline run complete!', 'success');
        setTimeout(() => { activeRunId = null; sseSource.close(); document.getElementById('active-run-container').style.display = 'none'; }, 2000);
    });

    sseSource.addEventListener('error', () => {
        stopTimer();
        showToast('Connection lost', 'error');
    });
}

function cancelRun() {
    showConfirm('Cancel Pipeline?', 'This will stop the current run and clean up.', async () => {
        if (activeRunId) {
            await apiPost(`/api/pipeline/runs/${activeRunId}/cancel`, {});
            stopTimer();
            activeRunId = null;
            if (sseSource) sseSource.close();
            document.getElementById('active-run-container').style.display = 'none';
            showToast('Pipeline cancelled', 'warning');
        }
    });
}

function checkActiveRuns() {
    api('/api/pipeline/runs/active').then(data => {
        if (data && data.run_id) {
            activeRunId = data.run_id;
            showPipelineProgress();
            connectSSE(data.run_id);
            startTimer();
        }
    });
}

// ACTIVITY PAGE
async function loadActivity() {
    const channel = document.getElementById('activity-channel')?.value || '';
    const search = document.getElementById('activity-search')?.value || '';
    const url = `/api/activity${channel || search ? '?' : ''}${channel ? `channel=${channel}` : ''}${channel && search ? '&' : ''}${search ? `search=${search}` : ''}`;

    const data = await api(url);
    const kpisEl = document.getElementById('activity-kpis');
    const tlEl = document.getElementById('activity-timeline');

    if (!data || !data.length) {
        if (kpisEl) kpisEl.innerHTML = '';
        if (tlEl) tlEl.innerHTML = '<div class="empty"><div class="empty-icon">üì≠</div><strong>No activity</strong><br>Start your outreach campaign.</div>';
        return;
    }

    if (kpisEl) kpisEl.innerHTML = [
        kpi('Total', data.length),
        kpi('Channels', [...new Set(data.map(d => d.channel))].length),
        kpi('Contacts', [...new Set(data.map(d => d.contact_id))].length),
    ].join('');

    if (tlEl) tlEl.innerHTML = data.map(a => `
        <div style="display:flex;gap:12px;padding:12px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;">
            <div style="flex:1;">
                <div><strong>${a.contact_name || 'Unknown'}</strong> <span class="tag" style="font-size:11px;">${a.channel || 'email'}</span></div>
                <div style="font-size:13px;color:var(--text-secondary);margin-top:4px;">${a.company || ''}</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">${a.action || ''}</div>
                ${a.details ? `<div style="font-size:11px;color:var(--text-muted);margin-top:4px;font-style:italic;">${a.details}</div>` : ''}
            </div>
            <div style="text-align:right;font-size:12px;color:var(--text-secondary);">${timeAgo(a.created_at)}</div>
        </div>
    `).join('');
}

// FLOWS PAGE
async function loadFlows() {
    const [catalog, runs] = await Promise.all([
        api('/api/flows/catalog'),
        api('/api/flows/runs')
    ]);

    const grid = document.getElementById('flow-cards-grid');
    const tbody = document.getElementById('flows-runs-body');

    if (grid) {
        if (!catalog || !catalog.length) {
            grid.innerHTML = '<div class="empty"><div class="empty-icon">üîÑ</div><strong>No flows</strong><br>Create a flow to get started.</div>';
        } else {
            grid.innerHTML = catalog.map(f => `
                <div class="card" style="min-height:180px;display:flex;flex-direction:column;">
                    <div style="flex:1;">
                        <h3 style="margin-top:0;">${f.name || 'Untitled'}</h3>
                        <p style="color:var(--text-secondary);font-size:13px;margin:8px 0;">${f.description || ''}</p>
                        <div style="font-size:12px;color:var(--text-muted);">${f.steps || 0} steps</div>
                    </div>
                    <button class="btn btn-primary btn-sm" style="width:100%;margin-top:12px;">Launch Flow</button>
                </div>
            `).join('');
        }
    }

    if (tbody) {
        if (!runs || !runs.length) {
            tbody.innerHTML = '<tr><td colspan="6"><div class="empty">No runs yet</div></td></tr>';
        } else {
            tbody.innerHTML = runs.map(r => `
                <tr>
                    <td>${r.flow_type || ''}</td>
                    <td><span class="badge-${r.status === 'completed' ? 'gn' : r.status === 'running' ? 'bl' : 'yw'}">${r.status || 'unknown'}</span></td>
                    <td>${r.steps_completed || 0}/${r.total_steps || 0}</td>
                    <td>${r.duration_seconds || 0}s</td>
                    <td style="font-size:12px;">${timeAgo(r.started_at)}</td>
                </tr>
            `).join('');
        }
    }
}

// APPROVAL QUEUE
async function loadApprovalQueue() {
    const status = document.getElementById('approval-filter')?.value || 'pending';
    const data = await api(`/api/drafts?status=${status}`);

    const el = document.getElementById('approval-queue');
    const count = document.getElementById('approval-count');

    if (!data || !data.length) {
        if (el) el.innerHTML = '<div class="empty"><div class="empty-icon">‚úÖ</div><strong>All set!</strong><br>No pending approvals.</div>';
        if (count) count.textContent = '0';
        return;
    }

    if (count) count.textContent = data.length;
    if (el) el.innerHTML = data.map(m => `
        <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
                <div>
                    <h3 style="margin:0;font-size:15px;">${m.subject || '(no subject)'}</h3>
                    <div style="font-size:12px;color:var(--text-secondary);">${m.contact_name || 'Unknown'} ‚Ä¢ ${m.channel || 'email'}</div>
                </div>
                <span class="tag">${m.touch_number || 1}</span>
            </div>
            <div style="background:var(--bg-secondary);padding:10px;border-radius:4px;font-size:13px;margin-bottom:12px;max-height:80px;overflow:hidden;color:var(--text-secondary);">
                ${m.body || '(no preview)'}
            </div>
            <div class="btn-group">
                <button class="btn btn-sm" onclick="showToast('Rejected', 'success')">Reject</button>
                <button class="btn btn-sm btn-primary" onclick="showToast('Approved', 'success')">Approve</button>
            </div>
        </div>
    `).join('');
}

// ACCOUNTS PAGE
async function loadAccounts() {
    const search = document.getElementById('accounts-search')?.value || '';
    let data = await api(`/api/accounts${search ? '?search=' + search : ''}`);
    if (!data || !data.length) data = [];

    const tbody = document.getElementById('accounts-body');
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="8"><div class="empty">No accounts</div></td></tr>';
        return;
    }

    tbody.innerHTML = data.map(a => {
        const intentClass = (a.intent_score || 0) >= 4 ? 'tag-hot' : (a.intent_score || 0) >= 3 ? 'tag-warm' : 'tag-std';
        return `<tr>
            <td><strong>${a.name || ''}</strong></td>
            <td style="font-size:12px;">${a.domain || ''}</td>
            <td style="font-size:12px;">${a.industry || ''}</td>
            <td style="font-size:12px;">${a.employee_count || '-'}</td>
            <td><span class="tag">${a.tier || 'standard'}</span></td>
            <td><span class="tag ${intentClass}">${a.intent_score || 0}</span></td>
            <td style="font-size:12px;">${a.contact_count || 0} contacts</td>
            <td><button class="btn btn-sm" onclick="showToast('Opening account detail', 'success')">View</button></td>
        </tr>`;
    }).join('');
}

// CONTACTS PAGE
async function loadContacts() {
    const pri = document.getElementById('c-priority')?.value || '';
    const persona = document.getElementById('c-persona')?.value || '';
    const email = document.getElementById('c-email')?.value || '';
    const search = document.getElementById('c-search')?.value || '';

    let data = await api('/api/contacts?limit=500');
    data = data?.contacts || data || [];

    let filtered = data;
    if (pri) filtered = filtered.filter(c => (c.priority_score || 0) >= parseInt(pri));
    if (persona) filtered = filtered.filter(c => c.persona_type === persona);
    if (email) filtered = filtered.filter(c => c.email_status === email);
    if (search) {
        const q = search.toLowerCase();
        filtered = filtered.filter(c =>
            `${c.first_name} ${c.last_name} ${c.title} ${c.company_name}`.toLowerCase().includes(q));
    }

    const count = document.getElementById('contacts-count');
    const tbody = document.getElementById('contacts-body');

    if (count) count.textContent = `${filtered.length} contacts`;
    if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty">No contacts match filters</div></td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(c => {
        const pri = c.priority_score || 0;
        const priClass = pri >= 5 ? 'tag-hot' : pri >= 4 ? 'tag-warm' : 'tag-std';
        const persona = c.persona_type === 'qa_leader' ? 'tag-qa' : 'tag-vp';
        return `<tr onclick="openDetail('${c.id}')">
            <td><strong>${c.first_name} ${c.last_name}</strong></td>
            <td style="font-size:12px;">${c.title || ''}</td>
            <td style="font-size:12px;">${c.company_name || ''}</td>
            <td style="font-size:12px;">${c.email || ''}</td>
            <td><span class="tag ${priClass}">${pri}</span></td>
            <td><span class="tag ${persona}">${c.persona_type || 'unknown'}</span></td>
            <td style="font-size:12px;">${c.stage || 'new'}</td>
            <td style="font-size:12px;">${c.personalization_score || '-'}</td>
            <td><button class="btn btn-sm" onclick="event.stopPropagation(); openDetail('${c.id}')">Open</button></td>
        </tr>`;
    }).join('');
}

// DRAFTS PAGE
async function loadDrafts() {
    // Redirect to new enhanced drafts loader
    return loadDraftsFull();
}

// INTELLIGENCE PAGE
async function loadIntelligence() {
    const [persona, vertical, proof, pscore, expt, topMsgs, trend] = await Promise.all([
        api('/api/analytics/reply-rates?group=persona'),
        api('/api/analytics/reply-rates?group=vertical'),
        api('/api/analytics/reply-rates?group=proof_point'),
        api('/api/analytics/reply-rates?group=personalization_score'),
        api('/api/analytics/experiments'),
        api('/api/analytics/top-messages'),
        api('/api/analytics/trends')
    ]);

    const kpisEl = document.getElementById('intel-kpis');
    if (kpisEl) {
        const overall = persona && persona.overall ? persona.overall : {};
        kpisEl.innerHTML = [
            kpi('Reply Rate', `${(overall.rate || 0).toFixed(1)}%`),
            kpi('Total Touches', overall.touches || 0),
            kpi('Total Replies', overall.replies || 0),
        ].join('');
    }

    // Persona chart
    if (persona && persona.length) {
        if (charts['intel-persona']) charts['intel-persona'].destroy();
        charts['intel-persona'] = new Chart(document.getElementById('intel-persona'), {
            type: 'bar', data: {
                labels: persona.map(p => p.persona || 'unknown'),
                datasets: [{label: 'Reply Rate %', data: persona.map(p => p.rate || 0), backgroundColor: '#6366f1', borderRadius: 4}]
            }, options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    // Vertical chart
    if (vertical && vertical.length) {
        if (charts['intel-vertical']) charts['intel-vertical'].destroy();
        charts['intel-vertical'] = new Chart(document.getElementById('intel-vertical'), {
            type: 'bar', data: {
                labels: vertical.map(v => v.vertical || 'unknown'),
                datasets: [{label: 'Reply Rate %', data: vertical.map(v => v.rate || 0), backgroundColor: '#10b981', borderRadius: 4}]
            }, options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    // Proof point chart
    if (proof && proof.length) {
        if (charts['intel-proof']) charts['intel-proof'].destroy();
        charts['intel-proof'] = new Chart(document.getElementById('intel-proof'), {
            type: 'bar', data: {
                labels: proof.map(p => p.proof_point || 'unknown').slice(0, 6),
                datasets: [{label: 'Reply Rate %', data: proof.map(p => p.rate || 0).slice(0, 6), backgroundColor: '#f59e0b', borderRadius: 4}]
            }, options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10 } } }
                }
            }
        });
    }

    // Personalization score chart
    if (pscore && pscore.length) {
        if (charts['intel-pscore']) charts['intel-pscore'].destroy();
        charts['intel-pscore'] = new Chart(document.getElementById('intel-pscore'), {
            type: 'bar', data: {
                labels: pscore.map(p => 'Score ' + (p.score || '?')),
                datasets: [{label: 'Reply Rate %', data: pscore.map(p => p.rate || 0), backgroundColor: '#8b5cf6', borderRadius: 4}]
            }, options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                    y: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }

    // Top messages
    const topEl = document.getElementById('intel-top-messages');
    if (topEl) {
        if (!topMsgs || !topMsgs.length) {
            topEl.innerHTML = '<div class="empty">No messages yet</div>';
        } else {
            topEl.innerHTML = topMsgs.slice(0, 5).map((m, i) => `
                <div style="padding:12px;border-bottom:1px solid var(--border);${i === topMsgs.length - 1 ? 'border:none;' : ''}">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                        <strong style="font-size:13px;">${m.subject || '(no subject)'}</strong>
                        <span style="font-size:12px;color:var(--accent);">${m.reply_count || 0} replies</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-secondary);">${m.contact_name || ''}</div>
                </div>
            `).join('');
        }
    }
}

// EXPERIMENTS PAGE
async function loadExperiments() {
    const data = await api('/api/experiments');
    const el = document.getElementById('experiments-list');
    const chartEl = document.getElementById('ab-head-to-head');

    if (!data || !data.length) {
        if (el) el.innerHTML = '<div class="empty"><div class="empty-icon">üß™</div><strong>No experiments</strong><br>Create an A/B test to get started.</div>';
        return;
    }

    if (el) {
        el.innerHTML = data.map(e => `
            <div class="card" style="margin-bottom:12px;">
                <h3 style="margin-top:0;">${e.name || 'Untitled'}</h3>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">Variable: <strong>${e.variable || 'unknown'}</strong></div>
                <div style="display:flex;gap:12px;margin-bottom:12px;">
                    <div style="flex:1;background:var(--bg-secondary);padding:10px;border-radius:4px;">
                        <div style="font-size:11px;color:var(--text-secondary);">Group A</div>
                        <div style="font-size:13px;font-weight:600;">${e.group_a || ''}</div>
                        <div style="font-size:12px;color:var(--accent);margin-top:4px;">${e.group_a_rate || 0}%</div>
                    </div>
                    <div style="flex:1;background:var(--bg-secondary);padding:10px;border-radius:4px;">
                        <div style="font-size:11px;color:var(--text-secondary);">Group B</div>
                        <div style="font-size:13px;font-weight:600;">${e.group_b || ''}</div>
                        <div style="font-size:12px;color:var(--accent);margin-top:4px;">${e.group_b_rate || 0}%</div>
                    </div>
                </div>
                <span class="badge-${e.status === 'active' ? 'bl' : e.status === 'complete' ? 'gn' : 'yw'}">${e.status || 'unknown'}</span>
            </div>
        `).join('');
    }

    if (chartEl && data.length) {
        if (charts['ab-head-to-head']) charts['ab-head-to-head'].destroy();
        charts['ab-head-to-head'] = new Chart(chartEl, {
            type: 'bar', data: {
                labels: data.slice(0, 8).map(e => e.name || 'Exp'),
                datasets: [
                    {label: 'Group A %', data: data.slice(0, 8).map(e => e.group_a_rate || 0), backgroundColor: '#6366f1', borderRadius: 4},
                    {label: 'Group B %', data: data.slice(0, 8).map(e => e.group_b_rate || 0), backgroundColor: '#10b981', borderRadius: 4}
                ]
            }, options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: true, position: 'top' } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#1e2030' }, ticks: { color: '#94a3b8' } },
                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                }
            }
        });
    }
}

// SIGNALS PAGE
async function loadSignals() {
    const data = await api('/api/signals');
    const filter = document.getElementById('sig-filter')?.value || '';
    const showActioned = document.getElementById('sig-show-actioned')?.checked;

    let filtered = data || [];
    if (filter) filtered = filtered.filter(s => s.signal_type === filter);
    if (!showActioned) filtered = filtered.filter(s => !s.actioned);

    const el = document.getElementById('signals-list');
    if (!filtered.length) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">üéØ</div><strong>No signals</strong><br>Signals will appear when triggered.</div>';
        return;
    }

    el.innerHTML = filtered.map(s => `
        <div class="card" style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:start;">
                <div style="flex:1;">
                    <h3 style="margin:0;font-size:14px;">${s.contact_name || 'Unknown'}</h3>
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">${s.signal_type || 'signal'}</div>
                    <div style="font-size:13px;margin-top:8px;">${s.description || ''}</div>
                </div>
                <div style="text-align:right;">
                    ${s.actioned ? '<span class="badge-gn">Actioned</span>' : '<button class="btn btn-sm btn-primary" onclick="showToast(\'Signal actioned\', \'success\')">Act</button>'}
                </div>
            </div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:8px;">${timeAgo(s.detected_at)}</div>
        </div>
    `).join('');
}

// AGENT RUNS PAGE
async function loadAgentRuns() {
    const data = await api('/api/agent-runs');
    const tbody = document.getElementById('agent-runs-body');

    if (!data || !data.length) {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty">No agent runs</div></td></tr>';
        return;
    }

    tbody.innerHTML = data.slice(0, 50).map(r => {
        const statusClass = r.status === 'completed' ? 'badge-gn' : r.status === 'running' ? 'badge-bl' : 'badge-yw';
        return `<tr>
            <td>${r.agent_name || ''}</td>
            <td>${r.run_type || ''}</td>
            <td><span class="${statusClass}">${r.status || 'unknown'}</span></td>
            <td style="font-size:12px;">${r.tokens_used || 0} tokens</td>
            <td style="font-size:12px;">${r.duration_seconds || 0}s</td>
            <td style="font-size:12px;">${timeAgo(r.started_at)}</td>
        </tr>`;
    }).join('');
}

// ‚îÄ‚îÄ‚îÄ EMAIL CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchEmailTab(tab) {
    document.querySelectorAll('.email-tab-content').forEach(el => el.style.display = 'none');
    const target = document.getElementById('email-tab-' + tab);
    if (target) target.style.display = '';
    const emailTabIdx = {overview:0,drafts:1,queue:2,analytics:3,deliverability:4};
    const emailBtns = document.querySelectorAll('#email-tabs .channel-tab-btn');
    emailBtns.forEach(b => b.classList.remove('active'));
    if (emailBtns[emailTabIdx[tab]] !== undefined) emailBtns[emailTabIdx[tab]].classList.add('active');

    if (tab === 'overview') loadEmailOverview();
    else if (tab === 'drafts') loadEmailDrafts();
    else if (tab === 'queue') loadEmailQueue();
    else if (tab === 'analytics') loadEmailAnalytics();
    else if (tab === 'deliverability') loadEmailDeliverability();
}

async function loadEmailPage() {
    loadEmailOverview();
}

async function loadEmailOverview() {
    try {
        const stats = await api('/api/email/stats');
        const kpiEl = document.getElementById('email-overview-kpis');
        if (kpiEl && stats) {
            kpiEl.innerHTML = [
                kpi('Total Drafts', stats.total_drafts || 0, '', "switchEmailTab('drafts')"),
                kpi('Approved', stats.by_status?.approved || 0, '', "switchEmailTab('drafts')"),
                kpi('Queued', stats.by_status?.queued || 0, '', "switchEmailTab('queue')"),
                kpi('Sent', stats.total_sent || 0),
                kpi('Reply Rate', (stats.reply_rate || 0).toFixed(1) + '%'),
            ].join('');
        }
    } catch(e) { console.error('Email stats:', e); }
}

async function loadEmailDrafts() {
    const statusFilter = document.getElementById('email-draft-filter-status')?.value || '';
    let url = '/api/email/drafts?limit=50';
    if (statusFilter) url += `&status=${statusFilter}`;

    try {
        const data = await api(url);
        const drafts = data?.drafts || [];

        // KPIs
        const stats = await api('/api/email/stats');
        const kpiEl = document.getElementById('email-drafts-kpis');
        if (kpiEl && stats) {
            const bs = stats.by_status || {};
            kpiEl.innerHTML = [
                kpi('Total', stats.total_drafts || 0),
                kpi('Needs Review', bs.needs_review || 0),
                kpi('Enhanced', bs.enhanced || 0),
                kpi('Approved', bs.approved || 0),
            ].join('');
        }

        const listEl = document.getElementById('email-drafts-list');
        if (!listEl) return;

        if (!drafts.length) {
            listEl.innerHTML = '<div class="empty">No email drafts found. Create one from the Overview tab.</div>';
            return;
        }

        listEl.innerHTML = drafts.map(d => `
            <div class="card" style="margin-bottom:12px;padding:16px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                    <div>
                        <strong>${d.contact_name || 'Unknown'}</strong>
                        <span style="color:var(--text-muted);margin-left:8px;">${d.company_name || ''}</span>
                        <span class="tag" style="margin-left:8px;">${d.status}</span>
                    </div>
                    <div style="display:flex;gap:6px;">
                        ${d.status === 'needs_review' || d.status === 'enhanced' ? `<button class="btn btn-sm btn-primary" onclick="approveEmailDraft('${d.id}')">Approve</button>` : ''}
                        ${d.status === 'approved' ? `<button class="btn btn-sm" onclick="runEmailPreflight('${d.id}')">üîç Preflight</button>` : ''}
                    </div>
                </div>
                <div style="font-size:13px;font-weight:600;margin-bottom:6px;">Subject: ${d.subject || 'No subject'}</div>
                <div style="background:var(--bg-primary);padding:10px;border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;line-height:1.6;max-height:150px;overflow-y:auto;">${d.body_text || ''}</div>
                ${d.opt_out_text ? `<div style="font-size:10px;color:var(--text-muted);margin-top:6px;font-style:italic;">Opt-out: ${d.opt_out_text}</div>` : ''}
            </div>
        `).join('');
    } catch(e) { console.error('Email drafts:', e); }
}

async function approveEmailDraft(draftId) {
    try {
        await apiPost(`/api/email/drafts/${draftId}/approve`, {});
        showToast('Email draft approved');
        loadEmailDrafts();
    } catch(e) { showToast('Failed to approve', 'error'); }
}

async function runEmailPreflight(draftId) {
    try {
        const result = await apiPost(`/api/email/preflight/${draftId}`, {});
        if (result?.passed) {
            showToast('Preflight passed! Adding to send queue...');
            await apiPost('/api/email/send-queue', { draft_id: draftId });
            loadEmailDrafts();
        } else {
            const failed = (result?.checks || []).filter(c => !c.passed);
            showToast(`Preflight failed: ${failed.map(f => f.name).join(', ')}`, 'error');
        }
    } catch(e) { showToast('Preflight error', 'error'); }
}

async function loadEmailQueue() {
    try {
        const data = await api('/api/email/send-queue');
        const items = data?.items || [];
        const kpiEl = document.getElementById('email-queue-kpis');
        if (kpiEl) {
            kpiEl.innerHTML = [
                kpi('In Queue', items.length),
                kpi('Preflight Passed', items.filter(i => i.preflight_passed).length),
            ].join('');
        }

        const listEl = document.getElementById('email-queue-list');
        if (!listEl) return;
        if (!items.length) {
            listEl.innerHTML = '<div class="empty">No emails in queue.</div>';
            return;
        }
        listEl.innerHTML = items.map(i => `
            <div class="card" style="margin-bottom:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>${i.contact_name || ''}</strong> - ${i.subject || 'No subject'}
                    <span class="tag" style="margin-left:8px;">${i.status}</span>
                </div>
                <button class="btn btn-sm" onclick="sendTestEmail('${i.id}')">üß™ Test Send</button>
            </div>
        `).join('');
    } catch(e) { console.error('Email queue:', e); }
}

async function runEmailTestSend() {
    showToast('Test send feature: sends only to owner email (rgorham369@gmail.com)', 'info');
}

async function sendTestEmail(queueId) {
    try {
        const result = await apiPost('/api/email/send-test', { queue_id: queueId });
        if (result?.status === 'logged') {
            showToast('Test send logged (sending disabled in production)');
        } else {
            showToast(result?.message || 'Send test completed', 'info');
        }
    } catch(e) { showToast('Send test failed', 'error'); }
}

async function loadEmailAnalytics() {
    try {
        const data = await api('/api/email/analytics');
        const kpiEl = document.getElementById('email-analytics-kpis');
        if (kpiEl) {
            kpiEl.innerHTML = [
                kpi('Sent', data?.total_sent || 0),
                kpi('Reply Rate', ((data?.reply_rate || 0) * 100).toFixed(1) + '%'),
                kpi('Meeting Rate', ((data?.meeting_rate || 0) * 100).toFixed(1) + '%'),
                kpi('Bounce Rate', ((data?.bounce_rate || 0) * 100).toFixed(1) + '%'),
            ].join('');
        }
    } catch(e) { console.error('Email analytics:', e); }
}

async function loadEmailDeliverability() {
    try {
        const data = await api('/api/email/deliverability');
        const checkEl = document.getElementById('email-health-checklist');
        if (checkEl && data) {
            const checks = data.checklist || {};
            checkEl.innerHTML = `
                <div style="display:grid;gap:8px;">
                    <div style="padding:8px 12px;background:${checks.spf_configured ? 'var(--success-bg)' : 'var(--error-bg)'};border-radius:var(--radius-sm);font-size:12px;">
                        ${checks.spf_configured ? '‚úÖ' : '‚ùå'} SPF Record Configured
                    </div>
                    <div style="padding:8px 12px;background:${checks.dkim_configured ? 'var(--success-bg)' : 'var(--error-bg)'};border-radius:var(--radius-sm);font-size:12px;">
                        ${checks.dkim_configured ? '‚úÖ' : '‚ùå'} DKIM Signing Active
                    </div>
                    <div style="padding:8px 12px;background:${checks.dmarc_configured ? 'var(--success-bg)' : 'var(--warning-bg)'};border-radius:var(--radius-sm);font-size:12px;">
                        ${checks.dmarc_configured ? '‚úÖ' : '‚ö†Ô∏è'} DMARC Policy (Recommended)
                    </div>
                    <div style="padding:8px 12px;background:${(data.suppression_count || 0) === 0 ? 'var(--success-bg)' : 'var(--warning-bg)'};border-radius:var(--radius-sm);font-size:12px;">
                        ${(data.suppression_count || 0) === 0 ? '‚úÖ' : '‚ö†Ô∏è'} Suppression List: ${data.suppression_count || 0} entries
                    </div>
                    <div style="padding:8px 12px;background:var(--success-bg);border-radius:var(--radius-sm);font-size:12px;">
                        ‚úÖ Send Rate Limiting Active
                    </div>
                </div>
            `;
        }
    } catch(e) { console.error('Deliverability:', e); }
}

function showEmailDraftModal() {
    showToast('Email draft creation coming soon. Use the workflow engine to create drafts.', 'info');
}

async function bulkEnhanceEmailDrafts() {
    showToast('Starting email draft enhancement...', 'info');
    try {
        showToast('Email bulk enhance coming soon', 'info');
    } catch(e) { showToast('Enhance failed', 'error'); }
}

// SWARM PAGE
async function loadSwarmPage() {
    const [runs, tasks] = await Promise.all([
        api('/api/swarm/runs'),
        api('/api/swarm/tasks')
    ]);

    const kpisEl = document.getElementById('swarm-kpis');
    if (kpisEl && runs) {
        const active = runs.filter(r => r.status === 'running').length;
        const completed = runs.filter(r => r.status === 'completed').length;
        kpisEl.innerHTML = [
            kpi('Active', active),
            kpi('Completed', completed),
            kpi('Total', runs.length || 0),
        ].join('');
    }

    const histEl = document.getElementById('swarm-history');
    if (histEl) {
        if (!runs || !runs.length) {
            histEl.innerHTML = '<div class="empty">No swarm runs yet</div>';
        } else {
            histEl.innerHTML = runs.slice(0, 20).map(r => `
                <div style="padding:12px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;align-items:start;">
                        <div>
                            <h3 style="margin:0;font-size:14px;">${r.name || 'Swarm Run'}</h3>
                            <div style="font-size:12px;color:var(--text-secondary);">${r.task_count || 0} tasks</div>
                        </div>
                        <span class="badge-${r.status === 'completed' ? 'gn' : r.status === 'running' ? 'bl' : 'yw'}">${r.status || 'unknown'}</span>
                    </div>
                </div>
            `).join('');
        }
    }
}

// HEALTH PAGE
async function loadHealthPage() {
    const [health, flags, errors, insights] = await Promise.all([
        api('/api/health'),
        api('/api/feature-flags'),
        api('/api/errors'),
        api('/api/insights/daily')
    ]);

    const kpisEl = document.getElementById('health-kpis');
    if (kpisEl && health) {
        kpisEl.innerHTML = [
            kpi('Status', health.status === 'healthy' ? '‚úì Healthy' : '‚úó Issues'),
            kpi('Tables', health.tables ? Object.keys(health.tables).length : 0),
            kpi('Uptime', health.uptime ? (health.uptime.toFixed(2) + '%') : '-'),
        ].join('');
    }

    const flagEl = document.getElementById('feature-flags');
    if (flagEl) {
        if (!flags || !flags.length) {
            flagEl.innerHTML = '<div class="empty">No feature flags</div>';
        } else {
            flagEl.innerHTML = flags.map(f => `
                <div style="padding:10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <strong>${f.name || ''}</strong>
                        ${f.description ? `<div style="font-size:11px;color:var(--text-secondary);">${f.description}</div>` : ''}
                    </div>
                    <span class="badge-${f.enabled ? 'gn' : 'rd'}">
                        ${f.enabled ? 'ON' : 'OFF'}
                    </span>
                </div>
            `).join('');
        }
    }

    const tableEl = document.getElementById('table-counts');
    if (tableEl && health && health.tables) {
        const tables = Object.entries(health.tables);
        tableEl.innerHTML = tables.map(([name, count]) => `
            <div style="padding:10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
                <span style="color:var(--text-secondary);">${name}</span>
                <strong>${count || 0}</strong>
            </div>
        `).join('');
    }

    const errEl = document.getElementById('recent-errors');
    if (errEl) {
        if (!errors || !errors.length) {
            errEl.innerHTML = '<div class="empty">No recent errors</div>';
        } else {
            errEl.innerHTML = errors.slice(0, 10).map(e => `
                <div style="padding:8px;border-bottom:1px solid var(--border);font-size:12px;">
                    <strong>${e.error_type || 'Error'}</strong>
                    <div style="color:var(--text-secondary);margin-top:2px;">${e.message || ''}</div>
                    <div style="color:var(--text-muted);font-size:11px;margin-top:2px;">${timeAgo(e.timestamp)}</div>
                </div>
            `).join('');
        }
    }

    const insEl = document.getElementById('daily-insights');
    if (insEl && insights) {
        insEl.innerHTML = `
            <div style="padding:12px;background:var(--bg-secondary);border-radius:6px;font-size:13px;line-height:1.6;">
                ${insights.summary || 'No insights available'}
            </div>
        `;
    }
}

// SETTINGS PAGE
async function loadSettings() {
    const [health, flags, checklist, identities] = await Promise.all([
        api('/api/health'),
        api('/api/feature-flags'),
        api('/api/sender-health/checklist'),
        api('/api/email/identities')
    ]);

    // Email checklist
    const chkEl = document.getElementById('sender-health-checklist');
    if (chkEl && checklist) {
        chkEl.innerHTML = (checklist.items || []).map(item => `
            <div style="padding:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
                <input type="checkbox" ${item.completed ? 'checked' : ''} />
                <span>${item.name || ''}</span>
            </div>
        `).join('');
    }

    // Sender identities
    const idEl = document.getElementById('sender-identities-list');
    if (idEl && identities && identities.length) {
        idEl.innerHTML = identities.map(id => `
            <div style="padding:10px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <strong>${id.email || ''}</strong>
                    <div style="font-size:11px;color:var(--text-secondary);">${id.domain || ''}</div>
                </div>
                <span class="badge-gn">Active</span>
            </div>
        `).join('');
    }

    // Feature flags
    const flagEl = document.getElementById('settings-flags-list');
    if (flagEl && flags && flags.length) {
        flagEl.innerHTML = flags.map(f => `
            <div style="padding:10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                <strong>${f.name || ''}</strong>
                <span class="badge-${f.enabled ? 'gn' : 'rd'}">${f.enabled ? 'ON' : 'OFF'}</span>
            </div>
        `).join('');
    }

    // Table counts
    const tableEl = document.getElementById('settings-table-counts');
    if (tableEl && health && health.tables) {
        const tables = Object.entries(health.tables);
        tableEl.innerHTML = tables.map(([name, count]) => `
            <div style="padding:10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;">
                <span style="color:var(--text-secondary);">${name}</span>
                <strong>${count || 0}</strong>
            </div>
        `).join('');
    }
}

function showExportModal() { document.getElementById('export-modal').classList.add('show'); }
function closeExportModal() { document.getElementById('export-modal').classList.remove('show'); }
function doExport() { showToast('Export started', 'success'); }

function showAddAccountModal() { document.getElementById('add-account-modal').style.display = 'flex'; }
function closeAddAccountModal() { document.getElementById('add-account-modal').style.display = 'none'; }
function addAccount() { showToast('Account added', 'success'); }

function showAddContactModal() { document.getElementById('add-contact-modal').style.display = 'flex'; }
function closeAddContactModal() { document.getElementById('add-contact-modal').style.display = 'none'; }
function addContact() { showToast('Contact added', 'success'); }

function showImportContactsModal() { document.getElementById('import-contacts-modal').style.display = 'flex'; }
function closeImportContactsModal() { document.getElementById('import-contacts-modal').style.display = 'none'; }
function importContacts() { showToast('Contacts imported', 'success'); }

function showImportTab(tab) {
    document.getElementById('import-tab-paste').style.display = tab === 'paste' ? 'block' : 'none';
    document.getElementById('import-tab-csv').style.display = tab === 'csv' ? 'block' : 'none';
    document.querySelectorAll('#import-contacts-modal .tab-item').forEach((e, i) => {
        e.classList.toggle('active', (i === 0 && tab === 'paste') || (i === 1 && tab === 'csv'));
    });
}

function showAddSignalForm() { document.getElementById('add-signal-form').style.display = 'block'; }
function addSignal() { showToast('Signal created', 'success'); }

function showAddIdentity() { document.getElementById('add-identity-modal').style.display = 'flex'; }
function hideAddIdentity() { document.getElementById('add-identity-modal').style.display = 'none'; }
function createIdentity() { showToast('Identity created', 'success'); }
function addSuppression() { showToast('Email suppressed', 'success'); }

function showLaunchSwarm() { document.getElementById('launch-swarm-modal').style.display = 'flex'; }
function launchSwarm() { showToast('Swarm launched', 'success'); }

function showEmailTab(tab, btn) {
    document.querySelectorAll('#email-tab-identities,#email-tab-suppression,#email-tab-events,#email-tab-pacing').forEach(e => e.style.display = 'none');
    document.getElementById('email-tab-' + tab).style.display = 'block';
    document.querySelectorAll('#page-email .tab-item').forEach(e => e.classList.remove('active'));
    if (btn) btn.classList.add('active');
}
function showIntelTab(tab) {
    document.querySelectorAll('#intel-tab-breakdowns,#intel-tab-trends,#intel-tab-ab,#intel-tab-top').forEach(e => e.classList.remove('active'));
    document.getElementById('intel-tab-' + tab).classList.add('active');
    document.querySelectorAll('.tab-item').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
}

function showSettingsTab(tab) {
    document.querySelectorAll('[id^="settings-tab-"]').forEach(e => e.classList.remove('active'));
    document.getElementById('settings-tab-' + tab).classList.add('active');
    document.querySelectorAll('#page-settings .tab-item').forEach(e => e.classList.remove('active'));
    event.target.classList.add('active');
}

function saveGeneralSettings() { showToast('Settings saved', 'success'); }

function confirmBulk(action) { showConfirm(`${action.charAt(0).toUpperCase() + action.slice(1)} all?`, `Confirm bulk ${action}?`, () => showToast(`All ${action}d`, 'success')); }

// LINKEDIN CHANNEL PAGE
// ‚îÄ‚îÄ‚îÄ LINKEDIN TAB MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let liDraftsCache = [];
let liDraftsPage = 0;
const LI_DRAFTS_PER_PAGE = 20;

function switchLITab(tab) {
    document.querySelectorAll('.li-tab-content').forEach(el => el.style.display = 'none');
    const target = document.getElementById('li-tab-' + tab);
    if (target) target.style.display = '';
    const tabIdx = {overview:0,drafts:1,queue:2,analytics:3,review:4,replies:5,staging:6,memory:7};
    const liBtns = document.querySelectorAll('#linkedin-tabs .channel-tab-btn');
    liBtns.forEach(b => b.classList.remove('active'));
    if (liBtns[tabIdx[tab]] !== undefined) liBtns[tabIdx[tab]].classList.add('active');

    if (tab === 'overview') loadLIOverview();
    else if (tab === 'drafts') loadLIDrafts();
    else if (tab === 'queue') loadLIQueue();
    else if (tab === 'analytics') loadLIAnalytics();
    else if (tab === 'review') loadReviewMode();
    else if (tab === 'replies') loadRepliesTab();
    else if (tab === 'staging') loadStagingTab();
    else if (tab === 'memory') loadMemoryTab();
}

async function loadLinkedInPage() {
    loadLIOverview();
    loadLIQuotaBadge();
}

async function loadLIQuotaBadge() {
    try {
        const q = await api('/api/linkedin/quota');
        const badge = document.getElementById('li-quota-badge');
        if (badge && q) {
            const remaining = q.daily?.remaining ?? '-';
            const verified = q.source && q.source !== 'estimated' && q.last_verified_at;
            const icon = verified ? '‚úÖ' : '‚ö†Ô∏è';
            const label = verified ? 'verified' : 'unverified';
            badge.innerHTML = `üì® ${remaining} InMails left today <span style="font-size:9px;opacity:0.7">(${label})</span>`;
            badge.style.cursor = 'pointer';
            badge.onclick = () => showQuotaUpdateModal();
            if (!verified) {
                badge.style.borderColor = 'var(--warning)';
                badge.style.color = 'var(--warning)';
            } else if (q.daily && q.daily.remaining <= 2) {
                badge.style.borderColor = 'var(--error)';
                badge.style.color = 'var(--error)';
            }
        }
    } catch(e) { /* quota not configured yet */ }
}

// ‚îÄ‚îÄ‚îÄ QUOTA MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCreditsWidget() {
    try {
        const data = await api('/api/quota/credits');
        const el = document.getElementById('quota-remaining');
        const infoEl = document.getElementById('quota-info');
        if (!el || !infoEl) return;
        const remaining = (data.total || 100) - (data.used || 0);
        const verified = data.source === 'manual' && data.last_verified_at;
        el.textContent = remaining;
        infoEl.textContent = `of ${data.total || 100} | Today: ${data.today_used || 0}`;
        if (!verified && remaining < 20) {
            el.style.color = 'var(--warning)';
        }
    } catch(e) { console.error('Credits widget:', e); }
}

function showQuotaUpdateModal() {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'quota-update-modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3>Update Quota Settings</h3>
                <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
            </div>
            <div style="padding:20px">
                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;">
                    Enter the values you see in your Sales Navigator account settings. This ensures the dashboard shows accurate remaining counts.
                </p>
                <div style="display:grid;gap:12px;">
                    <div>
                        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Monthly InMail Credits</label>
                        <input class="inp" id="quota-inmail-monthly" type="number" value="50" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Weekly InMail Limit</label>
                        <input class="inp" id="quota-inmail-weekly" type="number" value="25" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Daily InMail Limit</label>
                        <input class="inp" id="quota-inmail-daily" type="number" value="10" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Workflow Credits (Total)</label>
                        <input class="inp" id="quota-workflow-total" type="number" value="100" style="width:100%">
                    </div>
                    <div style="padding:10px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:11px;color:var(--text-muted);">
                        üí° <strong>Where to find these:</strong> In Sales Navigator, go to your account settings or check the InMail credit section in the top nav. Monthly credits reset on your billing date.
                    </div>
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
                    <button class="btn" onclick="this.closest('.modal').remove()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveQuotaSettings()">Save &amp; Verify</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // Pre-load current values
    api('/api/quota/settings').then(data => {
        if (data?.settings) {
            const s = data.settings.find(s => s.channel === 'linkedin') || {};
            if (s.inmail_monthly_limit) document.getElementById('quota-inmail-monthly').value = s.inmail_monthly_limit;
            if (s.daily_message_limit) document.getElementById('quota-inmail-daily').value = s.daily_message_limit;
            if (s.workflow_credits_limit) document.getElementById('quota-workflow-total').value = s.workflow_credits_limit;
        }
    }).catch(() => {});
}

async function saveQuotaSettings() {
    try {
        await apiPost('/api/quota/settings', {
            channel: 'linkedin',
            inmail_monthly_limit: parseInt(document.getElementById('quota-inmail-monthly').value) || 50,
            daily_message_limit: parseInt(document.getElementById('quota-inmail-daily').value) || 10,
            workflow_credits_limit: parseInt(document.getElementById('quota-workflow-total').value) || 100,
        });
        document.getElementById('quota-update-modal')?.remove();
        showToast('Quota settings updated and verified');
        loadLIQuotaBadge();
        loadCreditsWidget();
    } catch(e) {
        showToast('Failed to save quota settings', 'error');
    }
}

async function loadLIOverview() {
    // KPIs
    try {
        const stats = await api('/api/linkedin/stats');
        const kpiEl = document.getElementById('linkedin-kpis');
        if (stats && kpiEl) {
            kpiEl.innerHTML = [
                kpi('Total Drafts', stats.drafts || 0, '', "switchLITab('drafts')"),
                kpi('Approved', stats.approved_count || 0, '', "switchLITab('drafts');document.getElementById('li-draft-filter-status').value='approved';loadLIDrafts()"),
                kpi('Queued', stats.queued_count || 0, '', "switchLITab('queue')"),
                kpi('Sent', stats.sent_actual || stats.sent || 0, '', "switchLITab('analytics')"),
                kpi('Profiles', stats.profiles || 0, '', "showPage('prospects')"),
            ].join('');
        }
    } catch(e) { console.error('LI stats:', e); }

    // Recent workflow runs
    try {
        const runs = await api('/api/workflow-runs?channel=linkedin&limit=10');
        const runsBody = document.getElementById('linkedin-runs-body');
        if (runsBody) {
            const runList = Array.isArray(runs) ? runs : (runs?.runs || []);
            if (!runList.length) {
                runsBody.innerHTML = '<tr><td colspan="6"><div class="empty">No workflow runs yet. Click a Quick Action to get started.</div></td></tr>';
            } else {
                runsBody.innerHTML = runList.map(r => {
                    const statusClass = r.status === 'succeeded' ? 'badge-gn' : r.status === 'failed' ? 'badge-rd' : r.status === 'running' ? 'badge-bl' : 'badge-yw';
                    const dur = r.duration_ms ? (r.duration_ms / 1000).toFixed(1) + 's' : '-';
                    return `<tr>
                        <td><strong>${r.workflow_name || r.workflow_type || 'Workflow'}</strong></td>
                        <td><span class="${statusClass}">${r.status}</span></td>
                        <td>${r.completed_steps || 0}/${r.total_steps || 0}</td>
                        <td>${dur}</td>
                        <td>${timeAgo(r.started_at)}</td>
                        <td><button class="btn btn-sm" onclick="viewWorkflowRun('${r.id}')">View</button></td>
                    </tr>`;
                }).join('');
            }
        }
    } catch(e) { console.error('LI runs:', e); }
}

async function loadLIDrafts() {
    const touchFilter = document.getElementById('li-draft-filter-touch')?.value || '';
    const statusFilter = document.getElementById('li-draft-filter-status')?.value || '';

    let url = `/api/drafts?channel=linkedin&limit=${LI_DRAFTS_PER_PAGE}&offset=${liDraftsPage * LI_DRAFTS_PER_PAGE}`;
    if (touchFilter) url += `&touch_type=${touchFilter}`;
    if (statusFilter) url += `&approval_status=${statusFilter}`;

    try {
        const data = await api(url);
        const drafts = data?.drafts || [];
        const total = data?.total || 0;
        liDraftsCache = drafts;

        // KPIs for drafts tab
        const kpiEl = document.getElementById('li-drafts-kpis');
        if (kpiEl) {
            const allData = await api('/api/linkedin/stats');
            const byStatus = allData?.by_approval_status || {};
            kpiEl.innerHTML = [
                kpi('Total', total, '', "document.getElementById('li-draft-filter-status').value='';loadLIDrafts()"),
                kpi('Draft', byStatus.draft || 0, '', "document.getElementById('li-draft-filter-status').value='draft';loadLIDrafts()"),
                kpi('Enhanced', byStatus.enhanced || 0, '', "document.getElementById('li-draft-filter-status').value='enhanced';loadLIDrafts()"),
                kpi('Approved', byStatus.approved || 0, '', "document.getElementById('li-draft-filter-status').value='approved';loadLIDrafts()"),
                kpi('Queued', byStatus.queued || 0, '', "document.getElementById('li-draft-filter-status').value='queued';loadLIDrafts()"),
            ].join('');
        }

        renderLIDraftsList(drafts);

        // Pagination
        const pagEl = document.getElementById('li-drafts-pagination');
        if (pagEl) {
            const totalPages = Math.ceil(total / LI_DRAFTS_PER_PAGE);
            pagEl.innerHTML = `
                <span style="font-size:12px;color:var(--text-muted);">Showing ${drafts.length} of ${total} drafts</span>
                <div style="display:flex;gap:6px;">
                    <button class="btn btn-sm" ${liDraftsPage === 0 ? 'disabled' : ''} onclick="liDraftsPage--;loadLIDrafts()">‚Üê Prev</button>
                    <span style="font-size:12px;padding:4px 8px;">Page ${liDraftsPage + 1} of ${totalPages || 1}</span>
                    <button class="btn btn-sm" ${liDraftsPage >= totalPages - 1 ? 'disabled' : ''} onclick="liDraftsPage++;loadLIDrafts()">Next ‚Üí</button>
                </div>
            `;
        }
    } catch(e) {
        console.error('loadLIDrafts:', e);
        document.getElementById('li-drafts-list').innerHTML = '<div class="empty">Error loading drafts.</div>';
    }
}

function renderLIDraftsList(drafts) {
    const el = document.getElementById('li-drafts-list');
    if (!drafts.length) {
        el.innerHTML = '<div class="empty"><div class="empty-icon">‚úâÔ∏è</div><strong>No drafts match your filters</strong></div>';
        return;
    }

    el.innerHTML = drafts.map(d => {
        const name = d.contact_name || `${d.first_name || ''} ${d.last_name || ''}`.trim() || 'Unknown';
        const company = d.company_name || '';
        const statusColor = d.approval_status === 'approved' ? 'var(--success)' :
                           d.approval_status === 'queued' ? 'var(--info, #4da6ff)' :
                           d.approval_status === 'enhanced' ? 'var(--warning)' : 'var(--text-muted)';
        const touchLabel = d.touch_type === 'inmail' ? 'InMail' :
                          d.touch_type === 'call' ? 'Call Script' :
                          d.touch_type === 'inmail_followup' ? 'Follow-up' :
                          d.touch_type === 'breakup' ? 'Break-up' : d.touch_type || '';
        const priority = d.priority_score || 0;
        const priorityBadge = priority >= 5 ? '<span style="color:var(--error);">‚òÖ</span>' :
                             priority >= 4 ? '<span style="color:var(--warning);">‚òÖ</span>' : '';

        return `<div class="card li-draft-card" style="margin-bottom:10px;padding:14px;" data-draft-id="${d.id}" data-name="${name.toLowerCase()}" data-company="${company.toLowerCase()}">
            <div style="display:flex;justify-content:space-between;align-items:start;">
                <div style="flex:1;">
                    <div style="display:flex;gap:8px;align-items:center;">
                        ${priorityBadge}
                        <strong style="font-size:14px;">${name}</strong>
                        <span style="font-size:11px;color:var(--text-muted);">${company}</span>
                        <span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${statusColor}20;color:${statusColor};border:1px solid ${statusColor}40;">${d.approval_status || 'draft'}</span>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">
                        ${touchLabel} (Touch ${d.touch_number || '?'}) ${d.subject_line ? ' ‚Äî <em>' + d.subject_line + '</em>' : ''}
                    </div>
                </div>
                <div style="display:flex;gap:4px;flex-shrink:0;">
                    <button class="btn btn-sm" onclick="toggleDraftExpand('${d.id}')">Expand</button>
                    <button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.body || '')}\`);showToast('Copied!')">Copy</button>
                    ${d.approval_status === 'draft' || d.approval_status === 'enhanced' ?
                        `<button class="btn btn-sm btn-primary" onclick="approveDraft('${d.id}')">Approve</button>` : ''}
                    ${d.approval_status === 'approved' ?
                        `<button class="btn btn-sm" style="background:var(--info-bg);border-color:var(--info);" onclick="moveDraftToStaging('${d.id}')">üì§ Move to Staging</button>` : ''}
                    ${d.approval_status === 'approved' ?
                        `<button class="btn btn-sm" style="background:var(--info,#4da6ff);color:#fff;" onclick="queueDraft('${d.id}')">‚Üí Queue</button>` : ''}
                    <button class="btn btn-sm" style="background:var(--warning-bg);color:var(--warning);" onclick="enhanceDraft('${d.id}')">Enhance</button>
                </div>
            </div>
            <div id="draft-expand-${d.id}" style="display:none;margin-top:12px;">
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;line-height:1.6;max-height:400px;overflow-y:auto;">${d.body || '(empty)'}</div>
                <div style="margin-top:8px;display:flex;gap:12px;font-size:11px;color:var(--text-muted);flex-wrap:wrap;">
                    <span>Words: ${d.word_count || '-'}</span>
                    <span>Chars: ${(d.body || '').length}</span>
                    <span>Proof: ${d.proof_point_used || '-'}</span>
                    <span>P-Score: ${d.personalization_score || '-'}</span>
                    <span>QC: ${d.qc_passed ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                    ${d.linkedin_url ? `<a href="${d.linkedin_url}" target="_blank" style="color:var(--accent);">View LinkedIn ‚Üó</a>` : ''}
                </div>
            </div>
        </div>`;
    }).join('');
}

function toggleDraftExpand(draftId) {
    const el = document.getElementById('draft-expand-' + draftId);
    if (el) el.style.display = el.style.display === 'none' ? '' : 'none';
}

function filterLIDraftsLocal() {
    const q = (document.getElementById('li-draft-search')?.value || '').toLowerCase();
    document.querySelectorAll('.li-draft-card').forEach(card => {
        const name = card.dataset.name || '';
        const company = card.dataset.company || '';
        card.style.display = (!q || name.includes(q) || company.includes(q)) ? '' : 'none';
    });
}

async function approveDraft(draftId) {
    try {
        await apiPost('/api/drafts/' + draftId + '/approve', {});
        showToast('Draft approved!');
        loadLIDrafts();
    } catch(e) {
        showToast('Cannot approve: ' + (e.message || 'validation failed'), 'error');
    }
}

async function approveAllVisible() {
    const cards = document.querySelectorAll('.li-draft-card');
    const ids = [];
    cards.forEach(c => {
        if (c.style.display !== 'none') ids.push(c.dataset.draftId);
    });
    if (!ids.length) return showToast('No visible drafts to approve');
    if (!confirm(`Approve ${ids.length} visible drafts?`)) return;
    try {
        const result = await apiPost('/api/drafts/approve-batch', { draft_ids: ids });
        showToast(`Approved ${result.approved} drafts${result.errors?.length ? ', ' + result.errors.length + ' errors' : ''}`);
        loadLIDrafts();
    } catch(e) { showToast('Batch approve failed', 'error'); }
}

async function queueDraft(draftId) {
    try {
        await apiPost('/api/drafts/' + draftId + '/queue', {});
        showToast('Draft moved to queue!');
        loadLIDrafts();
    } catch(e) { showToast('Cannot queue: ' + (e.message || ''), 'error'); }
}

async function enhanceBatchDrafts() {
    const confirmed = confirm('This will enhance all draft-status messages to improve personalization. Continue?');
    if (!confirmed) return;

    showToast('Starting bulk enhancement...', 'info');
    try {
        const result = await apiPost('/api/drafts/bulk-enhance', {
            filter: { status: 'draft' },
            limit: 50
        });
        showToast(`Enhanced ${result?.enhanced_count || 0} drafts`);
        loadLIDrafts();
    } catch(e) {
        showToast('Bulk enhance failed: ' + (e.message || ''), 'error');
    }
}

// ‚îÄ‚îÄ‚îÄ QUEUE TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLIQueue() {
    // KPIs
    try {
        const stats = await api('/api/linkedin/stats');
        const kpiEl = document.getElementById('li-queue-kpis');
        if (kpiEl) {
            kpiEl.innerHTML = [
                kpi('Queued', stats.queued_count || 0),
                kpi('Sent', stats.sent_actual || 0),
                kpi('Approved (Ready)', stats.approved_count || 0),
            ].join('');
        }
    } catch(e) {}

    // Quota display
    try {
        const q = await api('/api/linkedin/quota');
        const quotaEl = document.getElementById('li-quota-display');
        if (quotaEl && q) {
            quotaEl.innerHTML = ['daily', 'weekly', 'monthly'].map(period => {
                const p = q[period] || {};
                const pct = p.limit ? Math.round((p.sent / p.limit) * 100) : 0;
                const color = pct > 80 ? 'var(--error)' : pct > 50 ? 'var(--warning)' : 'var(--success)';
                return `<div style="text-align:center;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                    <div style="font-size:24px;font-weight:700;color:${color};">${p.remaining ?? '-'}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${period} remaining</div>
                    <div style="font-size:10px;color:var(--text-muted);">${p.sent || 0} / ${p.limit || '-'} used</div>
                    <div style="margin-top:6px;height:4px;background:var(--bg-elevated);border-radius:2px;overflow:hidden;">
                        <div style="width:${pct}%;height:100%;background:${color};border-radius:2px;"></div>
                    </div>
                </div>`;
            }).join('');
        }
        const pacingEl = document.getElementById('li-pacing-guidance');
        if (pacingEl && q) {
            const dailyLeft = q.daily?.remaining || 0;
            if (dailyLeft <= 0) {
                pacingEl.innerHTML = '‚õî <strong>Daily limit reached.</strong> Wait until tomorrow to send more InMails.';
                pacingEl.style.borderLeft = '3px solid var(--error)';
            } else if (dailyLeft <= 3) {
                pacingEl.innerHTML = `‚ö†Ô∏è Only <strong>${dailyLeft}</strong> InMails left today. Consider saving some for follow-ups.`;
                pacingEl.style.borderLeft = '3px solid var(--warning)';
            } else {
                pacingEl.innerHTML = `‚úÖ You can send up to <strong>${dailyLeft}</strong> more InMails today. Pace yourself - spread sends across the day for best deliverability.`;
                pacingEl.style.borderLeft = '3px solid var(--success)';
            }
        }
    } catch(e) {}

    // Load queued drafts
    try {
        const data = await api('/api/drafts?channel=linkedin&approval_status=queued&limit=100');
        const drafts = data?.drafts || [];
        const el = document.getElementById('li-queue-list');
        if (!drafts.length) {
            el.innerHTML = '<div class="empty"><div class="empty-icon">üì§</div><strong>Queue is empty</strong><br>Approve drafts from the Drafts tab to add them here.</div>';
            return;
        }
        el.innerHTML = drafts.map(d => {
            const name = d.contact_name || `${d.first_name || ''} ${d.last_name || ''}`.trim();
            const touchLabel = d.touch_type === 'inmail' ? 'InMail' : d.touch_type === 'inmail_followup' ? 'Follow-up' : d.touch_type === 'breakup' ? 'Break-up' : d.touch_type || '';
            return `<div class="card" style="margin-bottom:10px;padding:16px;">
                <div style="display:flex;justify-content:space-between;align-items:start;">
                    <div>
                        <strong style="font-size:14px;">${name}</strong>
                        <span style="font-size:12px;color:var(--text-muted);margin-left:8px;">${d.company_name || ''}</span>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${touchLabel} (Touch ${d.touch_number || '?'})</div>
                    </div>
                    <div style="display:flex;gap:6px;">
                        ${d.subject_line ? `<button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.subject_line || '')}\`);showToast('Subject copied!')">Copy Subject</button>` : ''}
                        <button class="btn btn-sm btn-primary" onclick="copyToClip(\`${escJs(d.body || '')}\`);showToast('Message copied!')">Copy Message</button>
                        ${d.linkedin_url ? `<button class="btn btn-sm" onclick="window.open('${d.linkedin_url}','_blank')">Open LinkedIn ‚Üó</button>` : ''}
                        <button class="btn btn-sm btn-success" onclick="markDraftSent('${d.id}')">‚úì Mark Sent</button>
                    </div>
                </div>
                <div style="margin-top:10px;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;line-height:1.6;max-height:200px;overflow-y:auto;">${d.body || ''}</div>
            </div>`;
        }).join('');
    } catch(e) { console.error('loadLIQueue:', e); }
}

function showQuotaSettings() {
    const html = `
        <h3>InMail Quota Settings</h3>
        <p style="font-size:12px;color:var(--text-secondary);margin:10px 0;">Set your Sales Navigator InMail limits. These are tracked manually - update them when your quota resets.</p>
        <div style="display:grid;gap:10px;margin-top:14px;">
            <label style="font-size:12px;">Daily limit: <input class="inp" id="quota-daily" type="number" value="10" style="width:80px;margin-left:8px;" /></label>
            <label style="font-size:12px;">Weekly limit: <input class="inp" id="quota-weekly" type="number" value="25" style="width:80px;margin-left:8px;" /></label>
            <label style="font-size:12px;">Monthly limit: <input class="inp" id="quota-monthly" type="number" value="50" style="width:80px;margin-left:8px;" /></label>
        </div>
        <div style="margin-top:14px;display:flex;gap:8px;">
            <button class="btn btn-primary" onclick="saveQuotaSettings()">Save</button>
            <button class="btn" onclick="closeModal()">Cancel</button>
        </div>
    `;
    openGenericModal(html);
}

async function saveQuotaSettings() {
    const daily = parseInt(document.getElementById('quota-daily')?.value) || 10;
    const weekly = parseInt(document.getElementById('quota-weekly')?.value) || 25;
    const monthly = parseInt(document.getElementById('quota-monthly')?.value) || 50;
    await apiPost('/api/linkedin/quota/settings', {
        linkedin_inmail_daily: daily,
        linkedin_inmail_weekly: weekly,
        linkedin_inmail_monthly: monthly
    });
    showToast('Quota settings saved');
    closeModal();
    loadLIQuotaBadge();
}

function openGenericModal(html) {
    let modal = document.getElementById('generic-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'generic-modal';
        modal.className = 'modal';
        modal.innerHTML = '<div class="modal-content" style="width:480px;max-height:80vh;overflow-y:auto;"></div>';
        modal.onclick = e => { if (e.target === modal) closeModal(); };
        document.body.appendChild(modal);
    }
    modal.querySelector('.modal-content').innerHTML = html;
    modal.style.display = 'flex';
}

function closeModal() {
    const m = document.getElementById('generic-modal');
    if (m) m.style.display = 'none';
    // Also close other modals
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
}

// ‚îÄ‚îÄ‚îÄ ANALYTICS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLIAnalytics() {
    try {
        const stats = await api('/api/linkedin/stats');
        const kpiEl = document.getElementById('li-analytics-kpis');
        if (kpiEl && stats) {
            const replyRate = stats.sent_actual ? ((stats.replies || 0) / stats.sent_actual * 100).toFixed(1) : '0.0';
            kpiEl.innerHTML = [
                kpi('Total Drafts', stats.drafts || 0),
                kpi('Sent', stats.sent_actual || 0),
                kpi('Replies', stats.replies || 0),
                kpi('Reply Rate', replyRate + '%'),
                kpi('Meetings', stats.meetings || 0),
            ].join('');
        }

        // Status funnel
        const funnelEl = document.getElementById('li-status-funnel');
        if (funnelEl && stats.by_approval_status) {
            const stages = [
                { label: 'Draft', count: stats.by_approval_status.draft || 0, color: '#6b7280' },
                { label: 'Enhanced', count: stats.by_approval_status.enhanced || 0, color: '#f59e0b' },
                { label: 'Approved', count: stats.by_approval_status.approved || 0, color: '#10b981' },
                { label: 'Queued', count: stats.by_approval_status.queued || 0, color: '#3b82f6' },
                { label: 'Sent', count: stats.sent_actual || 0, color: '#8b5cf6' },
            ];
            const maxCount = Math.max(...stages.map(s => s.count), 1);
            funnelEl.innerHTML = stages.map(s => `
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <span style="width:70px;font-size:12px;text-align:right;">${s.label}</span>
                    <div style="flex:1;height:24px;background:var(--bg-primary);border-radius:4px;overflow:hidden;">
                        <div style="width:${(s.count / maxCount) * 100}%;height:100%;background:${s.color};border-radius:4px;display:flex;align-items:center;padding-left:8px;">
                            <span style="font-size:11px;color:#fff;font-weight:600;">${s.count}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Touch type breakdown
        const touchEl = document.getElementById('li-touch-breakdown');
        if (touchEl) {
            const allDrafts = await api('/api/drafts?channel=linkedin&limit=500');
            const drafts = allDrafts?.drafts || [];
            const touchCounts = {};
            drafts.forEach(d => {
                const t = d.touch_type || 'unknown';
                touchCounts[t] = (touchCounts[t] || 0) + 1;
            });
            const touchLabels = { inmail: 'InMail (Touch 1)', call: 'Call Script', inmail_followup: 'Follow-up (Touch 3)', breakup: 'Break-up (Touch 6)' };
            touchEl.innerHTML = Object.entries(touchCounts).map(([type, count]) => `
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;">
                    <span>${touchLabels[type] || type}</span>
                    <strong>${count}</strong>
                </div>
            `).join('');
        }

        // Proof points used
        const proofEl = document.getElementById('li-proof-points');
        if (proofEl) {
            const allDrafts = await api('/api/drafts?channel=linkedin&limit=500');
            const drafts = allDrafts?.drafts || [];
            const proofCounts = {};
            drafts.forEach(d => {
                const p = d.proof_point_used || 'none';
                proofCounts[p] = (proofCounts[p] || 0) + 1;
            });
            proofEl.innerHTML = Object.entries(proofCounts).sort((a,b) => b[1] - a[1]).map(([point, count]) => `
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;">
                    <span>${point}</span>
                    <strong>${count}</strong>
                </div>
            `).join('');
        }

        // Quality metrics
        const qualityEl = document.getElementById('li-quality-metrics');
        if (qualityEl) {
            const allDrafts = await api('/api/drafts?channel=linkedin&limit=500');
            const drafts = allDrafts?.drafts || [];
            const qcPassed = drafts.filter(d => d.qc_passed).length;
            const avgWords = drafts.length ? Math.round(drafts.reduce((s,d) => s + (d.word_count || 0), 0) / drafts.length) : 0;
            const avgPScore = drafts.length ? (drafts.reduce((s,d) => s + (d.personalization_score || 0), 0) / drafts.length).toFixed(1) : '0';
            qualityEl.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div style="text-align:center;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                        <div style="font-size:20px;font-weight:700;">${qcPassed}/${drafts.length}</div>
                        <div style="font-size:11px;color:var(--text-muted);">QC Passed</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                        <div style="font-size:20px;font-weight:700;">${avgWords}</div>
                        <div style="font-size:11px;color:var(--text-muted);">Avg Words</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                        <div style="font-size:20px;font-weight:700;">${avgPScore}</div>
                        <div style="font-size:11px;color:var(--text-muted);">Avg P-Score</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                        <div style="font-size:20px;font-weight:700;">${((qcPassed / Math.max(drafts.length,1)) * 100).toFixed(0)}%</div>
                        <div style="font-size:11px;color:var(--text-muted);">QC Pass Rate</div>
                    </div>
                </div>
            `;
        }

        // Activity log
        const logEl = document.getElementById('li-activity-log');
        if (logEl) {
            try {
                const activities = await api('/api/audit/recent?limit=20');
                const actList = Array.isArray(activities) ? activities : (activities?.activities || []);
                if (actList.length) {
                    logEl.innerHTML = actList.map(a => `
                        <div style="padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;display:flex;justify-content:space-between;">
                            <span>${a.description || a.activity_type || 'Activity'}</span>
                            <span style="color:var(--text-muted);">${timeAgo(a.created_at)}</span>
                        </div>
                    `).join('');
                } else {
                    logEl.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:12px;">No recent activity.</div>';
                }
            } catch(e) {
                logEl.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:12px;">Activity log unavailable.</div>';
            }
        }
    } catch(e) { console.error('loadLIAnalytics:', e); }
}

// =========================================================================
// DRAFT REVIEW MODE
// =========================================================================
let reviewOffset = 0;
let reviewTotal = 0;
let reviewCurrent = null;
let reviewKeyListenerActive = false;

async function loadReviewMode() {
    await loadReviewStats();
    if (!reviewCurrent) startReview();
}

async function loadReviewStats() {
    try {
        const stats = await apiPost('/api/drafts/review-stats', {});
        if (stats._error) return;
        const el = document.getElementById('review-stats-kpis');
        if (el) el.innerHTML = `
            <div class="kpi-card"><div class="kpi-label">TO REVIEW</div><div class="kpi-value">${stats.total_to_review || 0}</div></div>
            <div class="kpi-card"><div class="kpi-label">APPROVED</div><div class="kpi-value" style="color:var(--success);">${stats.approved || 0}</div></div>
            <div class="kpi-card"><div class="kpi-label">REJECTED</div><div class="kpi-value" style="color:var(--danger,#ef4444);">${stats.rejected || 0}</div></div>
            <div class="kpi-card"><div class="kpi-label">QUEUED</div><div class="kpi-value" style="color:var(--info,#4da6ff);">${stats.queued || 0}</div></div>
        `;
    } catch(e) { console.error('loadReviewStats:', e); }
}

async function startReview() {
    reviewOffset = 0;
    await loadReviewDraft();
    enableReviewKeyboard();
}

async function loadReviewDraft() {
    const touchFilter = document.getElementById('review-filter-touch')?.value || '';
    const url = `/api/drafts/review-queue?offset=${reviewOffset}${touchFilter ? '&touch_type=' + touchFilter : ''}`;
    try {
        const r = await fetch(API + url);
        const data = await r.json();
        if (!r.ok || !data.draft) {
            document.getElementById('review-card-container').innerHTML = `
                <div class="card" style="text-align:center;padding:40px;">
                    <div style="font-size:48px;margin-bottom:12px;">‚úÖ</div>
                    <h3>All done!</h3>
                    <p style="color:var(--text-muted);margin-top:8px;">No more drafts to review. Switch to the Queue tab to manage approved messages.</p>
                </div>`;
            document.getElementById('review-progress').textContent = '';
            reviewCurrent = null;
            return;
        }
        reviewCurrent = data.draft;
        reviewTotal = data.total;
        document.getElementById('review-progress').textContent = `${data.position + 1} of ${data.total}`;
        renderReviewCard(data.draft);
    } catch(e) {
        console.error('loadReviewDraft:', e);
        document.getElementById('review-card-container').innerHTML = `<div class="card" style="color:var(--danger,#ef4444);padding:20px;">Error loading draft: ${e.message}</div>`;
    }
}

function renderReviewCard(d) {
    const touchLabels = {1:'InMail (Touch 1)', 2:'Call Script (Touch 2)', 3:'Follow-up (Touch 3)', 4:'Call Script (Touch 4)', 5:'Email (Touch 5)', 6:'Break-up (Touch 6)'};
    const touchLabel = touchLabels[d.touch_number] || `Touch ${d.touch_number}`;
    const container = document.getElementById('review-card-container');
    container.innerHTML = `
        <div class="card" style="border-left:3px solid var(--accent);">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
                <div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                        <span style="font-size:10px;background:var(--accent);color:#fff;padding:2px 8px;border-radius:10px;">Priority ${d.priority_score || '?'}</span>
                        <span style="font-size:10px;background:var(--bg-primary);padding:2px 8px;border-radius:10px;border:1px solid var(--border);">${d.persona_type || 'unknown'}</span>
                    </div>
                    <h3 style="margin:4px 0;">${esc(d.contact_name || '')}</h3>
                    <div style="color:var(--text-muted);font-size:13px;">${esc(d.contact_title || '')} at ${esc(d.company_name || '')}</div>
                    <div style="color:var(--text-muted);font-size:11px;margin-top:4px;">${touchLabel} | ${esc(d.vertical || '')} | P-Score: ${d.personalization_score || '-'}</div>
                </div>
                <div style="display:flex;gap:4px;">
                    ${d.linkedin_url ? `<a href="${d.linkedin_url.startsWith('http') ? d.linkedin_url : 'https://' + d.linkedin_url}" target="_blank" class="btn btn-sm">View LinkedIn ‚Üó</a>` : ''}
                </div>
            </div>

            ${d.subject_line ? `<div style="margin-bottom:12px;padding:8px 12px;background:var(--bg-primary);border-radius:var(--radius-sm);border-left:3px solid var(--accent);">
                <div style="font-size:10px;color:var(--text-muted);text-transform:uppercase;margin-bottom:2px;">Subject</div>
                <div style="font-size:13px;">${esc(d.subject_line)}</div>
            </div>` : ''}

            <div id="review-body-display" style="padding:16px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:13px;white-space:pre-wrap;line-height:1.7;max-height:400px;overflow-y:auto;margin-bottom:16px;">${esc(d.body || '(empty)')}</div>

            <textarea id="review-body-edit" style="display:none;width:100%;min-height:200px;padding:12px;background:var(--bg-primary);border:1px solid var(--accent);border-radius:var(--radius-sm);color:var(--text);font-size:13px;line-height:1.7;resize:vertical;margin-bottom:16px;">${d.body || ''}</textarea>

            <div style="display:flex;gap:8px;margin-bottom:12px;">
                <div style="font-size:11px;color:var(--text-muted);">
                    Words: ${d.word_count || '-'} | Chars: ${(d.body || '').length} | Proof: ${d.proof_point_used || '-'} | QC: ${d.qc_passed ? '‚úÖ' : '‚ö†Ô∏è'}
                </div>
            </div>

            <div style="display:flex;gap:8px;justify-content:space-between;">
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm" onclick="reviewPrev()" ${reviewOffset === 0 ? 'disabled' : ''}>‚Üê Prev</button>
                    <button class="btn btn-sm" onclick="reviewSkip()">Skip ‚Üí</button>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.body || '')}\`);showToast('Copied!')">üìã Copy</button>
                    <button class="btn btn-sm" id="review-edit-btn" onclick="toggleReviewEdit()">‚úèÔ∏è Edit</button>
                    <button class="btn btn-sm" style="background:#ef444420;color:#ef4444;border:1px solid #ef444440;" onclick="reviewReject()">‚úï Reject</button>
                    <button class="btn btn-sm btn-primary" onclick="reviewApprove()">‚úì Approve</button>
                </div>
            </div>
        </div>`;
}

async function reviewApprove() {
    if (!reviewCurrent) return;
    // If editing, save first
    const editArea = document.getElementById('review-body-edit');
    if (editArea && editArea.style.display !== 'none') {
        await apiPost(`/api/drafts/${reviewCurrent.id}`, {body: editArea.value}, 'PATCH');
    }
    const res = await apiPost(`/api/drafts/${reviewCurrent.id}/approve`, {});
    if (res._error) { showToast(res.message, 'error'); return; }
    showToast('Draft approved!');
    await loadReviewStats();
    await loadReviewDraft();
}

async function reviewReject() {
    if (!reviewCurrent) return;
    const reason = prompt('Rejection reason (optional):');
    const res = await apiPost(`/api/drafts/${reviewCurrent.id}/reject`, {reason: reason || ''});
    if (res._error) { showToast(res.message, 'error'); return; }
    showToast('Draft rejected');
    await loadReviewStats();
    await loadReviewDraft();
}

function reviewSkip() {
    reviewOffset++;
    loadReviewDraft();
}

function reviewPrev() {
    if (reviewOffset > 0) { reviewOffset--; loadReviewDraft(); }
}

function toggleReviewEdit() {
    const display = document.getElementById('review-body-display');
    const edit = document.getElementById('review-body-edit');
    const btn = document.getElementById('review-edit-btn');
    if (!display || !edit) return;
    if (edit.style.display === 'none') {
        edit.style.display = '';
        display.style.display = 'none';
        btn.textContent = 'üíæ Save';
    } else {
        // Save the edit
        if (reviewCurrent) {
            apiPost(`/api/drafts/${reviewCurrent.id}`, {body: edit.value}, 'PATCH');
            display.textContent = edit.value;
            reviewCurrent.body = edit.value;
        }
        edit.style.display = 'none';
        display.style.display = '';
        btn.textContent = '‚úèÔ∏è Edit';
        showToast('Draft updated');
    }
}

function enableReviewKeyboard() {
    if (reviewKeyListenerActive) return;
    reviewKeyListenerActive = true;
    document.addEventListener('keydown', handleReviewKey);
}

function handleReviewKey(e) {
    // Don't trigger if typing in input/textarea
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
    // Only when review tab is visible
    const reviewTab = document.getElementById('li-tab-review');
    if (!reviewTab || reviewTab.style.display === 'none') return;

    switch(e.key.toLowerCase()) {
        case 'a': reviewApprove(); break;
        case 'r': reviewReject(); break;
        case 's': reviewSkip(); break;
        case 'e': toggleReviewEdit(); break;
        case 'q': if (reviewCurrent) queueDraft(reviewCurrent.id).then(() => { loadReviewStats(); loadReviewDraft(); }); break;
        case 'c': if (reviewCurrent) { copyToClip(reviewCurrent.body || ''); showToast('Copied!'); } break;
    }
}

// =========================================================================
// REPLY TRACKING
// =========================================================================
async function loadRepliesTab() {
    loadRepliesAnalytics();
    loadRepliesList();
}

async function loadRepliesAnalytics() {
    try {
        const r = await fetch(API + '/api/replies/analytics');
        const data = await r.json();
        if (!r.ok) return;

        // KPIs
        const total = Object.values(data.by_intent || {}).reduce((s,v) => s + v, 0);
        const positive = data.by_intent?.positive || 0;
        const meetings = data.by_intent?.meeting_booked || 0;
        const kpis = document.getElementById('replies-kpis');
        if (kpis) kpis.innerHTML = `
            <div class="kpi-card"><div class="kpi-label">TOTAL REPLIES</div><div class="kpi-value">${total}</div></div>
            <div class="kpi-card"><div class="kpi-label">POSITIVE</div><div class="kpi-value" style="color:var(--success);">${positive}</div></div>
            <div class="kpi-card"><div class="kpi-label">MEETINGS</div><div class="kpi-value" style="color:var(--accent);">${meetings}</div></div>
            <div class="kpi-card"><div class="kpi-label">REPLY RATE</div><div class="kpi-value">${total > 0 ? ((positive / Math.max(total, 1)) * 100).toFixed(1) : '0.0'}%</div></div>
        `;

        // Reply tag breakdown
        renderBreakdownBars('reply-tag-breakdown', data.by_reply_tag || {}, {
            opener: '#4da6ff', pain_hook: '#f59e0b', proof_point: '#10b981',
            timing: '#8b5cf6', referral: '#ec4899', not_interested: '#ef4444', unknown: '#6b7280'
        });

        // Intent breakdown
        renderBreakdownBars('reply-intent-breakdown', data.by_intent || {}, {
            positive: '#10b981', negative: '#ef4444', neutral: '#f59e0b'
        });

        // Persona breakdown
        renderBreakdownBars('reply-persona-breakdown', data.by_persona_type || {}, {});

        // Vertical breakdown
        renderBreakdownBars('reply-vertical-breakdown', data.by_vertical || {}, {});

    } catch(e) { console.error('loadRepliesAnalytics:', e); }
}

function renderBreakdownBars(containerId, data, colorMap) {
    const el = document.getElementById(containerId);
    if (!el) return;
    const entries = Object.entries(data).sort((a,b) => b[1] - a[1]);
    const max = entries.length > 0 ? entries[0][1] : 1;
    if (entries.length === 0) {
        el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">No data yet</div>';
        return;
    }
    el.innerHTML = entries.map(([key, val]) => {
        const pct = (val / max * 100).toFixed(0);
        const color = colorMap[key] || 'var(--accent)';
        return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px;">
            <div style="width:100px;text-transform:capitalize;color:var(--text-muted);flex-shrink:0;">${esc(key.replace(/_/g, ' '))}</div>
            <div style="flex:1;background:var(--bg-primary);border-radius:4px;height:20px;overflow:hidden;">
                <div style="height:100%;width:${pct}%;background:${color}30;border-left:3px solid ${color};display:flex;align-items:center;padding-left:6px;font-size:10px;color:${color};">${val}</div>
            </div>
        </div>`;
    }).join('');
}

async function loadRepliesList() {
    try {
        const r = await fetch(API + '/api/replies');
        const data = await r.json();
        const list = document.getElementById('replies-list');
        if (!list) return;
        const replies = data.replies || data || [];
        if (!Array.isArray(replies) || replies.length === 0) {
            list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-muted);font-size:13px;">No replies logged yet. When prospects reply, click "Log Reply" to track what triggered the response.</div>';
            return;
        }
        list.innerHTML = replies.map(r => `
            <div style="padding:12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:flex-start;">
                <div>
                    <div style="font-weight:600;font-size:13px;">${esc(r.contact_name || r.first_name + ' ' + r.last_name || 'Unknown')}</div>
                    <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">${esc(r.company_name || '')} | ${esc(r.channel || 'linkedin')}</div>
                    <div style="font-size:12px;margin-top:6px;">${esc(r.summary || '')}</div>
                    ${r.referral_name ? `<div style="font-size:11px;color:var(--accent);margin-top:4px;">Referred to: ${esc(r.referral_name)} ${r.referral_title ? '(' + esc(r.referral_title) + ')' : ''}</div>` : ''}
                </div>
                <div style="display:flex;gap:6px;flex-shrink:0;">
                    <span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${r.intent === 'positive' ? '#10b98120' : r.intent === 'negative' ? '#ef444420' : '#f59e0b20'};color:${r.intent === 'positive' ? '#10b981' : r.intent === 'negative' ? '#ef4444' : '#f59e0b'};border:1px solid ${r.intent === 'positive' ? '#10b98140' : r.intent === 'negative' ? '#ef444440' : '#f59e0b40'};">${r.intent || '?'}</span>
                    <span style="font-size:10px;padding:2px 8px;border-radius:10px;background:var(--bg-primary);border:1px solid var(--border);">${(r.reply_tag || '').replace(/_/g, ' ')}</span>
                </div>
            </div>
        `).join('');
    } catch(e) { console.error('loadRepliesList:', e); }
}

function showLogReplyModal() {
    openGenericModal(`
        <h3 style="margin-bottom:16px;">Log a Reply</h3>
        <div style="display:grid;gap:12px;">
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Contact</label>
                <select class="inp" id="reply-contact-select" onchange="loadContactDrafts(this.value)">
                    <option value="">Select prospect...</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Which message triggered this reply?</label>
                <select class="inp" id="reply-draft-select">
                    <option value="">Select draft...</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">What triggered the reply?</label>
                <select class="inp" id="reply-tag-select">
                    <option value="opener">Opener - They reacted to the personalized hook</option>
                    <option value="pain_hook">Pain Hook - They engaged with the problem</option>
                    <option value="proof_point">Proof Point - They asked about the customer story</option>
                    <option value="timing">Timing - They said "good timing" or "evaluating"</option>
                    <option value="referral">Referral - They forwarded or said "talk to..."</option>
                    <option value="not_interested">Not Interested - Declined</option>
                    <option value="unknown">Unknown - Can't tell what triggered it</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Sentiment</label>
                <select class="inp" id="reply-intent-select">
                    <option value="positive">Positive</option>
                    <option value="neutral">Neutral</option>
                    <option value="negative">Negative</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Reply summary / notes</label>
                <textarea class="inp" id="reply-summary" rows="3" placeholder="What did they say?"></textarea>
            </div>
            <div id="reply-referral-fields" style="display:none;">
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Referral to:</label>
                <div style="display:flex;gap:8px;">
                    <input class="inp" id="reply-referral-name" placeholder="Name" style="flex:1;">
                    <input class="inp" id="reply-referral-title" placeholder="Title" style="flex:1;">
                </div>
            </div>
            <button class="btn btn-primary" onclick="submitReply()" style="margin-top:8px;">Log Reply</button>
        </div>
    `);
    // Load contacts into select
    fetch(API + '/api/contacts?limit=200').then(r => r.json()).then(data => {
        const sel = document.getElementById('reply-contact-select');
        const contacts = data.contacts || data || [];
        if (Array.isArray(contacts)) {
            contacts.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.first_name} ${c.last_name} - ${c.title || ''} (${c.company_name || c.account_name || ''})`;
                sel.appendChild(opt);
            });
        }
    });
    // Show referral fields when referral selected
    document.getElementById('reply-tag-select').addEventListener('change', function() {
        document.getElementById('reply-referral-fields').style.display = this.value === 'referral' ? '' : 'none';
    });
}

async function loadContactDrafts(contactId) {
    if (!contactId) return;
    const sel = document.getElementById('reply-draft-select');
    sel.innerHTML = '<option value="">Loading...</option>';
    try {
        const r = await fetch(API + `/api/drafts?contact_id=${contactId}&channel=linkedin`);
        const data = await r.json();
        const drafts = data.drafts || [];
        sel.innerHTML = '<option value="">Select draft...</option>';
        drafts.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id;
            opt.textContent = `Touch ${d.touch_number} - ${d.touch_type} - ${(d.subject_line || '').substring(0, 50)}`;
            sel.appendChild(opt);
        });
    } catch(e) { sel.innerHTML = '<option value="">Error loading drafts</option>'; }
}

async function submitReply() {
    const contactId = document.getElementById('reply-contact-select')?.value;
    const draftId = document.getElementById('reply-draft-select')?.value;
    const replyTag = document.getElementById('reply-tag-select')?.value;
    const intent = document.getElementById('reply-intent-select')?.value;
    const summary = document.getElementById('reply-summary')?.value;
    const referralName = document.getElementById('reply-referral-name')?.value;
    const referralTitle = document.getElementById('reply-referral-title')?.value;

    if (!contactId) { showToast('Select a contact', 'error'); return; }
    if (!summary) { showToast('Add a summary', 'error'); return; }

    const res = await apiPost('/api/replies', {
        contact_id: contactId,
        draft_id: draftId || null,
        channel: 'linkedin',
        reply_tag: replyTag,
        intent: intent,
        summary: summary,
        referral_name: referralName || null,
        referral_title: referralTitle || null
    });

    if (res._error) { showToast(res.message, 'error'); return; }
    showToast('Reply logged!');
    closeModal();
    loadRepliesTab();
}

// =========================================================================
// DRAFT VERSIONS (Enhancement with Revision History)
// =========================================================================
async function showDraftVersions(draftId) {
    try {
        const r = await fetch(API + `/api/drafts/${draftId}/versions`);
        const data = await r.json();
        if (!r.ok) { showToast('Error loading versions', 'error'); return; }
        const versions = data.versions || [];
        const current = data.current || {};

        let html = `<h3 style="margin-bottom:16px;">Draft Versions</h3>`;
        html += `<div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <strong>Current (v${current.version || 1})</strong>
                <span style="font-size:10px;padding:2px 8px;border-radius:10px;background:var(--accent)20;color:var(--accent);">Active</span>
            </div>
            <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;line-height:1.6;max-height:200px;overflow-y:auto;">${esc(current.body || '')}</div>
        </div>`;

        versions.forEach(v => {
            html += `<div style="margin-bottom:12px;opacity:0.7;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <strong>v${v.version_number || v.version}</strong>
                    <span style="font-size:10px;color:var(--text-muted);">${v.created_at || ''}</span>
                </div>
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;line-height:1.6;max-height:150px;overflow-y:auto;">${esc(v.body || '')}</div>
                <button class="btn btn-sm" style="margin-top:6px;" onclick="revertToVersion('${draftId}', \`${escJs(v.body || '')}\`)">Revert to this version</button>
            </div>`;
        });

        openGenericModal(html);
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

async function revertToVersion(draftId, body) {
    await apiPost(`/api/drafts/${draftId}`, {body: body}, 'PATCH');
    showToast('Reverted!');
    closeModal();
    loadLIDrafts();
}

async function enhanceDraftWithRevision(draftId) {
    const res = await apiPost(`/api/drafts/${draftId}/enhance-with-revision`, {});
    if (res._error) { showToast(res.message, 'error'); return; }
    showToast('Draft enhanced! Original preserved as revision.');
    loadLIDrafts();
}

// =========================================================================
// MEETING BOOKED PREP CARDS
// =========================================================================
function showBookMeetingModal(contactId, contactName) {
    openGenericModal(`
        <h3 style="margin-bottom:16px;">Book Meeting: ${esc(contactName)}</h3>
        <div style="display:grid;gap:12px;">
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Meeting Date & Time</label>
                <input type="datetime-local" class="inp" id="meeting-date-input">
            </div>
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Notes</label>
                <textarea class="inp" id="meeting-notes" rows="3" placeholder="How it was booked, what they said..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="bookMeeting('${contactId}')">Book Meeting</button>
        </div>
    `);
}

async function bookMeeting(contactId) {
    const meetingDate = document.getElementById('meeting-date-input')?.value;
    const notes = document.getElementById('meeting-notes')?.value;
    if (!meetingDate) { showToast('Set a meeting date', 'error'); return; }
    const res = await apiPost(`/api/contacts/${contactId}/book-meeting`, {meeting_date: meetingDate, notes: notes || ''});
    if (res._error) { showToast(res.message, 'error'); return; }
    showToast('Meeting booked!');
    closeModal();
    showPrepCard(contactId);
}

async function showPrepCard(contactId) {
    try {
        const r = await fetch(API + `/api/contacts/${contactId}/prep-card`);
        const data = await r.json();
        if (!r.ok) { showToast('Error loading prep card', 'error'); return; }
        const p = data;

        let html = `<div style="max-height:70vh;overflow-y:auto;">
            <h3 style="margin-bottom:16px;">Meeting Prep Card</h3>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Company Snapshot</div>
                    <div style="font-size:12px;line-height:1.6;">${esc(p.company_snapshot || 'No data')}</div>
                </div>
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Prospect Snapshot</div>
                    <div style="font-size:12px;line-height:1.6;">${esc(p.prospect_snapshot || 'No data')}</div>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Tech Stack</div>
                    <div style="font-size:12px;">${(p.tech_stack || []).map(t => `<span style="display:inline-block;padding:2px 8px;margin:2px;background:var(--accent)15;border-radius:10px;font-size:11px;border:1px solid var(--accent)30;">${esc(t)}</span>`).join('') || 'Unknown'}</div>
                </div>
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);border-left:3px solid var(--warning,#f59e0b);">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Pain Hypothesis</div>
                    <div style="font-size:12px;line-height:1.6;">${esc(p.pain_hypothesis || 'No data')}</div>
                </div>
            </div>

            ${p.what_triggered_reply ? `<div style="padding:12px;background:#10b98110;border-radius:var(--radius-sm);border-left:3px solid #10b981;margin-bottom:16px;">
                <div style="font-size:10px;text-transform:uppercase;color:#10b981;margin-bottom:6px;">What Triggered the Reply</div>
                <div style="font-size:12px;">${esc(p.what_triggered_reply)}</div>
            </div>` : ''}

            <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);margin-bottom:16px;">
                <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;">Discovery Questions</div>
                ${(p.discovery_questions || []).map((q, i) => `<div style="font-size:12px;margin-bottom:6px;padding-left:16px;text-indent:-16px;">${i + 1}. ${esc(q)}</div>`).join('')}
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Relevant Proof Points</div>
                    ${(p.relevant_proof_points || []).map(pp => `<div style="font-size:11px;margin-bottom:4px;padding:4px 0;border-bottom:1px solid var(--border);">${esc(pp)}</div>`).join('') || 'None matched'}
                </div>
                <div style="padding:12px;background:var(--bg-primary);border-radius:var(--radius-sm);border-left:3px solid #ef4444;">
                    <div style="font-size:10px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px;">Predicted Objection</div>
                    <div style="font-size:12px;font-weight:600;margin-bottom:4px;">${esc(p.predicted_objections?.objection || 'None predicted')}</div>
                    <div style="font-size:11px;color:var(--text-muted);">${esc(p.predicted_objections?.response || '')}</div>
                </div>
            </div>

            <button class="btn btn-primary" style="width:100%;" onclick="copyPrepCard()">üìã Copy Prep Card</button>
        </div>`;

        // Store for copy
        window._lastPrepCard = p;
        openGenericModal(html);
    } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

function copyPrepCard() {
    const p = window._lastPrepCard;
    if (!p) return;
    const text = `MEETING PREP CARD
==================
Company: ${p.company_snapshot || ''}
Prospect: ${p.prospect_snapshot || ''}
Tech Stack: ${(p.tech_stack || []).join(', ')}
Pain Hypothesis: ${p.pain_hypothesis || ''}
What Triggered Reply: ${p.what_triggered_reply || ''}

DISCOVERY QUESTIONS:
${(p.discovery_questions || []).map((q, i) => `${i + 1}. ${q}`).join('\n')}

PROOF POINTS:
${(p.relevant_proof_points || []).join('\n')}

PREDICTED OBJECTION: ${p.predicted_objections?.objection || ''}
RESPONSE: ${p.predicted_objections?.response || ''}`;
    copyToClip(text);
    showToast('Prep card copied!');
}

// =========================================================================
// OUTREACH MEMORY / LEARNING
// =========================================================================
async function loadMemoryTab() {
    loadMemoryInsights();
    loadMemoryPatterns();
}

async function loadMemoryInsights() {
    try {
        const r = await fetch(API + '/api/memory/insights');
        const data = await r.json();
        const el = document.getElementById('memory-insights');
        if (!el) return;
        if (!r.ok || !data.insights) {
            el.innerHTML = '<div style="color:var(--text-muted);">No insights yet. Send messages and log replies to build your outreach memory. Click "Refresh from Data" after logging replies.</div>';
            return;
        }
        const ins = data.insights;
        el.innerHTML = `
            <div style="margin-bottom:6px;"><strong style="color:var(--accent);">1. Best persona:</strong> ${esc(ins.best_persona || 'Not enough data')}</div>
            <div style="margin-bottom:6px;"><strong style="color:var(--accent);">2. Best proof point:</strong> ${esc(ins.best_proof_point || 'Not enough data')}</div>
            <div style="margin-bottom:6px;"><strong style="color:var(--accent);">3. Best vertical:</strong> ${esc(ins.best_vertical || 'Not enough data')}</div>
            <div style="margin-bottom:6px;"><strong style="color:var(--accent);">4. Best pattern:</strong> ${esc(ins.best_pattern || 'Not enough data')}</div>
            <div><strong style="color:#ef4444;">5. Stop doing:</strong> ${esc(ins.stop_doing || 'Not enough data')}</div>
        `;
    } catch(e) { console.error('loadMemoryInsights:', e); }
}

async function loadMemoryPatterns() {
    const categories = ['proof_point', 'opener_style', 'pain_hook', 'persona_pattern'];
    const containerIds = ['memory-proof-points', 'memory-openers', 'memory-pain-hooks', 'memory-personas'];

    for (let i = 0; i < categories.length; i++) {
        try {
            const r = await fetch(API + `/api/memory?category=${categories[i]}`);
            const data = await r.json();
            const el = document.getElementById(containerIds[i]);
            if (!el) continue;
            const patterns = data.patterns || data || [];
            if (!Array.isArray(patterns) || patterns.length === 0) {
                el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">No patterns learned yet</div>';
                continue;
            }
            el.innerHTML = patterns.map(p => `
                <div style="padding:8px;border-bottom:1px solid var(--border);font-size:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${esc(p.pattern)}</span>
                        <span style="font-size:10px;padding:2px 8px;border-radius:10px;background:${p.reply_rate > 0.02 ? '#10b98120' : p.reply_rate > 0 ? '#f59e0b20' : 'var(--bg-primary)'};color:${p.reply_rate > 0.02 ? '#10b981' : p.reply_rate > 0 ? '#f59e0b' : 'var(--text-muted)'};">${(p.reply_rate * 100).toFixed(1)}%</span>
                    </div>
                    <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">Used: ${p.times_used || 0} | Replied: ${p.times_replied || 0}</div>
                </div>
            `).join('');
        } catch(e) { console.error('loadMemoryPatterns:', e); }
    }
}

async function refreshMemory() {
    showToast('Refreshing patterns from data...');
    const res = await apiPost('/api/memory/refresh', {});
    if (res._error) { showToast(res.message, 'error'); return; }
    showToast(`Memory refreshed! ${res.patterns_updated || 0} patterns updated.`);
    loadMemoryTab();
}

function showAddMemoryModal() {
    openGenericModal(`
        <h3 style="margin-bottom:16px;">Add Observation</h3>
        <div style="display:grid;gap:12px;">
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">Category</label>
                <select class="inp" id="memory-add-category">
                    <option value="proof_point">Proof Point</option>
                    <option value="opener_style">Opener Style</option>
                    <option value="pain_hook">Pain Hook</option>
                    <option value="persona_pattern">Persona Pattern</option>
                    <option value="vertical_pattern">Vertical Pattern</option>
                </select>
            </div>
            <div>
                <label style="font-size:11px;color:var(--text-muted);display:block;margin-bottom:4px;">What did you observe?</label>
                <textarea class="inp" id="memory-add-pattern" rows="3" placeholder="e.g., Career-reference openers work better than company-metric openers for Directors of QA"></textarea>
            </div>
            <button class="btn btn-primary" onclick="addMemoryPattern()">Save Observation</button>
        </div>
    `);
}

async function addMemoryPattern() {
    const category = document.getElementById('memory-add-category')?.value;
    const pattern = document.getElementById('memory-add-pattern')?.value;
    if (!pattern) { showToast('Add a pattern description', 'error'); return; }
    const res = await apiPost('/api/memory', {category, pattern});
    if (res._error) { showToast(res.message, 'error'); return; }
    showToast('Pattern saved!');
    closeModal();
    loadMemoryPatterns();
}

// ‚îÄ‚îÄ‚îÄ STAGING TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStagingTab() {
    const touchFilter = document.getElementById('staging-filter-touch')?.value || '';

    // Load KPIs
    const stats = await api('/api/linkedin/stats');
    const kpiEl = document.getElementById('staging-kpis');
    if (kpiEl && stats) {
        const staged = stats.by_approval_status?.staged || 0;
        const sent = stats.sent_actual || 0;
        kpiEl.innerHTML = [
            kpi('Staged', staged),
            kpi('Sent Today', sent),
            kpi('Remaining Quota', '-'),
        ].join('');
    }

    // Load staged drafts
    try {
        let url = '/api/drafts?channel=linkedin&approval_status=staged&limit=50';
        if (touchFilter) url += `&touch_type=${touchFilter}`;

        const data = await api(url);
        const drafts = data?.drafts || [];
        const listEl = document.getElementById('staging-list');
        if (!listEl) return;

        if (!drafts.length) {
            listEl.innerHTML = '<div class="empty">No staged messages yet. Approve drafts, then move them to staging.</div>';
            return;
        }

        listEl.innerHTML = drafts.map(d => {
            const name = `${d.first_name || ''} ${d.last_name || ''}`.trim();
            const company = d.company_name || d.account_name || '';
            const linkedinUrl = d.linkedin_url || '#';
            return `
            <div class="card" style="margin-bottom:12px;padding:16px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
                    <div>
                        <strong style="font-size:14px;">${name}</strong>
                        <span style="color:var(--text-muted);margin-left:8px;">${d.title || ''} at ${company}</span>
                    </div>
                    <div style="display:flex;gap:6px;">
                        <a href="${linkedinUrl}" target="_blank" class="btn btn-sm" style="text-decoration:none;" ${linkedinUrl === '#' ? 'disabled' : ''}>üîó Open Profile</a>
                    </div>
                </div>

                <!-- Preflight Checklist -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;font-size:11px;">
                    <div style="padding:6px 8px;background:${linkedinUrl !== '#' ? 'var(--success-bg)' : 'var(--error-bg)'};border-radius:4px;">
                        ${linkedinUrl !== '#' ? '‚úÖ' : '‚ùå'} LinkedIn URL
                    </div>
                    <div style="padding:6px 8px;background:var(--success-bg);border-radius:4px;">‚úÖ Approved</div>
                    <div style="padding:6px 8px;background:${d.personalization_score >= 2 ? 'var(--success-bg)' : 'var(--warning-bg)'};border-radius:4px;">
                        ${d.personalization_score >= 2 ? '‚úÖ' : '‚ö†Ô∏è'} Quality: ${d.personalization_score || '?'}/3
                    </div>
                </div>

                <!-- Subject -->
                ${d.subject_line ? `<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;"><strong>Subject:</strong> ${d.subject_line}</div>` : ''}

                <!-- Message Body -->
                <div style="background:var(--bg-primary);padding:12px;border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;line-height:1.6;margin-bottom:12px;max-height:200px;overflow-y:auto;" id="staging-body-${d.id}">${d.body || ''}</div>

                <!-- Actions -->
                <div style="display:flex;gap:8px;justify-content:flex-end;">
                    <button class="btn btn-sm" onclick="navigator.clipboard.writeText(document.getElementById('staging-body-${d.id}').innerText);showToast('Message copied!')">üìã Copy Message</button>
                    ${d.subject_line ? `<button class="btn btn-sm" onclick="navigator.clipboard.writeText('${(d.subject_line||'').replace(/'/g,"\\'")}');showToast('Subject copied!')">üìã Copy Subject</button>` : ''}
                    <button class="btn btn-sm btn-primary" onclick="markDraftSent('${d.id}')">‚úÖ Mark as Sent</button>
                </div>
            </div>`;
        }).join('');
    } catch(e) {
        console.error('Staging load error:', e);
    }
}

async function moveDraftToStaging(draftId) {
    try {
        const result = await apiPost(`/api/drafts/${draftId}/stage`, {});
        if (result?.status === 'staged') {
            showToast('Draft moved to staging');
            loadLIDrafts();
        } else if (result?.preflight) {
            const failed = result.preflight.filter(c => !c.passed);
            showToast(`Preflight failed: ${failed.map(f => f.name).join(', ')}`, 'error');
        }
    } catch(e) {
        showToast('Failed to stage draft: ' + (e.message || ''), 'error');
    }
}

async function markDraftSent(draftId) {
    if (!confirm('Mark this message as sent? This will update your quota.')) return;
    try {
        await apiPost(`/api/drafts/${draftId}/mark-sent`, {});
        showToast('Marked as sent!');
        loadStagingTab();
    } catch(e) {
        showToast('Failed to mark as sent', 'error');
    }
}

function showLinkedInImportTab(tab, btn) {
    document.querySelectorAll('#page-linkedin .email-tab').forEach(e => e.style.display = 'none');
    document.getElementById('li-import-' + tab).style.display = '';
    if (btn) {
        btn.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
}

async function importLinkedInCSV() {
    const raw = document.getElementById('li-csv-data')?.value?.trim();
    if (!raw) { showToast('Paste CSV data first', 'warning'); return; }

    const lines = raw.split('\n');
    if (lines.length < 2) { showToast('Need header row + at least one data row', 'warning'); return; }

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/\s+/g, '_'));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const vals = lines[i].split(',').map(v => v.trim());
        if (vals.length < 2) continue;
        const row = {};
        headers.forEach((h, j) => { row[h] = vals[j] || ''; });
        rows.push(row);
    }

    const result = await apiPost('/api/linkedin/profiles/import-csv', { rows });
    if (result && !result._error) {
        showToast(`Imported ${result.imported} profiles, skipped ${result.skipped}`, 'success');
        document.getElementById('li-csv-data').value = '';
        document.getElementById('li-csv-result').textContent = `${result.imported} imported, ${result.skipped} skipped`;
        loadLinkedInPage();
    } else {
        showToast('Import failed: ' + (result?.message || 'Unknown error'), 'error');
    }
}

async function importLinkedInPaste() {
    const text = document.getElementById('li-paste-data')?.value?.trim();
    const url = document.getElementById('li-paste-url')?.value?.trim();
    const company = document.getElementById('li-paste-company')?.value?.trim();

    if (!text) { showToast('Paste profile text first', 'warning'); return; }

    // Simple parsing of pasted profile text
    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
    const name = lines[0] || '';
    const headline = lines[1] || '';
    const parts = name.split(' ');

    const result = await apiPost('/api/linkedin/profiles/import', {
        linkedin_url: url,
        headline: headline,
        about_text: lines.slice(2).join('\n'),
        source: 'manual_paste',
    });

    if (result && !result._error) {
        showToast('Profile imported', 'success');
        document.getElementById('li-paste-data').value = '';
        loadLinkedInPage();
    } else {
        showToast('Import failed: ' + (result?.message || 'Unknown error'), 'error');
    }
}

// WORKFLOW EXECUTION SYSTEM
let currentWorkflowType = null;

const WORKFLOW_CONFIGS = {
    account_research: {
        title: 'Account Research',
        description: 'Research a target account: company overview, ICP fit score, pain points, recommended titles and talk tracks.',
        inputs: [
            { id: 'wf-company', label: 'Company Name', type: 'text', placeholder: 'e.g. Stripe', required: true },
            { id: 'wf-domain', label: 'Domain (optional)', type: 'text', placeholder: 'e.g. stripe.com' },
            { id: 'wf-industry', label: 'Industry (optional)', type: 'text', placeholder: 'e.g. FinTech' },
        ]
    },
    prospect_shortlist: {
        title: 'Prospect Shortlist Builder',
        description: 'Score and rank all active contacts against ICP criteria. Flags exclusions and highlights missing info.',
        inputs: [
            { id: 'wf-note', label: 'Note', type: 'info', text: 'This will analyze all active contacts in your pipeline and produce a ranked shortlist.' },
        ]
    },
    linkedin_message_draft: {
        title: 'LinkedIn Message Drafts',
        description: 'Generate 3 personalized InMail variants (warm, direct, value-first) following the SOP writing rules.',
        inputs: [
            { id: 'wf-contact-select', label: 'Select Prospect', type: 'contact_select', required: true },
        ]
    },
    followup_sequence: {
        title: 'Follow-Up Sequence Planner',
        description: 'Create Touch 3 (follow-up), Touch 5 (email), and Touch 6 (break-up) with different angles.',
        inputs: [
            { id: 'wf-contact-select', label: 'Select Prospect', type: 'contact_select', required: true },
        ]
    },
    daily_plan: {
        title: 'Daily BDR Plan Generator',
        description: 'Generate a prioritized daily checklist organized by time blocks: morning calls, midday LinkedIn, afternoon follow-ups.',
        inputs: [
            { id: 'wf-target', label: 'Target Touches Today', type: 'number', placeholder: '50', value: '50' },
            { id: 'wf-hours', label: 'Hours Available', type: 'number', placeholder: '8', value: '8' },
        ]
    },
    call_prep: {
        title: 'Cold Call Prep Script',
        description: 'Generate a 3-line call cheat sheet: opener, pain hypothesis, bridge to ask. Uses different proof point than InMail.',
        inputs: [
            { id: 'wf-contact-select', label: 'Select Prospect', type: 'contact_select', required: true },
        ]
    },
    email_draft: {
        title: 'Email Draft Generator',
        description: 'Generate a cold email with subject lines and body. Quality-checked for deliverability.',
        inputs: [
            { id: 'wf-contact-select', label: 'Select Prospect', type: 'contact_select', required: true },
        ]
    },
};

function showWorkflowModal(type) {
    currentWorkflowType = type;
    const config = WORKFLOW_CONFIGS[type];
    if (!config) { showToast('Unknown workflow type', 'error'); return; }

    document.getElementById('wf-modal-title').textContent = config.title;
    document.getElementById('wf-modal-desc').textContent = config.description;
    document.getElementById('wf-modal-result').style.display = 'none';
    document.getElementById('wf-modal-steps').style.display = 'none';
    document.getElementById('wf-run-btn').disabled = false;
    document.getElementById('wf-run-btn').textContent = 'Run Workflow';

    const inputsEl = document.getElementById('wf-modal-inputs');
    inputsEl.innerHTML = config.inputs.map(inp => {
        if (inp.type === 'info') {
            return `<div style="padding:10px;background:var(--info-bg);border:1px solid var(--info);border-radius:var(--radius-sm);font-size:12px;color:var(--info);margin-bottom:12px;">${inp.text}</div>`;
        }
        if (inp.type === 'contact_select') {
            const options = (window.contacts || []).map(c => `<option value="${c.id}">${c.first_name} ${c.last_name} - ${c.title || ''} @ ${c.company_name || ''}</option>`).join('');
            return `<div class="form-row"><label>${inp.label}</label><select class="sel" id="${inp.id}" style="width:100%;">${options}</select></div>`;
        }
        return `<div class="form-row"><label>${inp.label}</label><input class="inp" id="${inp.id}" type="${inp.type}" placeholder="${inp.placeholder || ''}" value="${inp.value || ''}" style="width:100%;" ${inp.required ? 'required' : ''} /></div>`;
    }).join('');

    document.getElementById('workflow-modal').style.display = 'flex';
}

function closeWorkflowModal() {
    document.getElementById('workflow-modal').style.display = 'none';
    currentWorkflowType = null;
}

async function executeWorkflow() {
    if (!currentWorkflowType) return;

    const btn = document.getElementById('wf-run-btn');
    btn.disabled = true;
    btn.textContent = 'Running...';

    let inputData = {};

    switch (currentWorkflowType) {
        case 'account_research':
            inputData = {
                company_name: document.getElementById('wf-company')?.value || '',
                domain: document.getElementById('wf-domain')?.value || '',
                industry: document.getElementById('wf-industry')?.value || '',
            };
            if (!inputData.company_name) { showToast('Company name required', 'warning'); btn.disabled = false; btn.textContent = 'Run Workflow'; return; }
            break;
        case 'prospect_shortlist':
            inputData = {};
            break;
        case 'linkedin_message_draft':
        case 'followup_sequence':
        case 'call_prep':
        case 'email_draft':
            inputData = { contact_id: document.getElementById('wf-contact-select')?.value || '' };
            if (!inputData.contact_id) { showToast('Select a prospect', 'warning'); btn.disabled = false; btn.textContent = 'Run Workflow'; return; }
            break;
        case 'daily_plan':
            inputData = {
                target_touches: parseInt(document.getElementById('wf-target')?.value) || 50,
                hours_available: parseInt(document.getElementById('wf-hours')?.value) || 8,
            };
            break;
    }

    const result = await apiPost('/api/workflows/execute', {
        workflow_type: currentWorkflowType,
        input: inputData,
    });

    btn.textContent = 'Done';

    if (result && !result._error) {
        showToast(`${WORKFLOW_CONFIGS[currentWorkflowType]?.title || 'Workflow'} completed!`, 'success');
        renderWorkflowResult(result);
        loadLinkedInPage(); // refresh the page data
    } else {
        showToast('Workflow failed: ' + (result?.message || 'Unknown error'), 'error');
        document.getElementById('wf-modal-result').style.display = 'block';
        document.getElementById('wf-modal-result-content').innerHTML = `<div style="padding:12px;background:var(--error-bg);border:1px solid var(--error);border-radius:var(--radius-sm);color:var(--error);">${result?.message || 'Unknown error'}</div>`;
    }
}

function renderWorkflowResult(response) {
    const resultEl = document.getElementById('wf-modal-result');
    const contentEl = document.getElementById('wf-modal-result-content');
    resultEl.style.display = 'block';

    const result = response.result || response;

    if (currentWorkflowType === 'account_research') {
        contentEl.innerHTML = `
            <div style="display:grid;gap:12px;">
                <div class="card" style="padding:14px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <strong>${result.company || ''}</strong>
                        <span class="tag ${(result.icp_score || 0) >= 5 ? 'tag-hot' : (result.icp_score || 0) >= 3 ? 'tag-warm' : 'tag-std'}">ICP: ${result.icp_score || 0}/${result.icp_max || 7}</span>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);">${result.industry || ''} | ${(result.employee_count || 0).toLocaleString()} employees</div>
                    <div style="margin-top:8px;"><strong>ICP Reasons:</strong></div>
                    <ul style="font-size:12px;margin-top:4px;padding-left:16px;">${(result.icp_reasons || []).map(r => `<li>${r}</li>`).join('')}</ul>
                </div>
                <div class="card" style="padding:14px;">
                    <strong>Pain Points</strong>
                    ${(result.pain_points || []).map(p => `
                        <div style="margin-top:8px;padding:8px;background:var(--bg-primary);border-radius:var(--radius-sm);">
                            <div style="font-size:12px;"><strong>${p.pain}</strong> <span class="tag ${p.severity === 'high' ? 'tag-hot' : 'tag-std'}">${p.severity}</span></div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">${p.talk_track}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="card" style="padding:14px;">
                    <strong>Recommended Proof Point:</strong> ${result.recommended_proof_point?.name || ''} - ${result.recommended_proof_point?.metric || ''}
                </div>
                ${result.predicted_objection ? `<div class="card" style="padding:14px;">
                    <strong>Predicted Objection:</strong> ${result.predicted_objection.trigger || ''}
                    <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;"><em>Response:</em> ${result.predicted_objection.response || ''}</div>
                </div>` : ''}
            </div>`;
    } else if (currentWorkflowType === 'linkedin_message_draft' || currentWorkflowType === 'email_draft') {
        const variants = result.variants || [];
        const drafts = variants.length ? variants : [result];
        contentEl.innerHTML = `
            <div style="margin-bottom:8px;"><strong>Prospect:</strong> ${result.contact || ''} @ ${result.company || ''}</div>
            ${drafts.map((v, i) => `
                <div class="card" style="padding:14px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong>Variant ${i+1}: ${v.variant || 'Default'}</strong>
                        <div style="display:flex;gap:6px;">
                            <span style="font-size:11px;color:var(--text-muted);">${v.word_count || '-'} words | P-Score: ${v.personalization_score || '-'}</span>
                            <button class="btn btn-sm" onclick="navigator.clipboard.writeText(this.closest('.card').querySelector('.draft-body').textContent);showToast('Copied!','success')">Copy</button>
                        </div>
                    </div>
                    ${v.subject ? `<div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;"><strong>Subject:</strong> ${v.subject}</div>` : ''}
                    <div class="draft-body" style="padding:10px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;">${v.body || ''}</div>
                </div>
            `).join('')}
            ${result.predicted_objection ? `<div style="margin-top:8px;font-size:12px;"><strong>Predicted objection:</strong> ${result.predicted_objection.trigger || ''}<br><em>Response:</em> ${result.predicted_objection.response || ''}</div>` : ''}`;
    } else if (currentWorkflowType === 'followup_sequence') {
        contentEl.innerHTML = `
            <div style="margin-bottom:8px;"><strong>Follow-ups for:</strong> ${result.contact || ''} @ ${result.company || ''}</div>
            ${(result.drafts || []).map(d => `
                <div class="card" style="padding:14px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong>Touch ${d.touch}: ${d.type}</strong>
                        <div style="display:flex;gap:6px;">
                            <span style="font-size:11px;color:var(--text-muted);">${d.word_count} words</span>
                            <button class="btn btn-sm" onclick="navigator.clipboard.writeText(this.closest('.card').querySelector('.draft-body').textContent);showToast('Copied!','success')">Copy</button>
                        </div>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;"><strong>Subject:</strong> ${d.subject || ''}</div>
                    <div class="draft-body" style="padding:10px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;white-space:pre-wrap;">${d.body || ''}</div>
                </div>
            `).join('')}`;
    } else if (currentWorkflowType === 'daily_plan') {
        const plan = result.plan || {};
        contentEl.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:14px;">
                ${kpi('Calls Planned', result.summary?.calls_planned || 0)}
                ${kpi('LinkedIn Planned', result.summary?.linkedin_planned || 0)}
                ${kpi('Follow-ups Due', result.summary?.followups_due || 0)}
                ${kpi('Hot Prospects', result.summary?.hot_prospects || 0)}
            </div>
            ${Object.entries(plan).map(([key, block]) => `
                <div class="card" style="padding:14px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <strong>${block.focus || key}</strong>
                        <span style="font-size:11px;color:var(--text-muted);">${block.time || ''}</span>
                    </div>
                    ${(block.tasks || []).map(t => `
                        <div style="padding:6px 8px;margin-top:4px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:12px;display:flex;align-items:center;gap:8px;">
                            <span style="font-size:14px;">${t.type === 'call' ? 'üìû' : t.type === 'linkedin' ? 'üîó' : t.type === 'followup' ? 'üîÑ' : '‚ö°'}</span>
                            <div><strong>${t.contact || t.action || ''}</strong> ${t.company ? `<span style="color:var(--text-muted);">@ ${t.company}</span>` : ''} ${t.reason ? `<div style="font-size:11px;color:var(--text-secondary);">${t.reason}</div>` : ''}</div>
                        </div>
                    `).join('')}
                </div>
            `).join('')}`;
    } else if (currentWorkflowType === 'prospect_shortlist') {
        const shortlist = result.shortlist || [];
        contentEl.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;">
                ${kpi('Total Input', result.summary?.total_input || 0)}
                ${kpi('Passed', result.summary?.passed_filters || 0)}
                ${kpi('Hot (5)', result.summary?.hot || 0)}
                ${kpi('Warm (4)', result.summary?.warm || 0)}
            </div>
            <div style="overflow-x:auto;">
                <table class="tbl">
                    <thead><tr><th>Score</th><th>Name</th><th>Title</th><th>Company</th><th>Persona</th><th>Missing</th></tr></thead>
                    <tbody>${shortlist.slice(0, 25).map(s => `
                        <tr>
                            <td><span class="tag ${s.priority_score >= 5 ? 'tag-hot' : s.priority_score >= 4 ? 'tag-warm' : 'tag-std'}">${s.priority_score}</span></td>
                            <td><strong>${s.name}</strong></td>
                            <td style="font-size:12px;">${s.title || ''}</td>
                            <td style="font-size:12px;">${s.company || ''}</td>
                            <td><span class="tag ${s.persona_type === 'qa_leader' ? 'tag-qa' : 'tag-vp'}">${s.persona_type || ''}</span></td>
                            <td style="font-size:11px;color:var(--warning);">${(s.missing_info || []).join(', ') || '-'}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            </div>`;
    } else if (currentWorkflowType === 'call_prep') {
        const script = result.call_script || {};
        contentEl.innerHTML = `
            <div style="margin-bottom:8px;"><strong>Call Prep for:</strong> ${result.contact || ''} @ ${result.company || ''}</div>
            <div class="card" style="padding:14px;">
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--accent);">1. Opener:</strong>
                    <div class="draft-body" style="margin-top:4px;padding:8px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:13px;">${script.opener || ''}</div>
                </div>
                <div style="margin-bottom:12px;">
                    <strong style="color:var(--warning);">2. Pain Hypothesis:</strong>
                    <div class="draft-body" style="margin-top:4px;padding:8px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:13px;">${script.pain_hypothesis || ''}</div>
                </div>
                <div>
                    <strong style="color:var(--success);">3. Bridge to Ask:</strong>
                    <div class="draft-body" style="margin-top:4px;padding:8px;background:var(--bg-primary);border-radius:var(--radius-sm);font-size:13px;">${script.bridge || ''}</div>
                </div>
                <div style="margin-top:12px;text-align:right;">
                    <button class="btn btn-sm btn-primary" onclick="navigator.clipboard.writeText([document.querySelectorAll('.draft-body')[0]?.textContent,document.querySelectorAll('.draft-body')[1]?.textContent,document.querySelectorAll('.draft-body')[2]?.textContent].join('\\n\\n'));showToast('Script copied!','success')">Copy Full Script</button>
                </div>
            </div>`;
    } else {
        contentEl.innerHTML = `<pre style="font-size:11px;white-space:pre-wrap;max-height:400px;overflow-y:auto;">${JSON.stringify(result, null, 2)}</pre>`;
    }
}

async function viewWorkflowRun(runId) {
    const data = await api('/api/workflow-runs/' + runId);
    if (!data) { showToast('Could not load run details', 'error'); return; }

    const el = document.getElementById('wf-detail-content');
    const statusClass = data.status === 'succeeded' ? 'badge-gn' : data.status === 'failed' ? 'badge-rd' : 'badge-bl';

    el.innerHTML = `
        <div style="display:flex;gap:16px;margin-bottom:16px;">
            ${kpi('Status', `<span class="${statusClass}">${data.status}</span>`)}
            ${kpi('Steps', `${data.completed_steps}/${data.total_steps}`)}
            ${kpi('Duration', data.duration_ms ? (data.duration_ms/1000).toFixed(1) + 's' : '-')}
            ${kpi('Dry Run', data.dry_run ? 'Yes' : 'No')}
        </div>
        <div class="card" style="padding:14px;margin-bottom:12px;">
            <strong>Steps</strong>
            ${(data.steps || []).map(s => {
                const sc = s.status === 'succeeded' ? '‚úÖ' : s.status === 'failed' ? '‚ùå' : s.status === 'running' ? '‚è≥' : '‚è∏Ô∏è';
                return `<div style="padding:6px 0;border-bottom:1px solid var(--border-subtle);display:flex;align-items:center;gap:8px;font-size:12px;">
                    <span>${sc}</span>
                    <strong>${s.step_name}</strong>
                    <span style="color:var(--text-muted);margin-left:auto;">${s.duration_ms ? s.duration_ms + 'ms' : ''}</span>
                </div>`;
            }).join('')}
        </div>
        ${data.output_data ? `<div class="card" style="padding:14px;">
            <strong>Output</strong>
            <pre style="margin-top:8px;font-size:11px;white-space:pre-wrap;max-height:300px;overflow-y:auto;">${JSON.stringify(JSON.parse(data.output_data || '{}'), null, 2)}</pre>
        </div>` : ''}`;

    document.getElementById('workflow-detail-modal').style.display = 'flex';
}

function copyDraftBody(draftId) {
    // Find the draft card and copy its body
    api('/api/drafts/' + draftId).then(d => {
        if (d && d.body) {
            navigator.clipboard.writeText(d.body).then(() => showToast('Draft copied!', 'success'));
        }
    });
}

// =====================================================
// PROSPECTS PAGE
// =====================================================
function showProspectsTab(tab) {
    document.querySelectorAll('#page-prospects .tab-item').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-prospects .tab-content').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('prospects-tab-' + tab).classList.add('active');
}

// =====================================================
// ENHANCED PROSPECTS PAGE (with LinkedIn + Copy buttons)
// =====================================================
let allProspects = [];

async function loadProspectsPage() {
    try {
        const data = await api('/api/prospects/full');
        allProspects = data.prospects || [];

        const el = document.getElementById('prospects-kpis');
        const qa = allProspects.filter(p => p.persona_type === 'qa_leader').length;
        const eng = allProspects.filter(p => p.persona_type === 'vp_eng').length;
        const hot = allProspects.filter(p => (p.priority_score || 0) >= 5).length;
        const withLinkedin = allProspects.filter(p => p.linkedin_url && p.linkedin_url.includes('linkedin.com')).length;
        const withDrafts = allProspects.filter(p => p.drafts && p.drafts.length > 0).length;
        el.innerHTML = `
            <div class="kpi"><div class="kpi-label">Total</div><div class="kpi-val">${allProspects.length}</div></div>
            <div class="kpi"><div class="kpi-label">QA Leaders</div><div class="kpi-val">${qa}</div></div>
            <div class="kpi"><div class="kpi-label">VP Eng</div><div class="kpi-val">${eng}</div></div>
            <div class="kpi"><div class="kpi-label">Hot (5)</div><div class="kpi-val">${hot}</div></div>
            <div class="kpi"><div class="kpi-label">LinkedIn</div><div class="kpi-val">${withLinkedin}</div></div>
            <div class="kpi"><div class="kpi-label">With Drafts</div><div class="kpi-val">${withDrafts}</div></div>
        `;

        renderProspectsTable(allProspects);
    } catch(e) { console.error('loadProspectsPage:', e); }
}

function renderProspectsTable(prospects) {
    const tbody = document.getElementById('prospects-full-body');
    const emptyEl = document.getElementById('prospects-empty');
    const tableWrap = document.getElementById('prospects-table-wrap');

    if (!prospects.length) {
        emptyEl.style.display = 'block';
        tableWrap.style.display = 'none';
        return;
    }
    emptyEl.style.display = 'none';
    tableWrap.style.display = '';

    tbody.innerHTML = prospects.map(c => {
        const name = `${c.first_name || ''} ${c.last_name || ''}`.trim();
        const priBadge = c.priority_score >= 5 ? 'background:#ef4444;color:#fff' :
                         c.priority_score >= 4 ? 'background:#f59e0b;color:#000' :
                         c.priority_score >= 3 ? 'background:#3b82f6;color:#fff' : 'background:#6b7280;color:#fff';
        const personaBadge = c.persona_type === 'qa_leader' ? 'background:#10b981;color:#fff' :
                            c.persona_type === 'vp_eng' ? 'background:#8b5cf6;color:#fff' : 'background:#6b7280;color:#fff';
        const personaLabel = c.persona_type === 'qa_leader' ? 'QA' : c.persona_type === 'vp_eng' ? 'VP Eng' : c.persona_type || '-';
        const hasLinkedin = c.linkedin_url && c.linkedin_url.includes('linkedin.com');
        const linkedinUrl = hasLinkedin ? (c.linkedin_url.startsWith('http') ? c.linkedin_url : 'https://' + c.linkedin_url) : '';
        const draftCount = (c.drafts || []).length;

        return `<tr data-persona="${c.persona_type || ''}" data-priority="${c.priority_score || 0}" data-name="${name.toLowerCase()}" data-company="${(c.company_name || '').toLowerCase()}">
            <td><span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:bold;${priBadge}">${c.priority_score || '-'}</span></td>
            <td><strong style="cursor:pointer;color:var(--accent)" onclick="openProspectDetail('${c.id}')">${esc(name)}</strong></td>
            <td style="font-size:12px">${esc(c.title || '')}</td>
            <td>${esc(c.company_name || '')}</td>
            <td><span style="display:inline-block;padding:2px 6px;border-radius:4px;font-size:11px;${personaBadge}">${personaLabel}</span></td>
            <td>${hasLinkedin ? `<a href="${linkedinUrl}" target="_blank" rel="noopener" style="color:#0a66c2;text-decoration:none;font-size:12px" title="Open LinkedIn profile">Open</a>` : '<span style="color:var(--text-muted);font-size:11px">-</span>'}</td>
            <td style="text-align:center">${draftCount > 0 ? `<span style="background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;font-size:11px">${draftCount}</span>` : '-'}</td>
            <td><button class="btn btn-sm" onclick="openProspectDetail('${c.id}')" style="font-size:11px;padding:2px 8px">View</button></td>
        </tr>`;
    }).join('');
}

function filterFullProspects() {
    const persona = document.getElementById('prospects-persona-filter').value;
    const priority = document.getElementById('prospects-priority-filter').value;
    const search = (document.getElementById('prospects-search').value || '').toLowerCase();

    const filtered = allProspects.filter(p => {
        if (persona && p.persona_type !== persona) return false;
        if (priority && (p.priority_score || 0) != parseInt(priority)) return false;
        if (search) {
            const name = `${p.first_name || ''} ${p.last_name || ''}`.toLowerCase();
            const company = (p.company_name || '').toLowerCase();
            if (!name.includes(search) && !company.includes(search)) return false;
        }
        return true;
    });
    renderProspectsTable(filtered);
}

async function openProspectDetail(contactId) {
    const modal = document.getElementById('prospect-detail-modal');
    const content = document.getElementById('prospect-detail-content');
    modal.style.display = 'block';
    content.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary)">Loading...</div>';

    try {
        const data = await api(`/api/prospects/${contactId}/drafts`);
        const c = data.contact;
        const drafts = data.drafts || [];
        const research = data.research;
        const name = `${c.first_name || ''} ${c.last_name || ''}`.trim();
        const hasLinkedin = c.linkedin_url && c.linkedin_url.includes('linkedin.com');
        const linkedinUrl = hasLinkedin ? (c.linkedin_url.startsWith('http') ? c.linkedin_url : 'https://' + c.linkedin_url) : '';

        const touchLabels = {1:'Touch 1 - InMail', 2:'Touch 2 - Call Script', 3:'Touch 3 - Follow-up', 4:'Touch 4 - Call Script #2', 5:'Touch 5 - Email', 6:'Touch 6 - Break-up'};

        // Get research evidence for completeness badge
        let researchCompletenessState = {badge: '‚óØ Needs Research', color: 'var(--error)', bgColor: 'var(--error-bg)'};
        try {
            const evidence = await api(`/api/contacts/${contactId}/research-evidence`);
            if (evidence) {
                researchCompletenessState = getResearchCompletenessState(evidence.profile_evidence, evidence.company_evidence);
            }
        } catch(e) {
            // Silently ignore if evidence can't be loaded
        }

        let html = `
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px">
                <div>
                    <h2 style="margin:0">${esc(name)}</h2>
                    <div style="color:var(--text-secondary);margin-top:4px">${esc(c.title || '')} at ${esc(c.company_name || c.vertical || '')}</div>
                    <div style="margin-top:8px;display:inline-block;padding:4px 12px;background:${researchCompletenessState.bgColor};color:${researchCompletenessState.color};border-radius:12px;font-size:12px;font-weight:600">${researchCompletenessState.badge}</div>
                </div>
                <div style="display:flex;gap:8px">
                    ${hasLinkedin ? `<a href="${linkedinUrl}" target="_blank" rel="noopener" class="btn btn-sm" style="background:#0a66c2;color:#fff;text-decoration:none">Open LinkedIn</a>` : ''}
                    ${hasLinkedin ? `<button class="btn btn-sm" onclick="copyToClip('${linkedinUrl}')">Copy URL</button>` : ''}
                </div>
            </div>
        `;

        // Research section
        if (research) {
            html += `<div style="background:var(--bg-primary);border-radius:8px;padding:16px;margin-bottom:16px">
                <h4 style="margin:0 0 8px">Research</h4>
                <div style="font-size:13px;color:var(--text-secondary)">
                    <div style="margin-bottom:4px"><em>${esc(research.headline || c.key_detail || '')}</em></div>
                    <div>${esc(research.summary || c.company_detail || '')}</div>
                </div>
            </div>`;
        }

        // Objection section
        if (c.predicted_objection) {
            html += `<div style="background:#1e1b30;border-left:3px solid #f59e0b;border-radius:4px;padding:12px;margin-bottom:16px">
                <div style="font-size:12px;font-weight:bold;color:#f59e0b;margin-bottom:4px">Predicted Objection</div>
                <div style="font-size:13px;margin-bottom:6px">${esc(c.predicted_objection)}</div>
                <div style="font-size:12px;color:var(--text-secondary)"><strong>Response:</strong> ${esc(c.objection_response || '')}</div>
            </div>`;
        }

        // Research Evidence section
        try {
            const evidence = await api(`/api/contacts/${contactId}/research-evidence`);
            if (evidence) {
                let evidenceHtml = '<h3 style="margin-bottom:12px;margin-top:16px">Research Evidence</h3>';

                // Profile evidence
                if (evidence.profile_evidence) {
                    const pe = evidence.profile_evidence;
                    const bullets = typeof pe.bullets === 'string' ? JSON.parse(pe.bullets || '[]') : (pe.bullets || []);
                    evidenceHtml += `<div style="background:var(--bg-primary);border-radius:8px;padding:16px;margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <h4 style="margin:0;font-size:13px">Profile Evidence</h4>
                            <button class="btn btn-sm" onclick="toggleResearchEditMode('${contactId}', 'profile')" style="font-size:11px;padding:2px 8px">Edit</button>
                        </div>
                        <div style="margin-bottom:8px">
                            ${bullets.map(b => `<div style="margin-bottom:4px;font-size:13px">‚Ä¢ ${esc(b)}</div>`).join('')}
                            ${!bullets.length ? '<div style="color:var(--text-muted);font-size:12px">No bullets recorded</div>' : ''}
                        </div>
                        <div style="font-size:12px;color:var(--text-muted)">Snippet: <em>${esc((pe.snippet || '').substring(0, 100))}</em></div>
                        ${pe.verified_at ? `<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Verified: ${new Date(pe.verified_at).toLocaleDateString()}</div>` : ''}
                    </div>`;
                }

                // Company evidence
                if (evidence.company_evidence) {
                    const ce = evidence.company_evidence;
                    const bullets = typeof ce.bullets === 'string' ? JSON.parse(ce.bullets || '[]') : (ce.bullets || []);
                    evidenceHtml += `<div style="background:var(--bg-primary);border-radius:8px;padding:16px;margin-bottom:12px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <h4 style="margin:0;font-size:13px">Company Evidence</h4>
                            <button class="btn btn-sm" onclick="toggleResearchEditMode('${contactId}', 'company')" style="font-size:11px;padding:2px 8px">Edit</button>
                        </div>
                        <div style="margin-bottom:8px">
                            ${bullets.map(b => `<div style="margin-bottom:4px;font-size:13px">‚Ä¢ ${esc(b)}</div>`).join('')}
                            ${!bullets.length ? '<div style="color:var(--text-muted);font-size:12px">No bullets recorded</div>' : ''}
                        </div>
                        <div style="font-size:12px;color:var(--text-muted)">Snippet: <em>${esc((ce.snippet || '').substring(0, 100))}</em></div>
                        ${ce.verified_at ? `<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Verified: ${new Date(ce.verified_at).toLocaleDateString()}</div>` : ''}
                    </div>`;
                }

                if (evidence.profile_evidence || evidence.company_evidence) {
                    html += evidenceHtml;
                }
            }
        } catch(e) {
            console.log('Could not load research evidence:', e.message);
        }

        // Drafts section with Send Assist
        if (drafts.length) {
            html += '<h3 style="margin-bottom:12px">Messages & Send Assist</h3>';
            for (const d of drafts) {
                const label = touchLabels[d.touch_number] || `Touch ${d.touch_number}`;
                const isCall = d.touch_type === 'call' || d.touch_number === 2 || d.touch_number === 4;
                const draftId = d.id || '';
                html += `<div style="background:var(--bg-primary);border-radius:8px;padding:16px;margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                        <h4 style="margin:0;font-size:14px">${label}</h4>
                        <div style="display:flex;gap:6px;flex-wrap:wrap">
                            ${d.subject_line ? `<button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.subject_line)}\`)" style="font-size:11px;padding:2px 8px">Copy Subject</button>` : ''}
                            <button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.body)}\`)" style="font-size:11px;padding:2px 8px">${isCall ? 'Copy Script' : 'Copy Message'}</button>
                            ${hasLinkedin ? `<a href="${linkedinUrl}" target="_blank" rel="noopener" class="btn btn-sm" style="font-size:11px;padding:2px 8px;background:#0a66c2;color:#fff;text-decoration:none">LinkedIn</a>` : ''}
                            <button class="btn btn-sm" onclick="markAsSent('${contactId}', '${draftId}')" style="font-size:11px;padding:2px 8px;background:var(--success-bg);color:var(--success)">Mark Sent</button>
                        </div>
                    </div>
                    ${d.subject_line ? `<div style="font-size:12px;color:var(--text-muted);margin-bottom:6px"><strong>Subject:</strong> ${esc(d.subject_line)}</div>` : ''}
                    <div style="font-size:13px;white-space:pre-line;margin-bottom:12px;${isCall ? 'font-family:monospace;font-size:12px;background:var(--bg-elevated);padding:10px;border-radius:4px' : ''}">${esc(d.body)}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;padding:10px;background:var(--bg-elevated);border-radius:4px">
                        <div style="font-size:11px"><strong>Pre-Send Checklist</strong></div>
                        <div></div>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" style="cursor:pointer"> Confirmed name spelling</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" style="cursor:pointer"> Company reference accurate</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" style="cursor:pointer"> Personalized opener</label>
                        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" style="cursor:pointer"> Low-pressure ask present</label>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted)">${d.word_count || 0} words</div>
                </div>`;
            }
        } else {
            html += '<p style="color:var(--text-muted)">No message drafts for this prospect yet.</p>';
        }

        content.innerHTML = html;
    } catch(e) {
        content.innerHTML = `<p style="color:#ef4444">Error loading prospect details: ${e.message}</p>`;
    }
}

function closeProspectDetail() {
    document.getElementById('prospect-detail-modal').style.display = 'none';
}

function copyToClip(text) {
    // Sanitize: trim whitespace, remove "ChatGPT said" or "Subject:" prefixes, strip HTML tags, remove em dashes
    let clean = (text || '').trim();
    clean = clean.replace(/^(ChatGPT said|Subject:)\s*/gi, '');
    clean = clean.replace(/<[^>]*>/g, '');
    clean = clean.replace(/[\u2014\u2013]/g, '-');
    clean = clean.replace(/\n{3,}/g, '\n\n');

    navigator.clipboard.writeText(clean).then(() => {
        const toast = document.createElement('div');
        toast.textContent = 'Copied (plain text)!';
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:8px 16px;border-radius:6px;z-index:9999;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    });
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escJs(s) { return (s||'').replace(/\\/g,'\\\\').replace(/`/g,'\\`').replace(/\$/g,'\\$'); }

// Research Evidence Functions
function getResearchCompletenessState(profileEvidence, companyEvidence) {
    const profileHasData = profileEvidence && (profileEvidence.bullets && (typeof profileEvidence.bullets === 'string' ? JSON.parse(profileEvidence.bullets || '[]') : profileEvidence.bullets).length >= 2);
    const companyHasData = companyEvidence && (companyEvidence.bullets && (typeof companyEvidence.bullets === 'string' ? JSON.parse(companyEvidence.bullets || '[]') : companyEvidence.bullets).length >= 2);

    if (profileHasData && companyHasData) return {badge: '‚úì Research Complete', color: 'var(--success)', bgColor: 'var(--success-bg)'};
    if (profileHasData || companyHasData) return {badge: '‚óê Partial Research', color: 'var(--warning)', bgColor: 'var(--warning-bg)'};
    return {badge: '‚óØ Needs Research', color: 'var(--error)', bgColor: 'var(--error-bg)'};
}

async function toggleResearchEditMode(contactId, evidenceType) {
    // Placeholder for edit mode toggle
    // Will implement full edit UI in future
    showToast('Edit mode for research evidence coming soon', 'info');
}

async function saveResearchEvidence(contactId, evidenceType, bullets, snippet) {
    try {
        const payload = {
            evidence_type: evidenceType,
            bullets: bullets,
            snippet: snippet
        };
        await apiPost(`/api/contacts/${contactId}/research-evidence`, payload, 'PUT');
        showToast('Research evidence saved', 'success');
        await openProspectDetail(contactId);
    } catch(e) {
        showToast('Failed to save: ' + e.message, 'error');
    }
}

// =====================================================
// ENHANCED DRAFTS PAGE
// =====================================================
async function loadDraftsFull() {
    const touchFilter = document.getElementById('drafts-touch-filter')?.value || '';
    const search = (document.getElementById('drafts-search-full')?.value || '').toLowerCase();

    try {
        // Load and display pacing guidance
        const quota = await api('/api/quota');
        if (quota) {
            const banner = document.getElementById('pacing-banner');
            const bannerText = document.getElementById('pacing-text');
            const quotaText = `${quota.sends_today || 0} of ${quota.daily_target || 0} sends today`;
            bannerText.textContent = quotaText;

            if ((quota.sends_today || 0) > (quota.daily_target || 0)) {
                document.getElementById('pacing-title').innerHTML = '‚ö†Ô∏è Over target';
                bannerText.innerHTML += '<br>You\'ve exceeded your daily target. Consider spacing out remaining sends.';
                banner.style.display = 'block';
                banner.style.borderLeftColor = 'var(--error)';
                banner.style.backgroundColor = 'var(--error-bg)';
                document.querySelector('#pacing-banner > div').style.color = 'var(--error)';
            } else if ((quota.sends_today || 0) < (quota.daily_target || 0)) {
                const remaining = (quota.daily_target || 0) - (quota.sends_today || 0);
                bannerText.innerHTML += `<br>${remaining} more sends to hit today's target`;
                banner.style.display = 'block';
            }
        }

        const data = await api('/api/prospects/full');
        const prospects = data.prospects || [];
        const kpisEl = document.getElementById('drafts-kpis');
        const listEl = document.getElementById('drafts-list');

        // Collect all drafts with prospect info
        let allDrafts = [];
        for (const p of prospects) {
            for (const d of (p.drafts || [])) {
                allDrafts.push({
                    ...d,
                    contact_id: p.id,
                    prospect_name: `${p.first_name || ''} ${p.last_name || ''}`.trim(),
                    company: p.company_name || '',
                    linkedin_url: p.linkedin_url || '',
                    priority: p.priority_score || 0
                });
            }
        }

        // Filter out incomplete/invalid drafts
        allDrafts = allDrafts.filter(d => {
            const body = d.body || '';
            if (body.length < 100 || body.endsWith('...')) return false;
            if (d.status === 'invalid_incomplete') return false;
            return true;
        });

        // Filter
        if (touchFilter) {
            allDrafts = allDrafts.filter(d => d.touch_number == parseInt(touchFilter));
        }
        if (search) {
            allDrafts = allDrafts.filter(d =>
                d.prospect_name.toLowerCase().includes(search) ||
                d.company.toLowerCase().includes(search) ||
                (d.body || '').toLowerCase().includes(search)
            );
        }

        const touchLabels = {1:'InMail', 2:'Call', 3:'Follow-up', 4:'Call #2', 5:'Email', 6:'Break-up'};
        const t1 = allDrafts.filter(d => d.touch_number === 1).length;
        const t3 = allDrafts.filter(d => d.touch_number === 3).length;
        const t6 = allDrafts.filter(d => d.touch_number === 6).length;
        const calls = allDrafts.filter(d => d.touch_number === 2 || d.touch_number === 4).length;

        if (kpisEl) kpisEl.innerHTML = `
            <div class="kpi"><div class="kpi-label">Total Drafts</div><div class="kpi-val">${allDrafts.length}</div></div>
            <div class="kpi"><div class="kpi-label">InMails</div><div class="kpi-val">${t1}</div></div>
            <div class="kpi"><div class="kpi-label">Follow-ups</div><div class="kpi-val">${t3}</div></div>
            <div class="kpi"><div class="kpi-label">Call Scripts</div><div class="kpi-val">${calls}</div></div>
            <div class="kpi"><div class="kpi-label">Break-ups</div><div class="kpi-val">${t6}</div></div>
        `;

        if (!allDrafts.length) {
            if (listEl) listEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary)">No drafts found. Import a RunBundle to get started.</div>';
            return;
        }

        // Sort by prospect priority desc, then touch number
        allDrafts.sort((a,b) => (b.priority - a.priority) || (a.touch_number - b.touch_number));

        if (listEl) listEl.innerHTML = allDrafts.map(d => renderDraftCard(d, touchLabels)).join('');

        // Attach event listeners after rendering
        document.querySelectorAll('.draft-header').forEach(el => {
            el.addEventListener('click', (e) => {
                if (e.target.closest('button, a')) return;
                const card = el.parentElement;
                const draftId = card.getAttribute('data-draft-id');
                toggleDraftExpandFull(draftId);
            });
        });
    } catch(e) {
        console.error('loadDraftsFull:', e);
        const listEl = document.getElementById('drafts-list');
        if (listEl) listEl.innerHTML = `<div style="color:#ef4444;padding:20px">Error loading drafts: ${e.message}</div>`;
    }
}

function renderDraftCard(d, touchLabels) {
    const isCall = d.touch_number === 2 || d.touch_number === 4;
    const touchLabel = touchLabels[d.touch_number] || `Touch ${d.touch_number}`;
    const hasLinkedin = d.linkedin_url && d.linkedin_url.includes('linkedin.com');
    const linkedinUrl = hasLinkedin ? (d.linkedin_url.startsWith('http') ? d.linkedin_url : 'https://' + d.linkedin_url) : '';
    const draftId = d.id || '';
    const contactId = d.contact_id || '';
    const wordCount = d.word_count || 0;
    const charCount = (d.body || '').length;
    const draftStatus = d.status || 'drafted';

    return `<div class="draft-card" data-draft-id="${draftId}" data-contact-id="${contactId}">
        <div class="draft-header">
            <div class="draft-header-left">
                <div class="draft-title">
                    <strong>${esc(d.prospect_name)}</strong>
                    <span class="draft-company">${esc(d.company)}</span>
                </div>
                <div class="draft-meta">
                    <span class="draft-touch">${touchLabel}</span>
                    <span class="draft-wordcount">${wordCount} words / ${charCount} chars</span>
                    <span class="draft-status" style="background:${draftStatus === 'sent' ? 'var(--success-bg)' : draftStatus === 'ready' ? 'var(--accent-bg)' : 'var(--warning-bg)'};color:${draftStatus === 'sent' ? 'var(--success)' : draftStatus === 'ready' ? 'var(--accent)' : 'var(--warning)'};padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold">${draftStatus}</span>
                </div>
            </div>
            <div class="draft-toggle">‚ñº</div>
        </div>
        <div class="draft-body" style="display:none;border-top:1px solid var(--border)">
            <div class="draft-tabs">
                <button class="draft-tab-btn active" onclick="switchDraftTab(event,'${draftId}','message')">Message</button>
                <button class="draft-tab-btn" onclick="switchDraftTab(event,'${draftId}','research')">Research & Rationale</button>
            </div>
            <div class="draft-tab-content active" id="draft-tab-message-${draftId}">
                ${d.subject_line ? `<div style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:bold">Subject</div>
                        <button class="btn btn-sm" onclick="toggleEditSubject('${draftId}')" style="font-size:10px;padding:3px 8px" id="edit-subject-btn-${draftId}">Edit</button>
                    </div>
                    <div id="subject-display-${draftId}" style="background:var(--bg-primary);padding:8px 12px;border-radius:4px;border-left:3px solid var(--accent);font-size:13px;word-break:break-word">${esc(d.subject_line)}</div>
                    <div id="subject-edit-${draftId}" style="display:none">
                        <input type="text" class="draft-subject-input" id="subject-input-${draftId}" value="${esc(d.subject_line)}">
                        <div style="display:flex;gap:6px;margin-top:6px">
                            <button class="btn btn-sm" onclick="saveSubjectEdit('${draftId}')" style="font-size:10px;padding:3px 8px;background:var(--success-bg);color:var(--success)">Save</button>
                            <button class="btn btn-sm" onclick="cancelSubjectEdit('${draftId}')" style="font-size:10px;padding:3px 8px">Cancel</button>
                        </div>
                    </div>
                </div>` : ''}
                <div style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                        <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:bold">Message</div>
                        <button class="btn btn-sm" onclick="toggleEditBody('${draftId}')" style="font-size:10px;padding:3px 8px" id="edit-body-btn-${draftId}">Edit</button>
                    </div>
                    <div class="draft-message-body ${isCall ? 'call-script' : ''}" id="body-display-${draftId}">${esc(d.body)}</div>
                    <div id="body-edit-${draftId}" style="display:none">
                        <textarea class="draft-edit-textarea" id="body-input-${draftId}" oninput="autoResizeTextarea(this)">${esc(d.body)}</textarea>
                        <div style="display:flex;gap:6px;margin-top:6px;align-items:center">
                            <button class="btn btn-sm" onclick="saveBodyEdit('${draftId}')" style="font-size:10px;padding:3px 8px;background:var(--success-bg);color:var(--success)">Save</button>
                            <button class="btn btn-sm" onclick="cancelBodyEdit('${draftId}')" style="font-size:10px;padding:3px 8px">Cancel</button>
                            <span style="font-size:10px;color:var(--text-muted);margin-left:auto" id="edit-charcount-${draftId}"></span>
                        </div>
                    </div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
                    ${d.subject_line ? `<button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.subject_line)}\`)" style="font-size:11px;padding:6px 10px">Copy Subject</button>` : ''}
                    <button class="btn btn-sm" onclick="copyToClip(\`${escJs(d.body)}\`)" style="font-size:11px;padding:6px 10px">${isCall ? 'Copy Script' : 'Copy Message'}</button>
                    ${hasLinkedin ? `<a href="${linkedinUrl}" target="_blank" rel="noopener" class="btn btn-sm" style="font-size:11px;padding:6px 10px;background:#0a66c2;color:#fff;text-decoration:none">Open LinkedIn</a>` : ''}
                    <button class="btn btn-sm btn-success" onclick="markDraftSent('${draftId}')" ${draftStatus === 'sent' ? 'disabled' : ''} style="font-size:11px;padding:6px 10px">${draftStatus === 'sent' ? '‚úì Sent' : 'Mark Sent'}</button>
                    <button class="btn btn-sm" onclick="showLogResponseModal('${contactId}', '')" style="font-size:11px;padding:6px 10px">Log Response</button>
                    <button class="btn btn-sm" onclick="enhanceDraft('${draftId}')" style="font-size:11px;padding:6px 10px;background:var(--warning-bg);color:var(--warning)">Enhance</button>
                </div>
                ${d.ab_group ? `<div style="font-size:11px;color:var(--text-muted)">A/B Group: <strong>${esc(d.ab_group)}</strong></div>` : ''}
            </div>
            <div class="draft-tab-content" id="draft-tab-research-${draftId}">
                <div id="research-content-${draftId}" style="text-align:center;padding:20px;color:var(--text-secondary)">
                    <div style="font-size:12px">Loading research data...</div>
                </div>
            </div>
        </div>
    </div>`;
}

function switchDraftTab(event, draftId, tabName) {
    event.stopPropagation();
    const card = document.querySelector(`[data-draft-id="${draftId}"]`);
    if (!card) return;
    card.querySelectorAll('.draft-tab-btn').forEach(b => b.classList.remove('active'));
    card.querySelectorAll('.draft-tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    const tabEl = document.getElementById(`draft-tab-${tabName}-${draftId}`);
    if (tabEl) tabEl.classList.add('active');
    if (tabName === 'research') loadResearchTab(draftId);
}

async function loadResearchTab(draftId) {
    const container = document.getElementById(`research-content-${draftId}`);
    if (!container || container.dataset.loaded === 'true') return;
    container.dataset.loaded = 'true';
    try {
        const data = await api(`/api/drafts/${draftId}/research`);
        if (!data || data.error) {
            container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted)">
                <div style="font-size:12px">No research data linked to this draft yet.</div>
                <div style="font-size:11px;margin-top:6px">Research data will be populated when prospects are imported via RunBundle.</div>
            </div>`;
            return;
        }
        const link = data.research_link || {};
        const snapshot = data.research_snapshot || {};
        const evidence = data.research_evidence || {};
        const contact = data.contact || {};
        const account = data.account || {};

        let profileBullets = [];
        try { profileBullets = typeof link.profile_bullets === 'string' ? JSON.parse(link.profile_bullets || '[]') : (link.profile_bullets || []); } catch(e) { profileBullets = []; }
        let companyBullets = [];
        try { companyBullets = typeof link.company_bullets === 'string' ? JSON.parse(link.company_bullets || '[]') : (link.company_bullets || []); } catch(e) { companyBullets = []; }
        let confidenceReasons = [];
        try { confidenceReasons = typeof link.confidence_reasons === 'string' ? JSON.parse(link.confidence_reasons || '[]') : (link.confidence_reasons || []); } catch(e) { confidenceReasons = []; }

        const hasProfile = profileBullets.length > 0;
        const hasCompany = companyBullets.length > 0;
        const completeness = hasProfile && hasCompany ? 'complete' : (hasProfile || hasCompany ? 'partial' : 'missing');
        const completenessLabel = completeness === 'complete' ? 'Complete' : completeness === 'partial' ? 'Partial' : 'Missing';

        const confScore = link.confidence_score || 0;
        const confLevel = confScore >= 70 ? 'high' : confScore >= 40 ? 'medium' : 'low';

        let html = `<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
            <span class="research-completeness ${completeness}">Research: ${completenessLabel}</span>
            ${confScore > 0 ? `<span class="confidence-badge ${confLevel}">Confidence: ${confScore}%</span>` : ''}
            ${link.template_name ? `<span style="background:var(--bg-elevated);padding:3px 8px;border-radius:12px;font-size:11px;color:var(--text-secondary)">Template: ${esc(link.template_name)}${link.template_version ? ' v' + esc(link.template_version) : ''}</span>` : ''}
            ${link.ab_group_explanation ? `<span style="background:var(--accent-bg);padding:3px 8px;border-radius:12px;font-size:11px;color:var(--accent)">A/B: ${esc(link.ab_group_explanation)}</span>` : ''}
        </div>`;

        if (profileBullets.length > 0) {
            html += `<div class="research-section">
                <div class="research-section-title">Profile Research</div>
                ${profileBullets.map(b => `<div class="research-bullet">${esc(typeof b === 'string' ? b : b.text || JSON.stringify(b))}</div>`).join('')}
            </div>`;
        }

        if (companyBullets.length > 0) {
            html += `<div class="research-section">
                <div class="research-section-title">Company Research</div>
                ${companyBullets.map(b => `<div class="research-bullet">${esc(typeof b === 'string' ? b : b.text || JSON.stringify(b))}</div>`).join('')}
            </div>`;
        }

        if (link.pain_hypothesis) {
            html += `<div class="research-section">
                <div class="research-section-title">Pain Hypothesis</div>
                <div style="padding:8px 12px;background:var(--bg-elevated);border-radius:4px;font-size:12px;line-height:1.5;border-left:3px solid var(--warning)">${esc(link.pain_hypothesis)}</div>
            </div>`;
        }

        if (link.why_testsigma) {
            html += `<div class="research-section">
                <div class="research-section-title">Why Testsigma</div>
                <div style="padding:8px 12px;background:var(--bg-elevated);border-radius:4px;font-size:12px;line-height:1.5;border-left:3px solid var(--success)">${esc(link.why_testsigma)}</div>
            </div>`;
        }

        if (confidenceReasons.length > 0) {
            html += `<div class="research-section">
                <div class="research-section-title">Confidence Reasons</div>
                ${confidenceReasons.map(r => `<div style="padding:4px 10px;margin-bottom:3px;font-size:11px;color:var(--text-secondary)">&bull; ${esc(typeof r === 'string' ? r : r.reason || JSON.stringify(r))}</div>`).join('')}
            </div>`;
        }

        // Links row
        const linkedinUrl = link.linkedin_url || contact.linkedin_url || '';
        const companyUrl = link.company_url || '';
        if (linkedinUrl || companyUrl) {
            html += `<div style="display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                ${linkedinUrl ? `<a href="${linkedinUrl.startsWith('http') ? linkedinUrl : 'https://' + linkedinUrl}" target="_blank" rel="noopener" class="btn btn-sm" style="font-size:11px;padding:5px 10px;background:#0a66c2;color:#fff;text-decoration:none">LinkedIn Profile</a>` : ''}
                ${companyUrl ? `<a href="${companyUrl.startsWith('http') ? companyUrl : 'https://' + companyUrl}" target="_blank" rel="noopener" class="btn btn-sm" style="font-size:11px;padding:5px 10px">Company Website</a>` : ''}
            </div>`;
        }

        container.innerHTML = html;
    } catch(e) {
        console.error('loadResearchTab:', e);
        container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted)">
            <div style="font-size:12px">No research data available for this draft.</div>
        </div>`;
    }
}

function toggleEditSubject(draftId) {
    const display = document.getElementById(`subject-display-${draftId}`);
    const edit = document.getElementById(`subject-edit-${draftId}`);
    const btn = document.getElementById(`edit-subject-btn-${draftId}`);
    if (!display || !edit) return;
    if (edit.style.display === 'none') {
        edit.style.display = 'block';
        display.style.display = 'none';
        btn.style.display = 'none';
        document.getElementById(`subject-input-${draftId}`).focus();
    }
}

function cancelSubjectEdit(draftId) {
    const display = document.getElementById(`subject-display-${draftId}`);
    const edit = document.getElementById(`subject-edit-${draftId}`);
    const btn = document.getElementById(`edit-subject-btn-${draftId}`);
    if (!display || !edit) return;
    edit.style.display = 'none';
    display.style.display = 'block';
    btn.style.display = '';
}

async function saveSubjectEdit(draftId) {
    const input = document.getElementById(`subject-input-${draftId}`);
    if (!input) return;
    try {
        await apiPost(`/api/drafts/${draftId}`, { subject_line: input.value }, 'PATCH');
        const display = document.getElementById(`subject-display-${draftId}`);
        if (display) display.textContent = input.value;
        cancelSubjectEdit(draftId);
        showToast('Subject updated', 'success');
    } catch(e) {
        showToast('Failed to save: ' + e.message, 'error');
    }
}

function toggleEditBody(draftId) {
    const display = document.getElementById(`body-display-${draftId}`);
    const edit = document.getElementById(`body-edit-${draftId}`);
    const btn = document.getElementById(`edit-body-btn-${draftId}`);
    if (!display || !edit) return;
    if (edit.style.display === 'none') {
        edit.style.display = 'block';
        display.style.display = 'none';
        btn.style.display = 'none';
        const textarea = document.getElementById(`body-input-${draftId}`);
        if (textarea) {
            textarea.focus();
            autoResizeTextarea(textarea);
            updateEditCharCount(draftId);
        }
    }
}

function cancelBodyEdit(draftId) {
    const display = document.getElementById(`body-display-${draftId}`);
    const edit = document.getElementById(`body-edit-${draftId}`);
    const btn = document.getElementById(`edit-body-btn-${draftId}`);
    if (!display || !edit) return;
    edit.style.display = 'none';
    display.style.display = 'block';
    btn.style.display = '';
}

async function saveBodyEdit(draftId) {
    const textarea = document.getElementById(`body-input-${draftId}`);
    if (!textarea) return;
    try {
        await apiPost(`/api/drafts/${draftId}`, { body: textarea.value }, 'PATCH');
        const display = document.getElementById(`body-display-${draftId}`);
        if (display) display.textContent = textarea.value;
        cancelBodyEdit(draftId);
        showToast('Message updated', 'success');
    } catch(e) {
        showToast('Failed to save: ' + e.message, 'error');
    }
}

function autoResizeTextarea(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 500) + 'px';
    const draftId = el.id.replace('body-input-', '');
    updateEditCharCount(draftId);
}

function updateEditCharCount(draftId) {
    const textarea = document.getElementById(`body-input-${draftId}`);
    const counter = document.getElementById(`edit-charcount-${draftId}`);
    if (textarea && counter) {
        const words = textarea.value.trim().split(/\s+/).filter(Boolean).length;
        counter.textContent = `${words} words / ${textarea.value.length} chars`;
    }
}

function toggleDraftExpandFull(draftId) {
    const card = document.querySelector(`[data-draft-id="${draftId}"]`);
    if (!card) return;
    const body = card.querySelector('.draft-body');
    const toggle = card.querySelector('.draft-toggle');
    if (body.style.display === 'none') {
        body.style.display = 'block';
        toggle.style.transform = 'rotate(180deg)';
    } else {
        body.style.display = 'none';
        toggle.style.transform = 'rotate(0deg)';
    }
}

async function markAsSent(contactId, draftId) {
    if (!contactId || !draftId) {
        alert('Missing contact or draft ID');
        return;
    }
    try {
        const result = await apiPost('/api/send-log', {
            contact_id: contactId,
            draft_id: draftId,
            channel: 'linkedin'
        });

        const card = document.querySelector(`[data-draft-id="${draftId}"]`);
        if (card) {
            const status = card.querySelector('.draft-status');
            if (status) {
                status.textContent = 'sent';
                status.style.background = 'var(--success-bg)';
                status.style.color = 'var(--success)';
            }
        }

        // Show success toast
        const toast = document.createElement('div');
        toast.textContent = 'Message marked as sent!';
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:8px 16px;border-radius:6px;z-index:9999;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    } catch(e) {
        console.error('markAsSent error:', e);
        alert('Error marking as sent: ' + e.message);
    }
}

// --- Log Response System ---
function showLogResponseModal(contactId, touchId) {
    document.getElementById('resp-contact-id').value = contactId || '';
    document.getElementById('resp-touch-id').value = touchId || '';
    document.getElementById('resp-text').value = '';
    document.getElementById('resp-notes').value = '';
    document.getElementById('resp-objection').value = '';
    document.getElementById('resp-referral-name').value = '';
    document.getElementById('resp-referral-title').value = '';
    document.getElementById('log-response-modal').style.display = 'flex';
}

document.getElementById('resp-type')?.addEventListener('change', function() {
    document.getElementById('resp-referral-fields').style.display =
        this.value === 'referral' ? 'block' : 'none';
});

async function submitResponse() {
    const data = {
        contact_id: document.getElementById('resp-contact-id').value,
        touch_id: document.getElementById('resp-touch-id').value || null,
        response_type: document.getElementById('resp-type').value,
        response_text: document.getElementById('resp-text').value,
        sentiment: document.getElementById('resp-sentiment').value,
        interest_level: document.getElementById('resp-interest').value,
        what_resonated: document.getElementById('resp-resonated').value || null,
        objection_encountered: document.getElementById('resp-objection').value || null,
        referral_name: document.getElementById('resp-referral-name').value || null,
        referral_title: document.getElementById('resp-referral-title').value || null,
        notes: document.getElementById('resp-notes').value || null,
    };

    if (!data.contact_id) { showToast('Contact ID required', 'warning'); return; }

    const result = await apiPost('/api/responses', data);
    if (result && !result._error) {
        showToast('Response logged successfully', 'success');
        document.getElementById('log-response-modal').style.display = 'none';
        // Refresh the current page
        const activePage = document.querySelector('.page.active');
        if (activePage) {
            const pageId = activePage.id.replace('page-', '');
            showPage(pageId);
        }
    } else {
        showToast('Failed to log response: ' + (result?.message || 'Unknown error'), 'error');
    }
}

async function markDraftSent(draftId) {
    if (!confirm('Confirm: You have copied and pasted this message into LinkedIn?')) return;
    const result = await apiPost('/api/linkedin/mark-sent', { draft_id: draftId });
    if (result && !result._error) {
        showToast(`Marked as sent (hash: ${result.message_hash})`, 'success');
        // Refresh
        const activePage = document.querySelector('.page.active');
        if (activePage) {
            const pageId = activePage.id.replace('page-', '');
            showPage(pageId);
        }
    } else {
        showToast('Failed: ' + (result?.message || 'Unknown error'), 'error');
    }
}

// =====================================================
// DRAFT ENHANCEMENT
// =====================================================
async function enhanceDraft(draftId) {
    document.getElementById('enhance-modal').style.display = 'flex';
    document.getElementById('enhance-loading').style.display = '';
    document.getElementById('enhance-content').style.display = 'none';

    const result = await apiPost(`/api/drafts/${draftId}/enhance`, {});
    document.getElementById('enhance-loading').style.display = 'none';
    const content = document.getElementById('enhance-content');
    content.style.display = '';

    if (!result || result._error) {
        content.innerHTML = `<div style="color:var(--error);">Failed to analyze draft.</div>`;
        return;
    }

    const scoreColor = result.score >= 8 ? 'var(--success)' : result.score >= 6 ? 'var(--accent)' : result.score >= 4 ? 'var(--warning)' : 'var(--error)';
    const ratingLabel = {excellent: 'Excellent', good: 'Good', needs_work: 'Needs Work', poor: 'Poor'}[result.quality_rating] || result.quality_rating;

    let html = `
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;padding:16px;background:var(--bg-elevated);border-radius:var(--radius-md);">
            <div style="text-align:center;">
                <div style="font-size:32px;font-weight:bold;color:${scoreColor}">${result.score}</div>
                <div style="font-size:11px;color:var(--text-muted);">/ ${result.max_score}</div>
            </div>
            <div>
                <div style="font-size:16px;font-weight:600;color:${scoreColor}">${ratingLabel}</div>
                <div style="font-size:12px;color:var(--text-secondary);">Touch ${result.touch_number} - ${result.word_count} words${result.research_available ? '' : ' - No research linked'}</div>
            </div>
        </div>`;

    if (result.suggestions.length === 0) {
        html += `<div style="padding:16px;background:var(--success-bg);border:1px solid var(--success);border-radius:var(--radius-md);color:var(--success);font-size:13px;">All quality checks passed. This draft is ready to send.</div>`;
    } else {
        html += `<div style="font-size:13px;font-weight:600;margin-bottom:12px;">Suggestions (${result.suggestions.length})</div>`;
        result.suggestions.forEach(s => {
            const sevColor = s.severity === 'high' ? 'var(--error)' : s.severity === 'medium' ? 'var(--warning)' : 'var(--text-secondary)';
            const sevBg = s.severity === 'high' ? 'var(--error-bg)' : s.severity === 'medium' ? 'var(--warning-bg)' : 'var(--bg-elevated)';
            html += `<div style="margin-bottom:10px;padding:12px;background:${sevBg};border-radius:var(--radius-sm);border-left:3px solid ${sevColor};">
                <div style="font-size:11px;font-weight:bold;color:${sevColor};text-transform:uppercase;margin-bottom:4px;">${s.severity} - ${s.type.replace(/_/g, ' ')}</div>
                <div style="font-size:12px;color:var(--text-primary);">${esc(s.message)}</div>
                ${s.example ? `<div style="margin-top:6px;font-size:11px;color:var(--text-secondary);font-style:italic;">"${esc(s.example)}"</div>` : ''}
            </div>`;
        });
    }

    content.innerHTML = html;
}

// =====================================================
// QUOTA TRACKER
// =====================================================
async function loadQuota() {
    try {
        const data = await api('/api/quota');
        const listEl = document.getElementById('quota-container');
        if (!listEl) return;

        const remaining = (data.total_credits || 100) - (data.used_credits || 0);
        const todaySends = data.sends_today || 0;
        const weeklySends = data.sends_this_week || 0;
        const monthlySends = data.sends_this_month || 0;

        let html = `
            <div class="kpi-row">
                <div class="kpi">
                    <div class="kpi-label">InMail Credits</div>
                    <div class="kpi-val">${remaining}</div>
                    <div class="kpi-sub" style="color:var(--text-muted)">of ${data.total_credits || 100}</div>
                </div>
                <div class="kpi">
                    <div class="kpi-label">Sent Today</div>
                    <div class="kpi-val">${todaySends}</div>
                </div>
                <div class="kpi">
                    <div class="kpi-label">Sent This Week</div>
                    <div class="kpi-val">${weeklySends}</div>
                </div>
                <div class="kpi">
                    <div class="kpi-label">Sent This Month</div>
                    <div class="kpi-val">${monthlySends}</div>
                </div>
            </div>
            <div class="card">
                <h3>Quota Settings</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px">
                    <div>
                        <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px">Total InMail Credits</label>
                        <input type="number" id="quota-total" value="${data.total_credits || 100}" class="inp" style="width:100%">
                    </div>
                    <div>
                        <label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:6px">Daily Send Target</label>
                        <input type="number" id="quota-daily" value="${data.daily_target || 5}" class="inp" style="width:100%">
                    </div>
                </div>
                <button class="btn" onclick="saveQuotaSettings()">Save Settings</button>
            </div>
        `;

        listEl.innerHTML = html;
    } catch(e) {
        console.error('loadQuota error:', e);
        const listEl = document.getElementById('quota-container');
        if (listEl) listEl.innerHTML = `<div style="color:#ef4444;padding:20px">Error loading quota: ${e.message}</div>`;
    }
}

async function saveQuotaSettings() {
    const totalEl = document.getElementById('quota-total');
    const dailyEl = document.getElementById('quota-daily');
    if (!totalEl || !dailyEl) return;

    try {
        const result = await apiPost('/api/quota', {
            total_credits: parseInt(totalEl.value) || 100,
            daily_target: parseInt(dailyEl.value) || 5
        });

        const toast = document.createElement('div');
        toast.textContent = 'Quota settings saved!';
        toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:#fff;padding:8px 16px;border-radius:6px;z-index:9999;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);

        loadQuota();
        updateQuotaWidget();
    } catch(e) {
        console.error('saveQuotaSettings error:', e);
        alert('Error saving quota settings: ' + e.message);
    }
}

async function updateQuotaWidget() {
    try {
        const data = await api('/api/quota');
        const remaining = (data.total_credits || 100) - (data.used_credits || 0);
        const remainingEl = document.getElementById('quota-remaining');
        const infoEl = document.getElementById('quota-info');
        const widget = document.getElementById('quota-widget');

        if (remainingEl) remainingEl.textContent = remaining;
        if (infoEl) infoEl.textContent = `of ${data.total_credits || 100} | Today: ${data.sends_today || 0}`;

        if (widget && remaining <= 10) {
            widget.style.borderLeft = '3px solid var(--error)';
        } else if (widget && remaining <= 25) {
            widget.style.borderLeft = '3px solid var(--warning)';
        }
    } catch(e) {
        console.error('updateQuotaWidget error:', e);
    }
}

// =====================================================
// RUNBUNDLE IMPORT PAGE
// =====================================================
let pendingRunBundle = null;

function handleRunBundleFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            pendingRunBundle = JSON.parse(e.target.result);
            showRunBundlePreview(pendingRunBundle, file.name);
        } catch(err) {
            alert('Invalid JSON file: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function handleRunBundlePaste() {
    const text = document.getElementById('rb-paste-input').value;
    if (!text.trim()) return;
    try {
        pendingRunBundle = JSON.parse(text);
        showRunBundlePreview(pendingRunBundle, 'pasted');
    } catch(err) {
        alert('Invalid JSON: ' + err.message);
    }
}

function showRunBundlePreview(bundle, source) {
    const previewEl = document.getElementById('rb-preview');
    const statsEl = document.getElementById('rb-preview-stats');
    const tableEl = document.getElementById('rb-preview-table');
    previewEl.style.display = 'block';

    const prospects = bundle.prospects || [];
    const active = prospects.filter(p => !p.status || !p.status.includes('Removed'));
    const qa = active.filter(p => (p.persona || '').toLowerCase().includes('qa')).length;
    const eng = active.length - qa;
    const withLinkedin = active.filter(p => p.linkedin && p.linkedin.includes('linkedin.com')).length;

    // Check for drafts (embedded in prospects)
    let draftCount = 0;
    for (const p of active) {
        if (p.touch_1_body) draftCount++;
        if (p.touch_3) draftCount++;
        if (p.touch_6) draftCount++;
        if (p.call_snippet_1) draftCount++;
        if (p.call_snippet_2) draftCount++;
    }

    statsEl.innerHTML = `
        <div class="kpi"><div class="kpi-label">Prospects</div><div class="kpi-val">${active.length}</div></div>
        <div class="kpi"><div class="kpi-label">QA Leaders</div><div class="kpi-val">${qa}</div></div>
        <div class="kpi"><div class="kpi-label">VP Eng</div><div class="kpi-val">${eng}</div></div>
        <div class="kpi"><div class="kpi-label">LinkedIn URLs</div><div class="kpi-val">${withLinkedin}</div></div>
        <div class="kpi"><div class="kpi-label">Drafts</div><div class="kpi-val">${draftCount}</div></div>
    `;

    tableEl.innerHTML = `<table class="tbl"><thead><tr><th>Pri</th><th>Name</th><th>Title</th><th>Company</th><th>LinkedIn</th></tr></thead><tbody>
        ${active.slice(0, 20).map(p => `<tr>
            <td>${p.priority_score || '-'}</td>
            <td>${esc(p.name || '')}</td>
            <td style="font-size:12px">${esc(p.title || '')}</td>
            <td>${esc(p.company || '')}</td>
            <td>${p.linkedin && p.linkedin.includes('linkedin.com') ? 'Yes' : '<span style="color:#f59e0b">No</span>'}</td>
        </tr>`).join('')}
        ${active.length > 20 ? `<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">...and ${active.length - 20} more</td></tr>` : ''}
    </tbody></table>`;
}

async function executeRunBundleImport() {
    if (!pendingRunBundle) return;
    const btn = document.getElementById('rb-import-btn');
    const resultEl = document.getElementById('rb-import-result');
    btn.disabled = true;
    btn.textContent = 'Importing...';
    resultEl.style.display = 'block';
    resultEl.innerHTML = '<div style="color:var(--text-secondary)">Importing prospects and drafts...</div>';

    try {
        // Transform the data to RunBundle format
        const bundle = {
            run: pendingRunBundle.run || {
                batch_number: pendingRunBundle.batch_number || 1,
                batch_date: pendingRunBundle.batch_date || new Date().toISOString().slice(0,10),
                source: 'runbundle_import',
                ab_variable: 'pain_hook',
                quality_report: pendingRunBundle.quality_report || {}
            },
            prospects: pendingRunBundle.prospects || []
        };

        const resp = await fetch('/api/import/run-bundle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(bundle)
        });
        const data = await resp.json();

        if (!resp.ok) {
            resultEl.innerHTML = `<div style="color:#ef4444;padding:12px;background:var(--bg-primary);border-radius:6px">
                <strong>Import failed:</strong> ${JSON.stringify(data.detail || data.error || data)}
            </div>`;
            return;
        }

        resultEl.innerHTML = `<div style="padding:12px;background:var(--bg-primary);border-radius:6px">
            <div style="color:#10b981;font-weight:bold;margin-bottom:8px">Import Successful</div>
            <div>Contacts imported: <strong>${data.imported_contacts}</strong></div>
            <div>Drafts imported: <strong>${data.imported_drafts}</strong></div>
            <div>Deduped: <strong>${data.deduped}</strong></div>
            <div>Skipped: <strong>${data.skipped}</strong></div>
            <div style="margin-top:12px">
                <button class="btn btn-primary" onclick="showPage('prospects')">View Prospects</button>
                <button class="btn" onclick="showPage('drafts')" style="margin-left:8px">View Drafts</button>
            </div>
        </div>`;
    } catch(e) {
        resultEl.innerHTML = `<div style="color:#ef4444">Error: ${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Import into Dashboard';
    }
}

function filterProspects() {}

// =====================================================
// RESEARCH RUNS PAGE
// =====================================================
let wizardRows = [];
let currentRunId = null;

async function loadRunsPage() {
    try {
        const data = await api('/api/research-runs');
        const runs = data.runs || [];

        const kpis = document.getElementById('runs-kpis');
        const total = runs.length;
        const complete = runs.filter(r => r.status === 'complete').length;
        const running = runs.filter(r => r.status === 'running').length;
        const totalProspects = runs.reduce((s, r) => s + (r.prospect_count || 0), 0);
        kpis.innerHTML = `
            <div class="kpi"><div class="kpi-label">Total Runs</div><div class="kpi-val">${total}</div></div>
            <div class="kpi"><div class="kpi-label">Completed</div><div class="kpi-val">${complete}</div></div>
            <div class="kpi"><div class="kpi-label">Running</div><div class="kpi-val">${running}</div></div>
            <div class="kpi"><div class="kpi-label">Prospects Imported</div><div class="kpi-val">${totalProspects}</div></div>
        `;

        const tbody = document.getElementById('runs-history-body');
        const emptyEl = document.getElementById('runs-empty');
        if (runs.length === 0) {
            emptyEl.style.display = 'block';
            tbody.parentElement.parentElement.style.display = 'none';
        } else {
            emptyEl.style.display = 'none';
            tbody.parentElement.parentElement.style.display = '';
            tbody.innerHTML = runs.map(r => `<tr>
                <td><strong>${r.name || r.id}</strong></td>
                <td>${r.created_at || ''}</td>
                <td>${r.prospect_count || 0}</td>
                <td><span class="tag ${r.status === 'complete' ? 'tag-warm' : r.status === 'running' ? 'tag-hot' : ''}">${r.status}</span></td>
                <td>${r.draft_count || '-'}</td>
                <td>
                    <div style="background:var(--bg-elevated);border-radius:4px;height:6px;width:80px;overflow:hidden">
                        <div style="background:var(--accent);height:100%;width:${r.progress_pct || 0}%"></div>
                    </div>
                </td>
                <td><a onclick="viewRunDetail('${r.id}')">View</a></td>
            </tr>`).join('');
        }
    } catch(e) { console.error('loadRunsPage:', e); }
}

function showRunWizard() {
    document.getElementById('run-wizard').style.display = 'block';
    document.getElementById('runs-history-card').style.display = 'none';
    wizGoToUpload();
}

function hideRunWizard() {
    document.getElementById('run-wizard').style.display = 'none';
    document.getElementById('runs-history-card').style.display = 'block';
    loadRunsPage();
}

function wizGoToUpload() {
    ['upload','validate','config','execute'].forEach(s => {
        document.getElementById('wiz-' + s).style.display = 'none';
        document.getElementById('wiz-step-' + s).classList.remove('active','done');
    });
    document.getElementById('wiz-upload').style.display = 'block';
    document.getElementById('wiz-step-upload').classList.add('active');
}

function wizGoToValidate() {
    ['upload','validate','config','execute'].forEach(s => document.getElementById('wiz-' + s).style.display = 'none');
    document.getElementById('wiz-validate').style.display = 'block';
    document.getElementById('wiz-step-upload').classList.remove('active');
    document.getElementById('wiz-step-upload').classList.add('done');
    document.getElementById('wiz-step-validate').classList.add('active');
    runValidation();
}

function wizGoToConfig() {
    ['upload','validate','config','execute'].forEach(s => document.getElementById('wiz-' + s).style.display = 'none');
    document.getElementById('wiz-config').style.display = 'block';
    document.getElementById('wiz-step-validate').classList.remove('active');
    document.getElementById('wiz-step-validate').classList.add('done');
    document.getElementById('wiz-step-config').classList.add('active');
}

function showWizUploadTab(tab) {
    document.querySelectorAll('#wiz-upload .tab-item').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('wiz-upload-csv').style.display = tab === 'csv' ? 'block' : 'none';
    document.getElementById('wiz-upload-paste').style.display = tab === 'paste' ? 'block' : 'none';
}

function handleCSVUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n').filter(l => l.trim());
        if (lines.length < 2) { showToast('CSV must have a header row and at least one data row', 'error'); return; }

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
        wizardRows = [];
        for (let i = 1; i < lines.length; i++) {
            const vals = lines[i].split(',').map(v => v.trim().replace(/['"]/g, ''));
            const row = {};
            headers.forEach((h, j) => { row[h] = vals[j] || ''; });
            if (!row.name && row.first_name) row.name = row.first_name + ' ' + (row.last_name || '');
            if (!row.company && row.company_name) row.company = row.company_name;
            if (!row.linkedin_url && row.linkedin) row.linkedin_url = row.linkedin;
            wizardRows.push(row);
        }

        showCSVPreview();
    };
    reader.readAsText(file);
}

function handlePasteUpload() {
    const text = document.getElementById('paste-data-input').value.trim();
    if (!text) { showToast('Please paste some data first', 'error'); return; }

    const lines = text.split('\n').filter(l => l.trim());
    wizardRows = [];
    for (const line of lines) {
        const parts = line.split(',').map(p => p.trim());
        if (parts.length >= 3) {
            wizardRows.push({
                name: parts[0],
                title: parts[1],
                company: parts[2],
                linkedin_url: parts[3] || ''
            });
        }
    }

    if (wizardRows.length === 0) { showToast('Could not parse any rows. Use format: Name, Title, Company, LinkedIn URL', 'error'); return; }
    showCSVPreview();
}

function showCSVPreview() {
    document.getElementById('csv-row-count').textContent = wizardRows.length;
    const table = document.getElementById('csv-preview-table');
    const cols = ['name', 'title', 'company', 'email', 'linkedin_url'];
    table.innerHTML = '<thead><tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead><tbody>' +
        wizardRows.slice(0, 10).map(r => '<tr>' + cols.map(c => `<td>${r[c] || ''}</td>`).join('') + '</tr>').join('') +
        (wizardRows.length > 10 ? `<tr><td colspan="${cols.length}" style="text-align:center;color:var(--text-muted)">... and ${wizardRows.length - 10} more rows</td></tr>` : '') +
        '</tbody>';
    document.getElementById('csv-preview').style.display = 'block';
}

async function runValidation() {
    try {
        const createResp = await apiPost('/api/research-runs', { rows: wizardRows, import_type: 'csv' });
        currentRunId = createResp.run_id;

        const valResp = await apiPost(`/api/research-runs/${currentRunId}/validate`, {});

        const summary = document.getElementById('validation-summary');
        const passRate = valResp.valid_count / valResp.total_rows * 100;
        summary.innerHTML = `
            <div style="display:flex;gap:16px">
                <div class="kpi" style="flex:1"><div class="kpi-label">Total Rows</div><div class="kpi-val">${valResp.total_rows}</div></div>
                <div class="kpi" style="flex:1"><div class="kpi-label">Valid</div><div class="kpi-val" style="color:var(--success)">${valResp.valid_count}</div></div>
                <div class="kpi" style="flex:1"><div class="kpi-label">Errors</div><div class="kpi-val" style="color:${valResp.error_count > 0 ? 'var(--error)' : 'var(--success)'}">${valResp.error_count}</div></div>
                <div class="kpi" style="flex:1"><div class="kpi-label">Pass Rate</div><div class="kpi-val">${passRate.toFixed(0)}%</div></div>
            </div>
        `;

        if (valResp.errors && valResp.errors.length > 0) {
            const table = document.getElementById('validation-table');
            table.innerHTML = '<thead><tr><th>Row</th><th>Name</th><th>Company</th><th>Errors</th></tr></thead><tbody>' +
                valResp.errors.map(e => `<tr style="color:var(--error)">
                    <td>${e.row}</td>
                    <td>${e.data?.name || e.data?.first_name || '-'}</td>
                    <td>${e.data?.company || '-'}</td>
                    <td>${e.errors.join(', ')}</td>
                </tr>`).join('') + '</tbody>';
        }

        document.getElementById('btn-go-config').disabled = valResp.valid_count === 0;
    } catch(e) {
        document.getElementById('validation-summary').innerHTML = `<p style="color:var(--error)">Validation failed: ${e.message}</p>`;
    }
}

async function wizExecute() {
    ['upload','validate','config','execute'].forEach(s => document.getElementById('wiz-' + s).style.display = 'none');
    document.getElementById('wiz-execute').style.display = 'block';
    document.getElementById('wiz-step-config').classList.remove('active');
    document.getElementById('wiz-step-config').classList.add('done');
    document.getElementById('wiz-step-execute').classList.add('active');

    const name = document.getElementById('run-name-input').value || undefined;
    const abVar = document.getElementById('ab-variable-select').value;

    const checklist = document.getElementById('sop-checklist');
    const steps = ['validate', 'accounts', 'contacts', 'score', 'ab_assign', 'drafts', 'quality_gate', 'complete'];
    const labels = ['Validate CSV data', 'Create/match accounts', 'Create contacts', 'Score & prioritize', 'A/B group assignment', 'Generate message drafts', 'Quality gate checks', 'Finalize run'];
    checklist.innerHTML = steps.map((s, i) => `
        <div class="phase-step" id="sop-${s}" style="display:flex;align-items:center;gap:8px;padding:6px 0">
            <span id="sop-icon-${s}" style="font-size:16px">‚è≥</span>
            <span>${labels[i]}</span>
        </div>
    `).join('');

    try {
        const resp = await apiPost(`/api/research-runs/${currentRunId}/execute`, {});

        document.getElementById('exec-progress-pct').textContent = '100%';
        document.getElementById('exec-progress-bar').style.width = '100%';

        if (resp.checklist) {
            resp.checklist.forEach(s => {
                const icon = document.getElementById('sop-icon-' + s.step);
                if (icon) icon.textContent = s.status === 'passed' ? '‚úÖ' : s.status === 'failed' ? '‚ùå' : '‚è≥';
            });
        }

        document.getElementById('exec-result').style.display = 'block';
        document.getElementById('exec-result').innerHTML = `
            <div style="background:var(--success-bg);border:1px solid var(--success);border-radius:var(--radius-md);padding:16px">
                <h4 style="color:var(--success);margin-bottom:8px">‚úÖ Research Run Complete</h4>
                <p>Created ${resp.contacts_created || 0} contacts with ${resp.drafts_generated || 0} message drafts.</p>
                ${resp.qc_issues > 0 ? `<p style="color:var(--warning);margin-top:4px">‚ö†Ô∏è ${resp.qc_issues} quality gate issues found.</p>` : ''}
            </div>
        `;

        document.getElementById('btn-cancel-run').style.display = 'none';
        document.getElementById('btn-view-drafts').style.display = 'inline-flex';
        document.getElementById('wiz-step-execute').classList.remove('active');
        document.getElementById('wiz-step-execute').classList.add('done');

    } catch(e) {
        document.getElementById('exec-result').style.display = 'block';
        document.getElementById('exec-result').innerHTML = `
            <div style="background:var(--error-bg);border:1px solid var(--error);border-radius:var(--radius-md);padding:16px">
                <h4 style="color:var(--error)">‚ùå Pipeline Failed</h4>
                <p>${e.message || 'Unknown error'}</p>
            </div>
        `;
    }
}

async function cancelRun() {
    if (!currentRunId) return;
    try {
        await apiPost(`/api/research-runs/${currentRunId}/cancel`, {});
        showToast('Run cancelled', 'warning');
        hideRunWizard();
    } catch(e) { showToast('Cancel failed: ' + e.message, 'error'); }
}

async function viewRunDetail(runId) {
    try {
        const data = await api(`/api/research-runs/${runId}`);
        const checklist = data.sop_checklist || [];
        const logs = data.logs || [];
        alert(`Run: ${data.name}\nStatus: ${data.status}\nProspects: ${data.prospect_count}\nContacts: ${(data.contacts || []).length}\nDrafts: ${(data.drafts || []).length}\n\nLogs:\n${logs.map(l => l.msg).join('\n')}`);
    } catch(e) { showToast('Failed to load run: ' + e.message, 'error'); }
}

// =====================================================
// ANALYTICS PAGE
// =====================================================
function showAnalyticsTab(tab) {
    document.querySelectorAll('#page-analytics .tab-item').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-analytics .tab-content').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('analytics-tab-' + tab).classList.add('active');
}

async function loadAnalyticsPage() {
    try {
        const [stats, intelligence, experiments, signals] = await Promise.all([
            api('/api/stats'),
            api('/api/analytics/intelligence').catch(() => ({})),
            api('/api/experiments').catch(() => ({experiments: []})),
            api('/api/signals').catch(() => ({signals: []}))
        ]);

        const kpis = document.getElementById('analytics-kpis');
        kpis.innerHTML = `
            <div class="kpi"><div class="kpi-label">Reply Rate</div><div class="kpi-val">${(stats.reply_rate || 0).toFixed(1)}%</div></div>
            <div class="kpi"><div class="kpi-label">Meeting Rate</div><div class="kpi-val">${(stats.meeting_rate || 0).toFixed(1)}%</div></div>
            <div class="kpi"><div class="kpi-label">Total Sent</div><div class="kpi-val">${stats.total_sent || 0}</div></div>
            <div class="kpi"><div class="kpi-label">Signals Active</div><div class="kpi-val">${(signals.signals || []).length}</div></div>
        `;

        const breakdown = intelligence.breakdowns || intelligence;
        document.getElementById('analytics-breakdown').innerHTML = breakdown && typeof breakdown === 'object' ?
            '<pre style="color:var(--text-secondary);font-size:11px;white-space:pre-wrap">' + JSON.stringify(breakdown, null, 2) + '</pre>' :
            '<p style="color:var(--text-muted)">No performance data yet. Complete a research run to see analytics.</p>';

        const exps = experiments.experiments || [];
        document.getElementById('analytics-experiments').innerHTML = exps.length > 0 ?
            exps.map(e => `<div class="card" style="margin-bottom:8px;padding:12px">
                <strong>${e.name || e.variable}</strong>
                <span class="tag" style="margin-left:8px">${e.status || 'active'}</span>
                <p style="color:var(--text-secondary);margin-top:4px">${e.description || ''}</p>
            </div>`).join('') :
            '<p style="color:var(--text-muted)">No A/B tests yet. Start a research run with an A/B variable to begin testing.</p>';

        const sigs = signals.signals || [];
        document.getElementById('analytics-signals').innerHTML = sigs.length > 0 ?
            sigs.map(s => `<div style="padding:8px 0;border-bottom:1px solid var(--border-subtle)">
                <span class="tag ${s.signal_type === 'buyer_intent' ? 'tag-hot' : ''}">${s.signal_type}</span>
                <span style="margin-left:8px">${s.description || ''}</span>
                <span style="color:var(--text-muted);margin-left:8px;font-size:11px">${s.detected_at || ''}</span>
            </div>`).join('') :
            '<p style="color:var(--text-muted)">No signals detected yet.</p>';
    } catch(e) { console.error('loadAnalyticsPage:', e); }
}

// =====================================================
// SYSTEM PAGE
// =====================================================
function showSystemTab(tab) {
    document.querySelectorAll('#page-system .tab-item').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#page-system .tab-content').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('system-tab-' + tab).classList.add('active');
}

async function loadSystemPage() {
    try {
        const [health, agents, dryrun] = await Promise.all([
            api('/api/health').catch(() => ({status: 'ok'})),
            api('/api/analytics/agent-logs?limit=20').catch(() => ({runs: []})),
            api('/api/system/dry-run').catch(() => ({dry_run: true}))
        ]);

        const kpis = document.getElementById('system-health-kpis');
        kpis.innerHTML = `
            <div class="kpi"><div class="kpi-label">API Status</div><div class="kpi-val" style="color:var(--success)">Online</div></div>
            <div class="kpi"><div class="kpi-label">DRY RUN</div><div class="kpi-val" style="color:var(--warning)">${dryrun.dry_run ? 'ON' : 'OFF'}</div></div>
        `;

        const agentRuns = agents.runs || agents.agent_runs || [];
        document.getElementById('system-agents-body').innerHTML = agentRuns.map(a => `<tr>
            <td>${a.agent_type || a.type || ''}</td>
            <td>${a.run_type || ''}</td>
            <td><span class="tag">${a.status || ''}</span></td>
            <td>${a.duration_ms ? (a.duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
            <td style="font-size:11px">${a.created_at || ''}</td>
        </tr>`).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">No agent runs yet</td></tr>';

        try {
            const linkedin = await api('/api/linkedin/stats');
            document.getElementById('system-linkedin-content').innerHTML = `
                <div class="kpi-row">
                    <div class="kpi"><div class="kpi-label">Profiles</div><div class="kpi-val">${linkedin.profiles || 0}</div></div>
                    <div class="kpi"><div class="kpi-label">Drafts</div><div class="kpi-val">${linkedin.drafts || 0}</div></div>
                    <div class="kpi"><div class="kpi-label">DRY RUN</div><div class="kpi-val" style="color:var(--warning)">${linkedin.dry_run ? 'ON' : 'OFF'}</div></div>
                </div>
            `;
        } catch(e) {}

        try {
            const email = await api('/api/email/stats');
            document.getElementById('system-email-content').innerHTML = `
                <div class="kpi-row">
                    <div class="kpi"><div class="kpi-label">Identities</div><div class="kpi-val">${email.identities || 0}</div></div>
                    <div class="kpi"><div class="kpi-label">Suppressed</div><div class="kpi-val">${email.suppressed || 0}</div></div>
                </div>
            `;
        } catch(e) {
            document.getElementById('system-email-content').innerHTML = '<p style="color:var(--text-muted)">Email stats unavailable</p>';
        }
    } catch(e) { console.error('loadSystemPage:', e); }
}

// =====================================================
// DATA PAGE (Admin)
// =====================================================
async function loadDataPage() {
    try {
        const summary = await api('/api/admin/data-summary');

        const kpis = document.getElementById('data-kpis');
        let totalSeed = 0, totalImport = 0, totalManual = 0, totalAll = 0;
        Object.values(summary).forEach(t => {
            totalSeed += (t.seed || 0);
            totalImport += (t.csv_import || 0) + (t.paste_import || 0);
            totalManual += (t.manual || 0);
            totalAll += (t._total || 0);
        });
        kpis.innerHTML = `
            <div class="kpi"><div class="kpi-label">Total Records</div><div class="kpi-val">${totalAll}</div></div>
            <div class="kpi"><div class="kpi-label">Seed Data</div><div class="kpi-val" style="color:var(--warning)">${totalSeed}</div></div>
            <div class="kpi"><div class="kpi-label">Imported</div><div class="kpi-val" style="color:var(--success)">${totalImport}</div></div>
            <div class="kpi"><div class="kpi-label">Manual</div><div class="kpi-val" style="color:var(--info)">${totalManual}</div></div>
        `;

        const lineage = document.getElementById('data-lineage');
        // Create a table showing record counts by source
        let tableHtml = `<table style="width:100%;border-collapse:collapse;font-size:13px">
            <thead style="border-bottom:2px solid var(--border)">
                <tr>
                    <th style="text-align:left;padding:8px;color:var(--text-secondary);font-weight:600">Table</th>
                    <th style="text-align:right;padding:8px;color:var(--text-secondary);font-weight:600">Seed</th>
                    <th style="text-align:right;padding:8px;color:var(--text-secondary);font-weight:600">Imported</th>
                    <th style="text-align:right;padding:8px;color:var(--text-secondary);font-weight:600">Manual</th>
                    <th style="text-align:right;padding:8px;color:var(--text-secondary);font-weight:600">Total</th>
                </tr>
            </thead>
            <tbody>`;

        Object.entries(summary).forEach(([table, counts]) => {
            const imported = (counts.csv_import || 0) + (counts.paste_import || 0);
            const manual = counts.manual || 0;
            tableHtml += `
                <tr style="border-bottom:1px solid var(--border-subtle)">
                    <td style="padding:8px;color:var(--text-primary)">${table}</td>
                    <td style="text-align:right;padding:8px;color:var(--warning)">${counts.seed || 0}</td>
                    <td style="text-align:right;padding:8px;color:var(--success)">${imported}</td>
                    <td style="text-align:right;padding:8px;color:var(--info)">${manual}</td>
                    <td style="text-align:right;padding:8px;color:var(--text-primary);font-weight:600">${counts._total || 0}</td>
                </tr>`;
        });

        tableHtml += `</tbody></table>`;
        lineage.innerHTML = tableHtml;
    } catch(e) { console.error('loadDataPage:', e); }
}

async function exportAllData() {
    try {
        const data = await api('/api/admin/export-all');
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `occ-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Backup exported successfully', 'success');
    } catch(e) { showToast('Export failed: ' + e.message, 'error'); }
}

async function handleImportBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const data = JSON.parse(e.target.result);
            const resp = await apiPost('/api/admin/import-backup', data);
            showToast('Backup imported: ' + JSON.stringify(resp.tables), 'success');
            loadDataPage();
        } catch(err) { showToast('Import failed: ' + err.message, 'error'); }
    };
    reader.readAsText(file);
}

async function showCleanupPreview() {
    try {
        const preview = await apiPost('/api/admin/cleanup/preview', {});
        const content = document.getElementById('cleanup-preview-content');
        content.innerHTML = `
            <p style="margin-bottom:12px">This will delete <strong>${preview.total_records}</strong> seed/demo records:</p>
            ${Object.entries(preview.tables).map(([t, c]) => c > 0 ? `<div style="padding:4px 0">${t}: <strong>${c}</strong> records</div>` : '').join('')}
            <p style="margin-top:12px;color:var(--warning)">This action is safe. Seed data will regenerate on next server restart unless SKIP_SEED=true is set.</p>
        `;
        document.getElementById('cleanup-preview').style.display = 'block';
    } catch(e) { showToast('Preview failed: ' + e.message, 'error'); }
}

async function executeCleanup() {
    try {
        const resp = await apiPost('/api/admin/cleanup/execute', {confirm: true});
        showToast(`Cleaned ${resp.total} records`, 'success');
        document.getElementById('cleanup-preview').style.display = 'none';
        document.getElementById('cleanup-success-message').style.display = 'block';
        await new Promise(r => setTimeout(r, 500));
        loadDataPage();
        setTimeout(() => {
            document.getElementById('cleanup-success-message').style.display = 'none';
        }, 3000);
    } catch(e) { showToast('Cleanup failed: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ‚îÄ FLOW FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function switchChannelTab(channel, tabName) {
    // Update tab button states
    const tabContainer = document.getElementById(`${channel}-tabs`);
    if (tabContainer) {
        tabContainer.querySelectorAll('.channel-tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }
    // Channel-specific tab handling
    if (channel === 'linkedin') {
        if (tabName === 'drafts') {
            // Show drafts filtered to LinkedIn within the LinkedIn page
            showPage('drafts');
        } else if (tabName === 'analytics') {
            showPage('analytics');
        }
        // 'prospects' tab stays on linkedin page (default)
    } else if (channel === 'email') {
        if (tabName === 'drafts') {
            showPage('drafts');
        } else if (tabName === 'analytics') {
            showPage('analytics');
        }
    } else if (channel === 'accounts') {
        if (tabName === 'research') {
            showPage('runs');
        }
    }
}

function showFlowStep(flowPrefix, stepNum) {
    // Hide all content divs for this flow
    for (let i = 1; i <= 4; i++) {
        const content = document.getElementById(`flow-${flowPrefix}-content-${i}`);
        if (content) content.style.display = i === stepNum ? 'block' : 'none';
        const step = document.getElementById(`flow-${flowPrefix}-step-${i}`);
        if (step) {
            step.classList.remove('active');
            if (i < stepNum) step.classList.add('completed');
            if (i === stepNum) step.classList.add('active');
        }
    }
}

function loadFlowAccountResearchPage() {
    // Reset to step 1
    showFlowStep('ar', 1);
}

async function loadFlowAccounts() {
    const container = document.getElementById('flow-ar-accounts-list');
    if (!container) return;
    container.innerHTML = '<div style="color:var(--text-muted);font-size:12px">Loading accounts...</div>';
    try {
        const data = await api('/api/accounts');
        const accounts = data.accounts || [];
        const vertical = document.getElementById('flow-ar-filter-vertical')?.value || '';
        const filtered = vertical ? accounts.filter(a => (a.vertical || '').toLowerCase().includes(vertical.toLowerCase())) : accounts;
        if (!filtered.length) {
            container.innerHTML = '<div style="color:var(--text-muted);font-size:12px">No accounts found matching filter.</div>';
            return;
        }
        container.innerHTML = `<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted)">${filtered.length} accounts found. Select accounts to research:</div>
            <div style="max-height:400px;overflow-y:auto">
            ${filtered.map(a => `<label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;cursor:pointer;font-size:12px">
                <input type="checkbox" class="flow-ar-checkbox" value="${a.id}">
                <strong>${esc(a.name || 'Unknown')}</strong>
                <span style="color:var(--text-secondary)">${esc(a.vertical || '')}</span>
                <span style="color:var(--text-muted);margin-left:auto">${a.contact_count || 0} contacts</span>
            </label>`).join('')}
            </div>
            <button class="btn btn-primary" onclick="flowArNextStep()" style="margin-top:12px">Next: Generate Research</button>`;
    } catch(e) {
        container.innerHTML = `<div style="color:var(--error);font-size:12px">Error loading accounts: ${e.message}</div>`;
    }
}

function flowArNextStep() {
    const checked = document.querySelectorAll('.flow-ar-checkbox:checked');
    if (!checked.length) { showToast('Select at least one account', 'warning'); return; }
    const summary = document.getElementById('flow-ar-selected-summary');
    if (summary) summary.innerHTML = `<div style="font-size:12px;color:var(--text-secondary)">${checked.length} account(s) selected for research generation.</div>`;
    showFlowStep('ar', 2);
}

async function runFlowAccountResearch() {
    const progress = document.getElementById('flow-ar-progress');
    if (progress) progress.innerHTML = '<div style="color:var(--accent);font-size:12px">Research generation initiated. This would trigger batch research via the API...</div>';
    showToast('Account research flow completed (placeholder)', 'success');
    setTimeout(() => showFlowStep('ar', 3), 1000);
}

function exportFlowAccountResults() {
    showToast('Export feature coming soon', 'info');
}

function loadFlowLinkedInDraftPage() {
    showFlowStep('li', 1);
}

async function loadFlowLinkedInProspects() {
    const container = document.getElementById('flow-li-prospects-list');
    if (!container) return;
    container.innerHTML = '<div style="color:var(--text-muted);font-size:12px">Loading prospects...</div>';
    try {
        const data = await api('/api/prospects/full');
        const prospects = data.prospects || [];
        const priority = document.getElementById('flow-li-filter-priority')?.value || '';
        const filtered = prospects.filter(p => {
            if (priority && (p.priority_score || 0) != parseInt(priority)) return false;
            return p.linkedin_url && p.linkedin_url.includes('linkedin.com');
        });
        if (!filtered.length) {
            container.innerHTML = '<div style="color:var(--text-muted);font-size:12px">No LinkedIn prospects found matching filter.</div>';
            return;
        }
        container.innerHTML = `<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted)">${filtered.length} LinkedIn prospects found:</div>
            <div style="max-height:400px;overflow-y:auto">
            ${filtered.map(p => `<label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;cursor:pointer;font-size:12px">
                <input type="checkbox" class="flow-li-checkbox" value="${p.id}">
                <strong>${esc((p.first_name||'')+' '+(p.last_name||''))}</strong>
                <span style="color:var(--text-secondary)">${esc(p.company_name || '')}</span>
                <span style="color:var(--text-muted);margin-left:auto">Priority: ${p.priority_score || 0}</span>
                <span style="color:var(--text-muted)">${(p.drafts||[]).length} drafts</span>
            </label>`).join('')}
            </div>
            <button class="btn btn-primary" onclick="flowLiNextStep(2)" style="margin-top:12px">Next: Verify Research</button>`;
    } catch(e) {
        container.innerHTML = `<div style="color:var(--error);font-size:12px">Error: ${e.message}</div>`;
    }
}

function flowLiNextStep(step) {
    const checked = document.querySelectorAll('.flow-li-checkbox:checked');
    if (step === 2 && !checked.length) { showToast('Select at least one prospect', 'warning'); return; }
    showFlowStep('li', step);
}

async function runFlowLinkedInDrafts() {
    const progress = document.getElementById('flow-li-progress');
    if (progress) progress.innerHTML = '<div style="color:var(--accent);font-size:12px">Draft generation initiated. This would create InMail + follow-up + break-up drafts...</div>';
    showToast('LinkedIn draft flow completed (placeholder)', 'success');
    setTimeout(() => showFlowStep('li', 4), 1000);
}

function loadFlowEmailDraftPage() {
    showFlowStep('em', 1);
}

async function loadFlowEmailProspects() {
    const container = document.getElementById('flow-em-prospects-list');
    if (!container) return;
    container.innerHTML = '<div style="color:var(--text-muted);font-size:12px">Loading prospects...</div>';
    try {
        const data = await api('/api/prospects/full');
        const prospects = data.prospects || [];
        const priority = document.getElementById('flow-em-filter-priority')?.value || '';
        const filtered = prospects.filter(p => {
            if (priority && (p.priority_score || 0) != parseInt(priority)) return false;
            return p.email && p.email.includes('@');
        });
        if (!filtered.length) {
            container.innerHTML = '<div style="color:var(--text-muted);font-size:12px">No email prospects found matching filter.</div>';
            return;
        }
        container.innerHTML = `<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted)">${filtered.length} email prospects found:</div>
            <div style="max-height:400px;overflow-y:auto">
            ${filtered.map(p => `<label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:4px;margin-bottom:4px;cursor:pointer;font-size:12px">
                <input type="checkbox" class="flow-em-checkbox" value="${p.id}">
                <strong>${esc((p.first_name||'')+' '+(p.last_name||''))}</strong>
                <span style="color:var(--text-secondary)">${esc(p.company_name || '')}</span>
                <span style="color:var(--text-muted);margin-left:auto">${esc(p.email || 'no email')}</span>
            </label>`).join('')}
            </div>
            <button class="btn btn-primary" onclick="flowEmNextStep(2)" style="margin-top:12px">Next: Verify Research</button>`;
    } catch(e) {
        container.innerHTML = `<div style="color:var(--error);font-size:12px">Error: ${e.message}</div>`;
    }
}

function flowEmNextStep(step) {
    const checked = document.querySelectorAll('.flow-em-checkbox:checked');
    if (step === 2 && !checked.length) { showToast('Select at least one prospect', 'warning'); return; }
    showFlowStep('em', step);
}

async function runFlowEmailDrafts() {
    const progress = document.getElementById('flow-em-progress');
    if (progress) progress.innerHTML = '<div style="color:var(--accent);font-size:12px">Email draft generation initiated...</div>';
    showToast('Email draft flow completed (placeholder)', 'success');
    setTimeout(() => showFlowStep('em', 4), 1000);
}

</script>

</body>
</html>
